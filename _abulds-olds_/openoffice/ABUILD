# ABUILD generated by mkpkg_generator.sh

pkgname=openoffice
pkgver=3.2.1
pkgbuild=3
arch=('auto')

PKG_LANG="ru"	# Leave this alone

# If you want to enable java support, set this
# variable to "NO",   Default is "YES"
DISABLE_JAVA=${DISABLE_JAVA:-YES}


# Change source package name
if [ "$ARCH" = "x86_64" ]; then
  SRCARCH="x86-64"
  PKGARCH="$ARCH"
  WJRE=yes #Overwrite WJRE option since the only x86_64 I see has jre
else
  SRCARCH="Intel"
  PKGARCH="i586"
fi

shortdesc=("OpenOffice.org (a full-featured open-source office suite)")
longdesc=("OpenOffice.org is a full-featured open-source office suite that is compatible with all other major office software. This is a repackaging of the official OpenOffice.org binary RPM's distributed by the upstream developers. Homepage: http://openoffice.org")

tags=('app-office xapps')

skip_gendeps=1

adddep="xorg-server"

source=("http://download.services.openoffice.org/files/localized/${PKG_LANG}/${pkgver}/OOo_${pkgver}_Linux_${SRCARCH}_install-rpm-wJRE_${PKG_LANG}.tar.gz")

build() {
	go_src_dir
	set -eu


	cd RPMS/
	mv desktop-integration/openoffice.org3.2-freedesktop-menus-3.2-9502.noarch.rpm .
	rm *onlineupdate*.rpm # We don't want this
	for FILE in *.rpm ; do rpm2cpio < $FILE | cpio -imdv ; done
	rm -rf desktop-integration *.rpm
	mv opt usr ${pkgdir}
	cd ${pkgdir}
	
	# Kill a broken symlink
	rm -f ${pkgdir}/usr/share/applications/openoffice.org3-startcenter.desktop
	
	# Create symlinks in /usr/bin to actual binaries
	cd ${pkgdir}/usr/bin
	for FILE in \
		sbase scalc sdraw simpress smath soffice spadmin swriter unopkg ; do 
		rm -f $FILE
		ln -sf ../../opt/openoffice.org3/program/$FILE $FILE ;
	done 
	cd -

	# Remove DejaVu and Liberation fonts - these are included in other packages
	rm -f opt/openoffice.org/basis3.2/share/fonts/truetype/[DL]*.ttf

	# Fix Exec commands in the desktop files
	# See http://bugzilla.xfce.org/show_bug.cgi?id=2430 
	cd ${pkgdir}/opt/openoffice.org3/share/xdg/
	for APP in base calc draw impress math writer; do
		sed -i 's%Exec=openoffice.org3 -%Exec=s%' $APP.desktop ;
	done
	cd -

	# Install extensions
	UNOPKG_BIN=${pkgdir}/opt/openoffice.org3/program/unopkg
	DICT_DIR=${pkgdir}/opt/openoffice.org3/share/extension/install
	if [ -x "$UNOPKG_BIN" ]; then
		UNOPKG_TMP=${srcdir}/$$$$$$
		find $DICT_DIR -type f -name "*.oxt" \
			-exec $UNOPKG_BIN add --shared {} \
			"-env:UserInstallation=file:///$UNOPKG_TMP" \;
		rm -rf $UNOPKG_TMP 	# Clean up after ourselves
	fi
	
	# Disable Java support if desired (see above)
	if [ "$DISABLE_JAVA" = "YES" ]; then
		chmod -x ${pkgdir}/opt/openoffice.org/ure/bin/javaldx
		# JAVA, GTFO
		rm -rf ${pkgdir}/usr/java
	fi

	# Fix desktop files permissions for KDE
	chmod 0755 ${pkgdir}/opt/openoffice.org3/share/xdg/*.desktop 

	set +eu
}
