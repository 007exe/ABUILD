# ABUILD generated by mkpkg_generator.sh

pkgname=mkinitrd-mini
pkgver=1.4.6
pkgbuild=4
arch=("auto")
busybox_ver=1.22.1

shortdesc=("mkinitrd (make an initial ramdisk)")
longdesc=("mkinitrd is a script to create an initial ramdisk that is loaded at the same time as the kernel. The initial ramdisk may be responsible for loading kernel modules (such a filesystem or SCSI controller module) that are needed to mount the root filesystem. The "initrd" is implemented as an initramfs. See the kernel documentation for more information on this, if you are interested.")

tags=("base sys-apps")
adddep=("tar gzip")
source=("http://busybox.net/downloads/busybox-${busybox_ver}.tar.bz2")
build_deps="gcc bc diffutils"
build() {
	go_src_dir
	burn_patches
	set -e
	# Write a warning to stdout if the mkinitrd script has a different version:
	eval $( grep "^MKINITRD_VERSION=" $filedir/mkinitrd-mini )
	if [ "$pkgver" != "$MKINITRD_VERSION" ]; then
		echo "The version of this package ($pkgver) is not equal to the version of the mkinitrd script ($MKINITRD_VERSION)."
		exit 1
	fi


	sed -e \
		's#^CONFIG_PREFIX=.*#CONFIG_PREFIX="'$pkgdir'/usr/share/mkinitrd/initrd-tree"#' \
			$filedir/busybox-dot-config > .config
	make oldconfig
	make -j$numjobs || make || exit 1

	mkdir -p $pkgdir/usr/share/mkinitrd/initrd-tree/{bin,sbin}
	make install
	rm -f $pkgdir/usr/share/mkinitrd/initrd-tree/linuxrc

	# Copying additional files:
	cp -a $filedir/mkinitrd_command_generator.sh $pkgdir/usr/share/mkinitrd
	chown root:root $pkgdir/usr/share/mkinitrd/mkinitrd_command_generator.sh
	chmod 755 $pkgdir/usr/share/mkinitrd/mkinitrd_command_generator.sh
	cp -a $filedir/keymaps.tar.gz $pkgdir/usr/share/mkinitrd
	chown root:root $pkgdir/usr/share/mkinitrd/keymaps.tar.gz
	chmod 644 $pkgdir/usr/share/mkinitrd/keymaps.tar.gz

	# Zip up the initrd-tree:
	( cd $pkgdir/usr/share/mkinitrd/initrd-tree
		tar xf $filedir/_initrd-tree.tar.gz
		cat $filedir/init > init
		tar czf ../initrd-tree.tar.gz .
	)
	rm -rf $pkgdir/usr/share/mkinitrd/initrd-tree

	mkdir -p $pkgdir/sbin
	cp -a $filedir/mkinitrd-mini $pkgdir/sbin/mkinitrd-mini
	chown root:root $pkgdir/sbin/mkinitrd-mini
	chmod 755 $pkgdir/sbin/mkinitrd-mini

	mkdir -p $pkgdir/usr/man/man{5,8}
	cat $filedir/mkinitrd.8 | gzip -9c > $pkgdir/usr/man/man8/mkinitrd.8.gz
	cat $filedir/mkinitrd.conf.5 | gzip -9c > $pkgdir/usr/man/man5/mkinitrd.conf.5.gz

	mkdir -p $pkgdir/etc
	cp -a $filedir/mkinitrd.conf.sample $pkgdir/etc/mkinitrd.conf.sample
	chown root:root $pkgdir/etc/mkinitrd.conf.sample
	chmod 644 $pkgdir/etc/mkinitrd.conf.sample

	set +e

}


