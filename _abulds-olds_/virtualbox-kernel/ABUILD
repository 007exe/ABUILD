# ABUILD generated by mkpkg_generator.sh

pkgname=virtualbox-kernel
KERNEL=${KERNEL:-`uname -r`}
KERNPKGVERSION=`echo ${KERNEL} | sed -e "s/-/_/g"`
pkgver=4.2.16
srcver=${pkgver}
pkgbuild=2
arch=("auto")

_boxbuild=86992
if [ "$ARCH" = "i686" ];then
_suffix=Linux_x86
elif [ "$ARCH" = "x86_64" ];then
_suffix=Linux_amd64
fi
source=("http://download.virtualbox.org/virtualbox/${srcver}/VirtualBox-${srcver}-${_boxbuild}-${_suffix}.run n")

FINAL_VER=${pkgver}_$(echo ${KERNEL} | tr - _)

pkgver=$FINAL_VER

shortdesc=("Kernel modules for VirtualBox")

tags=("app-emulation drivers")

adddep="kernel==$KERNPKGVERSION"

build_deps="make kernel-source tar coreutils"

build() {
  echo "Building virtualbox-kernel for kernel $KERNEL"
  echo yes | sh ${srcache}/VirtualBox-${srcver}-${_boxbuild}-${_suffix}.run --target ${srcdir} --nox11 --noexec

  echo "Extracting VirtualBox.tar.bz2..."
  tar xf VirtualBox.tar.bz2

  echo "Compiling..."
  cd src/vboxhost
  # Fix makefiles to not do depmod -a there
  for i in `find . -name Makefile` ; do
      sed -i 's/depmod -a;//g' $i
  done

  make -j${numjobs} MODULE_DIR=${pkgdir}/lib/modules/${KERNEL}/misc KERN_DIR=/lib/modules/${KERNEL}/build 
  make MODULE_DIR=${pkgdir}/lib/modules/${KERNEL}/misc KERN_DIR=/lib/modules/${KERNEL}/build install


  mkdir -p ${pkgdir}/install
  sed "s%KERNEL_VERSION%$KERNEL%" ${filedir}/doinst.sh > ${pkgdir}/install/doinst.sh
}

