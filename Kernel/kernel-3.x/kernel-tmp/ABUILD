# ABUILD generated by mkpkg_generator.sh

pkgname=kernel-tmp
# Kernel version may contain '-' symbol, so let's protect from it by using kernel_ver everywhere.
pkgver=3.5.1

kernel_ver=`echo $pkgver | sed -e s/_/-/g`
if [ "$kernel_ver" = "`echo $kernel_ver | sed 's/\.0$//g'`" ] ; then
	srcver=$kernel_ver
else 
	srcver=`echo $kernel_ver | sed 's/\.0$//g'`
fi
kernel_base=`echo $kernel_ver | sed 's/^[^.]*\.//' | sed 's/\..*$//'`

pkgbuild=3
arch=("auto")

shortdesc=("Linux kernel")
longdesc=("This is a Linux kernel with built-in support for most disk controllers and filesystems.")

tags=("base sys-kernel")
adddep="linux-firmware"

source=("ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-${srcver}.tar.bz2")

custom_opts="skip_gendeps no_strip skip_validate"

skip_gendeps=1

pkglist=("modules headers firmware sources")

modules() {
	pkgname=kernel-modules-tmp
	arch=("auto")
	shortdesc=('SMP Linux kernel modules for generic kernel')
	longdesc=('A kernel module is a piece of object code that can be dynamically loaded into the Linux kernel to provide new kernel functions. Most of these modules provide support for devices such as CD-ROM drives, tape drives, and ethernet cards. You can choose which modules to load by editing /etc/conf.d/modules.')

	tags=('base sys-kernel')
	adddep="kmod kernel-tmp==$pkgver"
}

headers() {
	pkgname=kernel-headers-tmp
	arch=("auto")
	shortdesc=('kernel-headers (Linux kernel include files)')
	longdesc=('These are the include files from the Linux kernel. You will need these to compile most system software for Linux.')

	tags=('develop sys-kernel')
}

firmware() {
	pkgname=kernel-firmware-tmp
	arch=("fw")
	shortdesc=('kernel-firmware (Firmware installed by the kernel)')
	longdesc=('These are the firmware files from the Linux kernel. You will need these to use certain hardware with Linux.')

	tags=('base sys-kernel')
}

sources() {
	pkgname=kernel-source-tmp
	arch=('auto')
	shortdesc=('kernel-source (Linux kernel source)')
	longdesc=('Source code for Linus Torvalds Linux kernel. This is the complete source code for the Linux kernel.')

	tags=('develop sys-kernel')
}

apply_aufs_from_git() {
	# Checking out AUFS patch. Note that we do it outside kernel tree. Add AUBRANCH to it if you want to check out specific branch instead of master tree
	( cd .. ; AUBRANCH=${AUBRANCH:-$kernel_base} $filedir/aufs_checkout.sh )

	

#go_src_dir
	# Remove Kbuild, as it should never be copied (see aufs readme)
	ls
	rm ../aufs3-standalone/include/linux/Kbuild

	# Copy aufs tree
	cp -rv ../aufs3-standalone/Documentation .
	cp -rv ../aufs3-standalone/fs .
	cp -rv ../aufs3-standalone/include/ .

	# Applying AUFS patches
	cat ../aufs3-standalone/aufs3-kbuild.patch | patch -p1 --verbose
	cat ../aufs3-standalone/aufs3-base.patch | patch -p1 --verbose
	cat ../aufs3-standalone/aufs3-proc_map.patch | patch -p1 --verbose # Regarding to aufs readme, it is optional, but it won't compile if you miss it.
	# cat ../aufs3-standalone/aufs3-loopback.patch | patch -p1 --verbose # Seems to be deprecated
	cat ../aufs3-standalone/aufs3-standalone.patch | patch -p1 --verbose

	# Clean up
	rm -rf ../aufs3-standalone
	return 0

}



build() {
	go_src_dir

	# Applying generic patches. If you want to apply something personal, just put it into patches directory
	burn_patches

	set -e

	# Check if we are using prepared patches:
	if [ ! -f $patchdir/aufs*-standalone.patch ] ; then
		apply_aufs_from_git
	fi


	# Now copy kernel config
	if [ "$ARCH" = "x86_64" ] ; then
		cat $filedir/3.$kernel_base.defconfig-x86_64 > .config
	else
		cat $filedir/3.$kernel_base.defconfig-x86 > .config
	fi

	# Running make oldconfig seems to be a good idea when upgrading kernel version. Note that here can be interactive questions.
	make oldconfig
	if [ "$KERNEL_CONFIG" != "" ] ; then
		make nconfig
		exit 1
	fi

	# Now, let's build the kernel
	make -j${numjobs}
	echo "Kernel compiled, going into packaging"
	set +e
}

after_build() {
	go_src_dir
	set -e
	mkdir -p ${pkgdir}/boot
	cp arch/x86/boot/bzImage ${pkgdir}/boot/vmlinuz-${kernel_ver}
	ln -s vmlinuz-${kernel_ver} $pkgdir/boot/vmlinuz
	cp System.map $pkgdir/boot/System.map-${kernel_ver}
	ln -s System.map-${kernel_ver} $pkgdir/boot/System.map
	cp .config $pkgdir/boot/config-${kernel_ver}
	ln -s config-${kernel_ver} $pkgdir/boot/config
	set +e
}

modules_prep() {
	go_src_dir
	set -e
	make modules_install INSTALL_MOD_PATH=${pkgdir}

	# Remove firmware from modules package. I don't know why it installs together with modules...
	rm -rf ${pkgdir}/lib/firmware
	rm ${pkgdir}/lib/modules/${kernel_ver}/{source,build}
	ln -sf /usr/src/linux-${kernel_ver} ${pkgdir}/lib/modules/${kernel_ver}/source
	ln -sf /usr/src/linux-${kernel_ver} ${pkgdir}/lib/modules/${kernel_ver}/build

	mkdir -p ${pkgdir}/install
	cat << EOF > ${pkgdir}/install/doinst.sh

# A good idea whenever kernel modules are added or changed:
if [ -x sbin/depmod ]; then
  chroot . /sbin/depmod -a ${kernel_ver} 1> /dev/null 2> /dev/null
fi

EOF
	set +e
}

headers_prep() {
	go_src_dir
	set -e
	make headers_install INSTALL_HDR_PATH=${pkgdir}/usr
	( cd $pkgdir/usr/include && mv asm asm-x86 && ln -s asm-x86 asm )
	find $pkgdir/usr/include -name '.install' | xargs rm
	find $pkgdir/usr/include -name '..install.cmd' | xargs rm

	# Copy aufs-tree manually, since we removed dirty hacks
	install -m644 include/linux/aufs_type.h ${pkgdir}/usr/include/linux/
	set +e
}

firmware_prep() {
	go_src_dir
	set -e
	make firmware_install INSTALL_FW_PATH=${pkgdir}/lib/firmware
	cp -a firmware/WHENCE ${pkgdir}/lib/firmware
	set +e
}

sources_prep() {
	go_src_dir
	set -e
	mkdir -p $pkgdir/usr/src/linux-${kernel_ver}
	echo "Copying kernel tree, please wait. It may take about 10 minutes"
	cp -ard ./* $pkgdir/usr/src/linux-${kernel_ver}/
	( cd $pkgdir/usr/src/linux-${kernel_ver} && make mrproper )
	cat .config > $pkgdir/usr/src/linux-${kernel_ver}/.config
	( cd $pkgdir/usr/src/linux-${kernel_ver} && make prepare && make modules_prepare )
	( cd $pkgdir/usr/src ; ln -s linux-$kernel_ver linux )
	# recreate config. I forgot why it was needed, but it takes no time, so let it be.
	cat .config > $pkgdir/usr/src/linux-$kernel_ver/.config
	set +e
}
