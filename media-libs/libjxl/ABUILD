pkgname=libjxl
pkgver=0.7.0
strict_version=1
pkgbuild=2
arch=("auto")

shortdesc=("JPEG XL image format reference implementation.")
longdesc=("JPEG XL image format reference implementation.")

source=("git:https://github.com/libjxl/libjxl.git"
"git:https://github.com/google/brotli.git"
"git:https://github.com/mm2/Little-CMS.git"
"git:https://github.com/google/googletest.git"
"git:https://github.com/webmproject/sjpeg.git"
"git:https://skia.googlesource.com/skcms.git"
"git:https://github.com/google/highway.git"
"git:https://github.com/glennrp/libpng.git"
"git:https://github.com/madler/zlib.git"
"git:https://github.com/libjxl/testdata.git")

tags=("libs media-libs")

#java-environment gperftools
build_deps=("git cmake clang brotli gdk-pixbuf giflib gimp libjpeg-turbo libpng openexr gtest python asciidoc doxygen graphviz xdg-utils highway")

before_build() {
  cd ${srcdir}
  mv ${srcdir}/libjxl_git_libjxl.git.src ${srcdir}/libjxl
  mv ${srcdir}/libjxl_git_brotli.git.src ${srcdir}/brotli
  mv ${srcdir}/libjxl_git_Little-CMS.git.src ${srcdir}/Little-CMS
  mv ${srcdir}/libjxl_git_googletest.git.src ${srcdir}/googletest
  mv ${srcdir}/libjxl_git_sjpeg.git.src ${srcdir}/sjpeg
  mv ${srcdir}/libjxl_git_skcms.git.src ${srcdir}/skcms
  mv ${srcdir}/libjxl_git_highway.git.src ${srcdir}/highway
  mv ${srcdir}/libjxl_git_libpng.git.src ${srcdir}/libpng
  mv ${srcdir}/libjxl_git_zlib.git.src ${srcdir}/zlib
  mv ${srcdir}/libjxl_git_testdata.git.src ${srcdir}/libjxl-testdata

  git -C libjxl checkout v${pkgver}
  git -C libjxl submodule init
  git -C libjxl config --local submodule.third_party/brotli.url     ${srcdir}/brotli
  git -C libjxl config --local submodule.third_party/googletest.url ${srcdir}/googletest
  git -C libjxl config --local submodule.third_party/sjpeg.url      ${srcdir}/sjpeg
  git -C libjxl config --local submodule.third_party/skcms.url      ${srcdir}/skcms 
  git -C libjxl config --local submodule.third_party/highway.url    ${srcdir}/highway
  git -C libjxl config --local submodule.third_party/lcms.url       ${srcdir}/Little-CMS
  git -C libjxl config --local submodule.third_party/libpng.url     ${srcdir}/libpng
  git -C libjxl config --local submodule.third_party/zlib.url       ${srcdir}/zlib
  git -C libjxl config --local submodule.third_party/testdata.url   ${srcdir}/libjxl-testdata
  git -C libjxl submodule update
}

build() {
  cd ${srcdir}
  export CC='clang'
  export CXX='clang++'
  export CFLAGS+=' -DNDEBUG'
  export CXXFLAGS+=' -DNDEBUG'
  cmake -B build -S libjxl \
    -DCMAKE_BUILD_TYPE:STRING='None' \
    -DCMAKE_INSTALL_PREFIX:PATH='/usr' \
    -DJPEGXL_ENABLE_BENCHMARK:BOOL='false' \
    -DJPEGXL_ENABLE_EXAMPLES:BOOL='false' \
    -DJPEGXL_ENABLE_FUZZERS:BOOL='false' \
    -DJPEGXL_ENABLE_PLUGINS:BOOL='true' \
    -DJPEGXL_ENABLE_VIEWERS:BOOL='false' \
    -DJPEGXL_FORCE_SYSTEM_BROTLI:BOOL='true' \
    -DJPEGXL_FORCE_SYSTEM_GTEST:BOOL='true' \
    -DJPEGXL_FORCE_SYSTEM_HWY:BOOL='true' \
    -Wno-dev
  make -j${numjobs} -C build all doc
  make -C build DESTDIR=${pkgdir} install

  install -D -m644 {LICENSE,PATENTS} -t ${pkgdir}/usr/share/licenses/${pkgname}
}
