pkgname=libjxl
pkgver=0.6.1
pkgbuild=1
arch=("auto")

shortdesc=("JPEG XL image format reference implementation.")
longdesc=("JPEG XL image format reference implementation.")

tags=("libs media-libs")

source=("https://github.com/libjxl/libjxl/archive/refs/tags/v$pkgver.tar.gz")
#"git:https://github.com/google/brotli.git"
#"git:https://github.com/lvandeve/lodepng.git"
#"git:https://github.com/mm2/Little-CMS.git"
#"git:https://github.com/google/googletest.git"
#"git:https://github.com/webmproject/sjpeg.git"
#"git:https://skia.googlesource.com/skcms.git"
#"git:https://github.com/google/highway.git")

build_deps=("cmake clang brotli gdk-pixbuf2 giflib gimp gperftools libjpeg-turbo libpng openexr gtest java-environment python asciidoc doxygen graphviz xdg-utils highway")

build() {
  go_src_dir
  burn_patches
  export CC='clang'
  export CXX='clang++'
  export CFLAGS+=' -DNDEBUG'
  export CXXFLAGS+=' -DNDEBUG'
  cmake -B build \
    -DCMAKE_BUILD_TYPE:STRING='None' \
    -DCMAKE_INSTALL_PREFIX:PATH='/usr' \
    -DCMAKE_INSTALL_LIBDIR:PATH='lib${LIBDIRSUFFIX}' \
    -DJPEGXL_ENABLE_BENCHMARK:BOOL='false' \
    -DJPEGXL_ENABLE_EXAMPLES:BOOL='false' \
    -DJPEGXL_ENABLE_FUZZERS:BOOL='false' \
    -DJPEGXL_ENABLE_PLUGINS:BOOL='true' \
    -DJPEGXL_ENABLE_VIEWERS:BOOL='false' \
    -DJPEGXL_FORCE_SYSTEM_BROTLI:BOOL='true' \
    -DJPEGXL_FORCE_SYSTEM_GTEST:BOOL='true' \
    -DJPEGXL_FORCE_SYSTEM_HWY:BOOL='true' \
    -Wno-dev
  make -j${numjobs} -C build all doc
  make -C build DESTDIR="$pkgdir" install

  install -D -m755 build/tools/libjxl_jni.so -t "${pkgdir}/usr/lib${LIBDIRSUFFIX}"
  install -D -m644 libjxl/{LICENSE,PATENTS} -t "${pkgdir}/usr/share/licenses/${pkgname}"
}
