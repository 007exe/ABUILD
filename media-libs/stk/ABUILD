# ABUILD generated by mkpkg_generator.sh

pkgname=stk
pkgver=4.4.4
pkgbuild=1
arch=("auto")

shortdesc=("The Synthesis ToolKit in C++")

tags=("media-sound xapps")

source=("http://ccrma.stanford.edu/software/stk/release/$pkgname-$pkgver.tar.gz")

build_deps="jack1 alsa-lib"

build() {
	go_src_dir
	burn_patches

	# add missing linker flag
	export LIBS="$LIBS -lpthread"

	# enable shared library
	sed -i 's/all : $(STATICLIB)/all : $(SHAREDLIB)/' src/Makefile.in
	./configure --prefix=/usr --libdir=/usr/lib$LIBDIRSUFFIX --mandir=/usr/man --sysconfdir=/etc --with-alsa --with-jack RAWWAVE_PATH=/usr/lib${LIBDIRSUFFIX}/stk/rawwaves/
	make -j${numjobs}
	cat ${filedir}/runtime.patch | sed s:/lib:/lib64:g | patch -Np1

	mkdir -p "$pkgdir"/usr/{bin,{lib${LIBDIRSUFFIX},include}/stk}

	# install library
	cp -a src/libstk.* "$pkgdir/usr/lib${LIBDIRSUFFIX}/"

	# install headers
	install -m644 include/* "$pkgdir/usr/include/stk/"

	# install runtime files
	cp -a rawwaves projects/demo/{demo,tcl} projects/effects/{effects,tcl} \
		projects/ragamatic/{ragamat,tcl,rawwaves} "$pkgdir/usr/lib${LIBDIRSUFFIX}/stk/"

	# install executables
	install -m755 projects/{demo/StkDemo,effects/StkEffects} "$pkgdir/usr/bin/"
	install -m755 projects/ragamatic/Raga "$pkgdir/usr/bin/StkRagamatic"

	rm -rf "${pkgdir}/usr/lib${LIBDIRSUFFIX}/stk/rawwaves/.DS_Store"
}

