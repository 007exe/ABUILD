pkgname=sqlite
pkgver=3.35.5
pkgbuild=1
arch=('auto')
_amalgamationver=3350500

shortdesc=("C library that implements an embeddable SQL database engine")
longdesc=("SQLite is a C library that implements an embeddable SQL database engine. Programs that link with the SQLite library can have SQL database access without running a separate RDBMS process. The distribution comes with a standalone command-line access program (sqlite) that can be used to administer an SQLite database and which serves as an example of how to use the SQLite library.")

tags=('console dev-db')

build_deps="tcl readline zlib"

source=("http://sqlite.org/2021/sqlite-autoconf-${_amalgamationver}.tar.gz"
        "http://www.sqlite.org/2021/sqlite-doc-${_amalgamationver}.zip")

pkglist="sqlite-doc"

build() {
  go_src_dir
  burn_patches
  export CPPFLAGS="$CPPFLAGS \
      -DSQLITE_ENABLE_COLUMN_METADATA=1 \
      -DSQLITE_ENABLE_UNLOCK_NOTIFY \
      -DSQLITE_ENABLE_DBSTAT_VTAB=1 \
      -DSQLITE_ENABLE_FTS3_TOKENIZER=1 \
      -DSQLITE_SECURE_DELETE \
      -DSQLITE_ENABLE_STMTVTAB \
      -DSQLITE_MAX_VARIABLE_NUMBER=250000 \
      -DSQLITE_MAX_EXPR_DEPTH=10000 \
      -DSQLITE_ENABLE_MATH_FUNCTIONS"

  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --disable-static \
    --disable-amalgamation \
    --enable-fts3 \
    --enable-fts4 \
    --enable-fts5 \
    --enable-rtree \
    --enable-json1
  make -j${numjobs}

  make DESTDIR=${pkgdir} install


# install manpage
  install -m755 -d "${pkgdir}"/usr/share/man/man1
  install -m644 sqlite3.1 "${pkgdir}"/usr/share/man/man1/
}

sqlite-doc() {
  pkgname=sqlite-doc
  shortdesc=("Most of the static HTML files that comprise this website, including all of the SQL Syntax and the C/C++ interface specs and other miscellaneous documentation")
  longdesc=("Most of the static HTML files that comprise this website, including all of the SQL Syntax and the C/C++ interface specs and other miscellaneous documentation")
}

sqlite-doc_prep() {
  cd ${srcdir}/sqlite-doc-${_amalgamationver}
  mkdir -p ${pkgdir}/usr/doc/sqlite-${pkgver}
  cp -R *  ${pkgdir}/usr/doc/sqlite-${pkgver}/

  # fix permissions and remove obsolete files; https://bugs.archlinux.org/task/24605
  find ${pkgdir} -type f -perm 755 -exec ls -lha {} \;
  find ${pkgdir} -type f -perm 755 -exec chmod 644 {} \;

  find ${pkgdir} -type f -name '*~' -exec ls -lha {} \;
  find ${pkgdir} -type d -name '*~' -exec ls -lha {} \;
  find ${pkgdir} -name '*~' -exec rm -f {} \;

  find ${pkgdir} -type f -name '.~*' -exec ls -lha {} \;
  find ${pkgdir} -type d -name '.~*' -exec ls -lha {} \;
  find ${pkgdir} -name '.~*' -exec rm -f {} \;
}
