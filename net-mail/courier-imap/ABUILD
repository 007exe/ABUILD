pkgname=courier-imap
pkgver=5.1.9
pkgbuild=1
arch=("auto")

shortdesc=("IMAP(s)/POP3(s) Server.")

source=("http://downloads.sourceforge.net/project/courier/imap/${pkgver}/${pkgname}-${pkgver}.tar.bz2")

tags=("server net-mail")

build_deps=("gcc-libs gdbm openssl courier-maildrop gamin courier-unicode courier-authlib")

build() {
  go_src_dir
  burn_patches
  sed -i -e 's|--with-authchangepwdir=/var/tmp/dev/null|--with-authchangepwdir="$libexecdir"/authlib|' configure && chmod 755 configure
  ./configure \
    --prefix=/usr \
    --sysconfdir=/etc/courier-imap \
    --sbindir=/usr/bin \
    --libexecdir=/usr/lib/courier-imap \
    --localstatedir=/var/spool/courier-imap \
    --disable-root-check \
    --enable-unicode \
    --enable-workarounds-for-imap-client-bugs \
    --with-piddir=/run/courier \
    --with-trashquota \
    --with-db=gdbm \
    --with-mailuser=courier --with-mailgroup=courier \
    --with-notice=unicode --build=x86_64
  make -j${numjobs}
  make DESTDIR=${pkgdir} install

  rm ${pkgdir}/usr/bin/{deliverquota,maildirmake,makedat,maildirkw}
  rm ${pkgdir}/usr/share/man/man1/maildirmake*
  rm ${pkgdir}/usr/share/man/man1/maildirkw*
  rm ${pkgdir}/usr/share/man/man8/deliverquota*

  for _distfile in "${pkgdir}/etc/courier-imap/"*.dist; do
     chown -R 72:72 "${pkgdir}/etc/courier-imap/"
     mv "${_distfile}" "${pkgdir}/etc/courier-imap/"$(basename "${_distfile}" .dist)
  done
  sed -i 's|TLS_CERTFILE=/usr/share/|TLS_CERTFILE=/etc/courier-imap/|' "${pkgdir}/etc/courier-imap/"*-ssl

  install -Dm 644 ${filedir}/courier-imapd.service     ${pkgdir}/usr/lib/systemd/system/courier-imapd.service
  install -Dm 644 ${filedir}/courier-imapd-ssl.service ${pkgdir}/usr/lib/systemd/system/courier-imapd-ssl.service
  install -Dm 644 ${filedir}/courier-pop3d.service     ${pkgdir}/usr/lib/systemd/system/courier-pop3d.service
  install -Dm 644 ${filedir}/courier-pop3d-ssl.service ${pkgdir}/usr/lib/systemd/system/courier-pop3d-ssl.service

  mkdir ${pkgdir}/usr/lib/tmpfiles.d -p
  echo "D /run/courier 0755 courier courier" > ${pkgdir}/usr/lib/tmpfiles.d/courier-imapd.conf
  echo "D /run/courier 0755 courier courier" > ${pkgdir}/usr/lib/tmpfiles.d/courier-imapd-ssl.conf

  mkdir -p ${pkgdir}/run/courier
}
