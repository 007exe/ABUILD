pkgname=qt4
pkgver=4.8.7
pkgbuild=1
arch=("auto")

shortdesc=("A cross-platform application and UI framework")
longdesc=("Qt4 is a cross-platform application framework that is widely used for developing application software with a graphical user interface (GUI), and also used for developing non-GUI programs such as command-line tools and consoles for servers.")

tags=('libs x11-libs')

_pkgfqn="qt-everywhere-opensource-src-${pkgver}"
source=("https://ftp.desolve.ru/ftp/viktor/qt4/${_pkgfqn}.tar.gz")

gendeps_blacklist="usr/lib$LIBDIRSUFFIX/qt/plugins/"

removedep="mysql postgresql"

build_deps=("unixodbc mesa sqlite ca-certificates fontconfig libglvnd libxrandr libxv libxi alsa-lib dbus cups gtk2 xdg-utils hicolor-icon-theme desktop-file-utils")

build() {
  go_src_dir
  burn_patches
  echo "QMAKE_CXXFLAGS += -std=gnu++98" >> src/3rdparty/javascriptcore/JavaScriptCore/JavaScriptCore.pri
  echo "QMAKE_CXXFLAGS += -std=gnu++98" >> src/plugins/accessible/qaccessiblebase.pri
  export QT4DIR="${srcdir}"/${_pkgfqn}
  export LD_LIBRARY_PATH=${QT4DIR}/lib:${LD_LIBRARY_PATH}

  ./configure \
    -prefix /usr \
    -bindir /usr/lib${LIBDIRSUFFIX}/qt4/bin \
    -libdir /usr/lib$LIBDIRSUFFIX \
    -plugindir /usr/lib${LIBDIRSUFFIX}/qt4/plugins \
    -importdir /usr/lib${LIBDIRSUFFIX}/qt4/imports \
    -headerdir /usr/include/qt4 \
    -datadir /usr/share/qt4 \
    -docdir /usr/share/doc/qt4 \
    -translationdir /usr/share/qt4/translations \
    -demosdir /usr/share/doc/qt4/demos \
    -examplesdir /usr/share/doc/qt4/examples \
    -sysconfdir /etc/xdg \
    -confirm-license \
    -opensource \
    -release \
    -dbus-linked \
    -openssl-linked \
    -system-sqlite \
    -no-phonon \
    -no-phonon-backend \
    -no-webkit \
    -no-openvg \
    -no-rpath \
    -no-reduce-relocations \
    -nomake demos \
    -nomake examples \
    -nomake docs \
    -optimized-qmake \
    -graphicssystem raster \
    -xmlpatterns \
    -silent \
    -little-endian \
    -host-little-endian

  make -j${numjobs}
  make INSTALL_ROOT="${pkgdir}" install

# Add profile scripts
  mkdir -p ${pkgdir}/etc/profile.d
  sed -e "s#usr/lib/#usr/lib${LIBDIRSUFFIX}/#g" ${filedir}/profile.d/qt4.sh \
    > ${pkgdir}/etc/profile.d/qt4.sh
  sed -e "s#usr/lib/#usr/lib${LIBDIRSUFFIX}/#g" ${filedir}/profile.d/qt4.csh \
    > ${pkgdir}/etc/profile.d/qt4.csh
  chmod 0755 ${pkgdir}/etc/profile.d/*

# install missing icons and desktop files
  install -D -m644 src/gui/dialogs/images/qtlogo-64.png \
    "${pkgdir}"/usr/share/icons/hicolor/64x64/apps/qt4logo.png
  install -D -m644 tools/assistant/tools/assistant/images/assistant.png \
    "${pkgdir}"/usr/share/icons/hicolor/32x32/apps/assistant-qt4.png
  install -D -m644 tools/assistant/tools/assistant/images/assistant-128.png \
    "${pkgdir}"/usr/share/icons/hicolor/128x128/apps/assistant-qt4.png
  install -D -m644 tools/designer/src/designer/images/designer.png \
    "${pkgdir}"/usr/share/icons/hicolor/128x128/apps/designer-qt4.png
  for icon in tools/linguist/linguist/images/icons/linguist-*-32.png ; do
    size=$(echo $(basename ${icon}) | cut -d- -f2)
    install -D -m644 ${icon} \
        "${pkgdir}"/usr/share/icons/hicolor/${size}x${size}/apps/linguist-qt4.png
  done
  install -D -m644 tools/qdbus/qdbusviewer/images/qdbusviewer.png \
    "${pkgdir}"/usr/share/icons/hicolor/32x32/apps/qdbusviewer-qt4.png
  install -D -m644 tools/qdbus/qdbusviewer/images/qdbusviewer-128.png \
    "${pkgdir}"/usr/share/icons/hicolor/128x128/apps/qdbusviewer-qt4.png

  install -d "${pkgdir}"/usr/share/applications
  install -m644 "${filedir}"/{assistant,designer,linguist,qtconfig,qdbusviewer}-qt4.desktop \
    "${pkgdir}"/usr/share/applications/

# Useful symlinks for cmake and configure scripts
    install -d "${pkgdir}"/usr/bin
    for b in "${pkgdir}"/usr/lib${LIBDIRSUFFIX}/qt4/bin/*; do
      ln -s /usr/lib${LIBDIRSUFFIX}/qt4/bin/$(basename $b) "${pkgdir}"/usr/bin/$(basename $b)-qt4
    done

# Fix wrong libs path in pkgconfig files
    find "${pkgdir}/usr/lib${LIBDIRSUFFIX}/pkgconfig" -type f -name '*.pc' \
      -exec perl -pi -e "s, -L${srcdir}/?\S+,,g" {} \;

# Fix wrong bins path in pkgconfig files
    find "${pkgdir}/usr/lib${LIBDIRSUFFIX}/pkgconfig" -type f -name '*.pc' \
      -exec sed -i 's|/usr/bin/|/usr/lib${LIBDIRSUFFIX}/qt4/bin/|g' {} \;

# Fix wrong path in prl files
    find "${pkgdir}/usr/lib${LIBDIRSUFFIX}" -type f -name '*.prl' \
      -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d;s/\(QMAKE_PRL_LIBS =\).*/\1/' {} \;

# The TGA plugin is broken (FS#33568)
    rm "${pkgdir}"/usr/lib${LIBDIRSUFFIX}/qt4/plugins/imageformats/libqtga.so

# install license addition
  install -D -m644 LGPL_EXCEPTION.txt \
    ${pkgdir}/usr/share/licenses/${pkgname}/LGPL_EXCEPTION.txt
}
