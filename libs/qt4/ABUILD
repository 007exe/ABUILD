pkgname=qt4
pkgver=4.8.7
pkgbuild=1
arch=("auto")

shortdesc=("A cross-platform application and UI framework")
longdesc=("Qt4 is a cross-platform application framework that is widely used for developing application software with a graphical user interface (GUI), and also used for developing non-GUI programs such as command-line tools and consoles for servers.")

tags=('libs x11-libs')

_pkgfqn="qt-everywhere-opensource-src-${pkgver}"
source=("https://ftp.desolve.ru/ftp/viktor/qt4/${_pkgfqn}.tar.gz")

pkglist="qtdoc"

gendeps_blacklist="usr/lib$LIBDIRSUFFIX/qt/plugins/"

removedep="mysql postgresql"
# postgresql-libs mariadb-libs cups gtk2 libfbclient xdg-utils hicolor-icon-theme desktop-file-utils libmng
build_deps=("unixodbc mesa sqlite ca-certificates fontconfig libglvnd libxrandr libxv libxi alsa-lib dbus")

build() {
  go_src_dir
  burn_patches
  echo "QMAKE_CXXFLAGS += -std=gnu++98" >> src/3rdparty/javascriptcore/JavaScriptCore/JavaScriptCore.pri
  echo "QMAKE_CXXFLAGS += -std=gnu++98" >> src/plugins/accessible/qaccessiblebase.pri
  export QT4DIR="${srcdir}"/${_pkgfqn}
  export LD_LIBRARY_PATH=${QT4DIR}/lib:${LD_LIBRARY_PATH}

  ./configure -confirm-license -opensource \
    -prefix /usr \
    -bindir /usr/lib/qt4/bin \
    -headerdir /usr/include/qt4 \
    -docdir /usr/share/doc/qt4 \
    -plugindir /usr/lib${LIBDIRSUFFIX}/qt4/plugins \
    -importdir /usr/lib${LIBDIRSUFFIX}/qt4/imports \
    -datadir /usr/share/qt4 \
    -translationdir /usr/share/qt4/translations \
    -sysconfdir /etc/xdg \
    -examplesdir /usr/share/doc/qt4/examples \
    -demosdir /usr/share/doc/qt4/demos \
    -plugin-sql-{psql,mysql,sqlite,odbc,ibase} \
    -system-sqlite \
    -no-phonon \
    -no-phonon-backend \
    -no-webkit \
    -graphicssystem raster \
    -openssl-linked \
    -nomake demos \
    -nomake examples \
    -nomake docs \
    -xmlpatterns \
    -silent \
    -no-rpath \
    -optimized-qmake \
    -no-reduce-relocations \
    -dbus-linked \
    -no-openvg \
    -little-endian -host-little-endian
  make -j${numjobs}
  make INSTALL_ROOT="${pkgdir}" install

# install missing icons and desktop files
  install -D -m644 src/gui/dialogs/images/qtlogo-64.png \
    "${pkgdir}"/usr/share/icons/hicolor/64x64/apps/qt4logo.png
  install -D -m644 tools/assistant/tools/assistant/images/assistant.png \
    "${pkgdir}"/usr/share/icons/hicolor/32x32/apps/assistant-qt4.png
  install -D -m644 tools/assistant/tools/assistant/images/assistant-128.png \
    "${pkgdir}"/usr/share/icons/hicolor/128x128/apps/assistant-qt4.png
  install -D -m644 tools/designer/src/designer/images/designer.png \
    "${pkgdir}"/usr/share/icons/hicolor/128x128/apps/designer-qt4.png
  for icon in tools/linguist/linguist/images/icons/linguist-*-32.png ; do
    size=$(echo $(basename ${icon}) | cut -d- -f2)
    install -D -m644 ${icon} \
        "${pkgdir}"/usr/share/icons/hicolor/${size}x${size}/apps/linguist-qt4.png
  done
  install -D -m644 tools/qdbus/qdbusviewer/images/qdbusviewer.png \
    "${pkgdir}"/usr/share/icons/hicolor/32x32/apps/qdbusviewer-qt4.png
  install -D -m644 tools/qdbus/qdbusviewer/images/qdbusviewer-128.png \
    "${pkgdir}"/usr/share/icons/hicolor/128x128/apps/qdbusviewer-qt4.png

  install -d "${pkgdir}"/usr/share/applications
  install -m644 "${srcdir}"/{assistant,designer,linguist,qtconfig,qdbusviewer}-qt4.desktop \
    "${pkgdir}"/usr/share/applications/

# Useful symlinks for cmake and configure scripts
  install -d "${pkgdir}"/usr/bin
  for b in "${pkgdir}"/usr/lib${LIBDIRSUFFIX}/qt4/bin/*; do
    ln -s /usr/lib${LIBDIRSUFFIX}/qt4/bin/$(basename $b) "${pkgdir}"/usr/bin/$(basename $b)-qt4
  done

# install license addition
  install -D -m644 LGPL_EXCEPTION.txt \
    ${pkgdir}/usr/share/licenses/${pkgname}/LGPL_EXCEPTION.txt

# Fix wrong libs path in pkgconfig files
  find "${pkgdir}/usr/lib${LIBDIRSUFFIX}/pkgconfig" -type f -name '*.pc' \
    -exec perl -pi -e "s, -L${srcdir}/?\S+,,g" {} \;

# Fix wrong bins path in pkgconfig files
  find "${pkgdir}/usr/lib${LIBDIRSUFFIX}/pkgconfig" -type f -name '*.pc' \
    -exec sed -i 's|/usr/bin/|/usr/lib${LIBDIRSUFFIX}/qt4/bin/|g' {} \;

# Fix wrong path in prl files
  find "${pkgdir}/usr/lib${LIBDIRSUFFIX}" -type f -name '*.prl' \
    -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d;s/\(QMAKE_PRL_LIBS =\).*/\1/' {} \;

# The TGA plugin is broken (FS#33568)
  rm "${pkgdir}"/usr/lib${LIBDIRSUFFIX}/qt4/plugins/imageformats/libqtga.so
}

qtdoc() {
  pkgname=qt4-doc
  arch=('noarch')
  shortdesc=("Qt4 Documentation")
  longdesc=("This package contains complete Qt programming reference. If you wish to browse documentation using assisant, you need this package.")
}

qtdoc_prep() {
  # Move documentation to separate package:
  mkdir -p ${pkgdir}/usr/doc
  mv ${p_pkgdir}/usr/doc/qt-${pkgver} ${pkgdir}/usr/doc/qt-${pkgver}
}
