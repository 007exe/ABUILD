# ABUILD generated by mkpkg_generator.sh

pkgname=ncurses
pkgver=6.2
pkgbuild=1
arch=("auto")

shortdesc=("ncurses (CRT screen handling and optimization package)")
longdesc=("The ncurses (new curses) library is a free software emulation of curses in System V Release 4.0, and more. It uses terminfo format, supports pads and color and multiple highlights and forms characters and function-key mapping, and has all the other SYSV-curses enhancements over BSD curses.")

tags=("libs sys-libs compat32")

source=("ftp://ftp.gnu.org/pub/gnu/${pkgname}/${pkgname}-${pkgver}.tar.gz")

build_deps="glibc-solibs libtermcap"
if [ "$ARCH" = "x86_64" ] ; then
	X86_64OPTS=" --with-chtype=long --with-mmask-t=long "
fi

BUILD_KEYS="--prefix=/usr \
	--libdir=/usr/lib${LIBDIRSUFFIX} \
	--with-gpm \
	--disable-termcap \
	--with-normal \
	--with-shared \
	--enable-symlinks \
	--without-debug \
	--without-profile \
	--without-ada \
	$X86_64OPTS \
	--program-suffix= \
	--program-prefix="


build() {
	go_src_dir
	burn_patches
	set -e

	./configure $BUILD_KEYS
	make -j${numjobs}
	make install DESTDIR=${pkgdir}

	make clean
	./configure $BUILD_KEYS --enable-widec
	make -j${numjobs}
	make install DESTDIR=${pkgdir}
	set +e
}

after_build() {
	go_src_dir
	set -e
	if [ ! -d $pkgdir/usr/include/ncursesw -a ! -L $pkgdir/usr/include/ncursesw ]; then
		( cd $pkgdir/usr/include ; ln -sf ncurses ncursesw )
	fi

	# Move the include files from /usr/include into
	# /usr/include/ncurses, then make symlinks back
	# into /usr/include.
	( cd $pkgdir/usr/include
		rm -rf ncurses
		mkdir ncurses
		mv *.h ncurses
		for file in ncurses/* ; do
			ln -sf $file .
		done
		# This shouldn't clobber the real one:
		mv termcap.h termcap-ncurses.h
	)

	# Move the ncurses libraries into /lib, since they're important:
	mkdir -p $pkgdir/lib${LIBDIRSUFFIX}
	( cd $pkgdir/usr/lib${LIBDIRSUFFIX}
		chmod 755 *.so
		chmod 644 *.a
		mv libncurses.so.6* ${pkgdir}/lib${LIBDIRSUFFIX}
		mv libncursesw.so.6* ${pkgdir}/lib${LIBDIRSUFFIX}
		rm -f libncurses.so
		ln -sf /lib${LIBDIRSUFFIX}/libncurses.so.6 libncurses.so
		rm -f libncursesw.so
		ln -sf /lib${LIBDIRSUFFIX}/libncursesw.so.6 libncursesw.so
		# Olde obsolete names, just in case
		rm -f libcurses.so
		ln -sf libncurses.so libcurses.so
		rm -f libcursesw.so
		ln -sf libncursesw.so libcursesw.so
	)

	# Set TERMINFO to point to the package:
	export TERMINFO=${pkgdir}/usr/share/terminfo
	# Fix the xterm, screen, rxvt, and Eterm entries:
	for tfile in xterm.terminfo screeninfo.src rxvt.terminfo Eterm.ti ; do
		if [ -r $tfile ]; then
			progs/tic -v ${filedir}/$tfile
		fi
	done
	unset TERMINFO

	set +e
}
