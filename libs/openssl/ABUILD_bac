pkgname=openssl
pkgver=1.1.1h
pkgbuild=1
arch=('auto')

shortdesc=("Secure Sockets Layer toolkit")
longdesc=("The OpenSSL certificate management tool and the shared libraries that provide various encryption and decryption algorithms and protocols. This product includes software developed by the OpenSSL Project for use in the OpenSSL Toolkit (http://www.openssl.org). This product includes cryptographic software written by Eric Young (eay@cryptsoft.com). This product includes software written by Tim Hudson (tjh@cryptsoft.com).")

tags=('dev-libs network compat32')

source=("http://www.openssl.org/source/openssl-${pkgver}.tar.gz")

build_deps='make gcc glibc perl kernel-headers diffutils ca-certificates'

pkglist="solibs"

adddep="openssl-solibs==${pkgver}"

build() {
  go_src_dir
  burn_patches

  if [ "${ARCH}" == 'x86_64' ]; then
     openssltarget='linux-x86_64'
     optflags='enable-ec_nistp_64_gcc_128'
  else
     openssltarget='linux-elf'
     optflags='no-sse2'
  fi
  set -x
  sed -i '1s,^:$,#!/usr/bin/perl,' Configure

  ./Configure --prefix=/usr --openssldir=/etc/ssl --libdir=lib${LIBDIRSUFFIX} \
              shared zlib enable-md2 ${optflags} "${openssltarget}"
  make depend
  make
  make install INSTALL_PREFIX=${pkgdir}

  ( cd ${pkgdir}/usr/lib${LIBDIRSUFFIX} ; ldconfig -l lib*.so.* )

  # Создаю линки на libssl.so и libcrypto.so хз правельно или не правельно это но при сборке mpkg последний упорно ссылается на libssl.so.0 и libcrypto.so.0 в будущем нужно будит это удалить
  ln -n ${pkgdir}/usr/lib${LIBDIRSUFFIX}/libssl.so ${pkgdir}/usr/lib${LIBDIRSUFFIX}/libssl.so.0 
  ln -n ${pkgdir}/usr/lib${LIBDIRSUFFIX}/libcrypto.so ${pkgdir}/usr/lib${LIBDIRSUFFIX}/libcrypto.so.0 

  mkdir -p ${pkgdir}/etc/cron.daily
  zcat ${filedir}/certwatch.gz > ${pkgdir}/etc/cron.daily/certwatch.new
  chmod 755 ${pkgdir}/etc/cron.daily/certwatch.new

  mv ${pkgdir}/etc/ssl/openssl.cnf ${pkgdir}/etc/ssl/openssl.cnf.new
  mv ${pkgdir}/etc/ssl/man ${pkgdir}/usr/share
  cd ${pkgdir}
  chmod 755 usr/lib${LIBDIRSUFFIX}/pkgconfig
  mkdir -p install
  zcat $filedir/doinst.sh-openssl.gz > install/doinst.sh
  set +x
}

solibs() {
  pkgname=openssl-solibs
  tags="sys-base base"
  shortdesc=("OpenSSL shared libraries")
  longdesc=("These shared libraries provide encryption routines required by programs such as openssh. They are also used by KDE's Konqueror web browser to provide secure web connections. This product includes software developed by the OpenSSL Project for use in the OpenSSL Toolkit (http://www.openssl.org). This product includes cryptographic software written by Eric Young (eay@cryptsoft.com). This product includes software written by Tim Hudson (tjh@cryptsoft.com).")
}

solibs_prep() {
# Стоит разобратся и перенести doinst.sh-openssl-solibs.gz в doinst.sh-openssl.gz и полностью избавится от пакета openssl-solibs
(  cd ${pkgdir}
  mkdir -p install
  zcat $filedir/doinst.sh-openssl-solibs.gz > install/doinst.sh  )
echo Make runtime package: done
}

