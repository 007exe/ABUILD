pkgname=gdb
pkgver=11.1
pkgbuild=1
arch=("auto")

shortdesc=("A stub package for GNU source-level debugger")
longdesc=("GDB, the GNU Project debugger, allows you to see what is going on inside another program while it executes -- or what another program was doing at the moment it crashed. Note that GDB is most effective when tracing programs and libraries that were built with debugging symbols and not stripped.")

tags=("develop sys-devel")

build_deps="ncurses expat python guile2 source-highlight"

adddep="python"

source=("http://ftp.gnu.org/gnu/gdb/${pkgname}-${pkgver}.tar.xz")

config_files="etc/gdb/gdbinit"

build() {
  go_src_dir
  mkdir -p build && cd build
  ../configure \
    --libdir=/usr/lib$LIBDIRSUFFIX \
    --prefix=/usr \
    --disable-nls \
    --with-python=/usr/bin/python \
    --enable-source-highlight \
    --enable-tui \
    --with-system-readline \
    --with-guile=guile-2.0 \
    --with-system-gdbinit=/etc/gdb/gdbinit
  make
  make DESTDIR="$pkgdir" install
}


after_build() {
  set -e
# install "custom" system gdbinit
  install -dm755 $pkgdir/etc/gdb
  touch $pkgdir/etc/gdb/gdbinit

# resolve conflicts with binutils
  rm -f ${pkgdir}/usr/include/{ansidecl,bfd,bfdlink,dis-asm,symcat}.h
  rm -f ${pkgdir}/usr/lib${LIBDIRSUFFIX}/{libbfd,libiberty,libopcodes}.a
  rm -f ${pkgdir}/usr/lib${LIBDIRSUFFIX}/{libbfd,libiberty,libopcodes}.la
  rm -f ${pkgdir}/usr/share/info/{bfd,configure,standards}.info
  set +e
}
