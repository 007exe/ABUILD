pkgname=llvm
pkglist=("llvm_libs")
pkgver=16.0.6
pkgbuild=1
arch=("auto")

shortdesc=("Low Level Virtual Machine (LLVM).")

source=("https://github.com/llvm/llvm-project/archive/refs/tags/llvmorg-${pkgver}.tar.gz")

tags=("develop sys-devel")

adddep=("llvm-libs perl")
dep_llvm_libs=("gcc-libs zlib zstd libffi libedit ncurses libxml2")
build_deps=("${adddep} ${dep_llvm_libs} cmake ninja zlib zstd libffi libedit
ncurses libxml2 python-setuptools python-psutil python-sphinx python-recommonmark")

build() {
  cd ${srcdir}/llvm-project-llvmorg-${pkgver}/llvm
  burn_patches
# Отключаем использование SDK в OSX, ошибка #568758
  sed -i -e 's/xcrun/false/' utils/lit/lit/util.py
  mkdir build
  cd build
  cmake .. -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_DOCDIR=share/doc \
    -DLLVM_HOST_TRIPLE=x86_64-pc-linux-gnu \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_ENABLE_RTTI=ON \
    -DCMAKE_SKIP_RPATH=ON \
    -DLLVM_USE_PERF=ON \
    -DLLVM_ENABLE_FFI=ON \
    -DLLVM_BUILD_TESTS=ON \
    -DLLVM_BUILD_DOCS=ON\
    -DLLVM_ENABLE_SPHINX=ON \
    -DLLVM_ENABLE_BINDINGS=OFF \
    -DLLVM_ENABLE_DOXYGEN=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DSPHINX_WARNINGS_AS_ERRORS=OFF \
    -DLLVM_BINUTILS_INCDIR=/usr/include
  ninja
  DESTDIR=${pkgdir} ninja install

# Включаем lit для запуска тестов на основе lit в других проектах
  pushd ../utils/lit
  python3 setup.py install --root=${pkgdir} -O1
  popd

# Эти библиотеки находятся в llvm-libs
  mv -f ${pkgdir}/usr/lib/lib{LLVM,LTO,Remarks}*.so* ${srcdir}
  mv -f ${pkgdir}/usr/lib/LLVMgold.so ${srcdir}

# Требуется для мультибиблиотек (https://bugs.archlinux.org/task/29951)
# Взято из Fedora
  mv ${pkgdir}/usr/include/llvm/Config/llvm-config{,-64}.h
  cp ${filedir}/llvm-config.h ${pkgdir}/usr/include/llvm/Config/llvm-config.h

# Удаляем документацию
  rm -r ${pkgdir}/usr/share/doc/llvm/html/{_sources,.buildinfo}

  install -Dm644 ../LICENSE.TXT ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE
}

###############################################################################################

llvm_libs() {
  pkgname=llvm-libs
  shortdesc=("Libraries and header files for LLVM.")
  tags=("libs sys-libs")
  adddep=("llvm=${pkgver} ${dep_llvm_libs}")
}

llvm_libs_prep() {
  go_src_dir
  install -d ${pkgdir}/usr/lib
  cp -P \
    ${srcdir}/lib{LLVM,LTO,Remarks}*.so* \
    ${srcdir}/LLVMgold.so \
    ${pkgdir}/usr/lib/

# Симлинк LLVMgold.so из /usr/lib/bfd-plugins
# https://bugs.archlinux.org/task/28479
  install -d ${pkgdir}/usr/lib/bfd-plugins
  ln -s ../LLVMgold.so ${pkgdir}/usr/lib/bfd-plugins/LLVMgold.so

  install -Dm644 ${srcdir}/llvm-project-llvmorg-${pkgver}/llvm/LICENSE.TXT ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE
}
