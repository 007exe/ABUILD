pkgname=courier-authlib
pkgver=0.71.6
pkgbuild=1
arch=("auto")

shortdesc=("Authentication library for the Courier mailserver(s).")

source=("http://downloads.sourceforge.net/project/courier/authlib/${pkgver}/${pkgname}-${pkgver}.tar.bz2")

tags=("libs sys-libs")

build_deps=("openssl gdbm perl libtool expect procps-ng expect linux-pam openldap mariadb-libs postgresql-libs courier-unicode")

config_files=("etc/authlib/authdaemonrc
etc/authlib/authldaprc
etc/authlib/authmysqlrc
etc/authlib/authpgsqlrc")

build() {
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --sbindir=/usr/bin \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --libdir=/usr/lib \
    --libexecdir=/usr/lib \
    --with-db=gdbm \
    --with-mailuser=courier \
    --with-mailgroup=courier \
    --with-authpam \
    --with-authpwd \
    --with-authshadow \
    --with-authldap \
    --with-authmysql \
    --with-authpgsql \
    --with-authuserdb \
    --with-authcram \
    --with-authdaemon \
    --with-authdaemonvar=/run/authdaemon
  make -j${numjobs}
  make DESTDIR=${pkgdir} install

  for _distfile in ${pkgdir}/etc/authlib/*.dist; do
    chown 72:72 ${_distfile}
    mv ${_distfile} ${pkgdir}/etc/authlib/`basename ${_distfile} .dist`
  done

  install -Dm 444 authldap.schema ${pkgdir}/etc/openldap/schema/courier.schema

  chown 72:72 ${pkgdir}/usr/lib/courier-authlib

  install -Dm 644 ${filedir}/courier.conf ${pkgdir}/usr/lib/sysusers.d/courier.conf

  install -Dm 644 ${filedir}/authdaemond.service ${pkgdir}/usr/lib/systemd/system/authdaemond.service

  install -Dm 644 ${filedir}/courier-authlib.tmpfiles ${pkgdir}/usr/lib/tmpfiles.d/courier-authlib.conf

  mkdir -p ${pkgdir}/var/spool/courier
}
