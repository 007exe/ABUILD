pkgname=zeromq
pkgver=4.3.5
pkgbuild=1
arch=("auto")
strict_version='yes'

shortdesc=("Fast messaging system built on sockets. C and C++ bindings. aka 0MQ, ZMQ.")

source=("git:https://github.com/zeromq/libzmq.git")

tags=("libs net-libs")

# WITH_OPENPGM=ON libpgm
adddep=("glibc gnutls gcc-libs util-linux libsodium")

build_deps=("${adddep} cmake asciidoc xmlto")

# NOTE: Переходим к коммиту
# FIXME: mkpkg не умеет самостоятельно переключаться по веткам и коммитам
before_build() {
  go_src_dir
  git checkout v${pkgver}
}

build() {
  go_src_dir
  burn_patches
  cmake -B build \
    -D CMAKE_BUILD_TYPE=None \
    -D CMAKE_INSTALL_PREFIX=/usr \
    -D CMAKE_CURRENT_BINARY_DIR=/usr \
    -D BUILD_SHARED=ON \
    -D BUILD_STATIC=OFF \
    -D ENABLE_CPACK=OFF \
    -D ZMQ_BUILD_TESTS=ON \
    -D WITH_OPENPGM=OFF \
    -D OPENPGM_PKGCONFIG_NAME=openpgm-5.3 \
    -D WITH_LIBBSD=ON \
    -D WITH_DOC=ON \
    -W no-dev
  cmake --build build -j${numjobs}
  cd doc
  for FILE in ./*.txt; do
    asciidoc \
      -d manpage \
      -b docbook \
      -f asciidoc.conf \
      -azmq_version=${pkgver} \
      "${FILE}"
    xmlto man "${FILE%.txt}.xml"
  done
  cd ..
  DESTDIR=${pkgdir} cmake --install build

# manpages
  install -vDm644 -t ${pkgdir}/usr/share/man/man3 doc/*.3
  install -vDm644 -t ${pkgdir}/usr/share/man/man7 doc/*.7
}
