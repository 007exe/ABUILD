# ABUILD generated by mkpkg_generator.sh

pkgname=vim
_basever=7.4
_srcver=74
pkgver=7.4.273
pkgbuild=1
arch=('auto')

shortdesc=('Vi IMproved')
longdesc=('Vim is an almost compatible version of the UNIX editor vi. Many new features have been added: multi level undo, command line history, filename completion, block operations, and more. Vim development is led by Bram Moolenaar. This package also contains the Exuberant Ctags program written by Darren Hiebert.')

tags=('app-editors console')

CTAGSVER=5.8
source=("ftp://ftp.vim.org/pub/vim/unix/vim-${_basever}.tar.bz2"
"http://citylan.dl.sourceforge.net/project/ctags/ctags/$CTAGSVER/ctags-$CTAGSVER.tar.gz n")

build_deps='acl attr gpm glibc-solibs lftp rsync python perl gtk+2 lua'

PYVER=$(python -V 2>&1 | cut -f 2 -d' ' | cut -f 1-2 -d.)
config_files="usr/share/vim/vimrc"
pkglist="gvim"

BASE_CONFIG="--prefix=/usr \
  --enable-pythoninterp \
  --with-python-config-dir=/usr/lib${LIBDIRSUFFIX}/python$PYVER/config \
  --enable-perlinterp \
  --disable-tclinterp \
  --enable-multibyte \
  --enable-cscope \
  --with-features=huge \
  --enable-acl \
  --enable-gpm \
  --enable-perlinterp \
  --enable-luainterp \
  --disable-rubyinterp \
  --disable-python3interp \
  --disable-netbeans \
  --with-compiledby='AgiliaLinux'"

BUILD_SYSTEM="autotools"
BUILD_KEYS="$BASE_CONFIG --without-x --disable-gui"
INSTALL_KEYS="VIMRCLOC=/etc DESTDIR=$pkgdir"

build_ctags() {
  # Build CTAGS
  pushd $srcdir
  tar xf ${srcache}/ctags-$CTAGSVER.tar.gz 
  cd $srcdir/ctags-$CTAGSVER
  CFLAGS="$SLKCFLAGS" LDFLAGS="$SLKLDFLAGS" ./configure --prefix=/usr
  make -j${numjobs} || make
  install -Dm0755 ctags $pkgdir/usr/bin/ctags
  install -Dm0644 ctags.1 $pkgdir/usr/man/man1/ctags.1
  popd
}

before_build() {
  echo "VIM version: $pkgver"
  build_ctags

  cd ${srcdir}/vim${_srcver}

  # Read vimrc and gvimrc from /etc/vim
  sed -i 's|^.*\(#define SYS_.*VIMRC_FILE.*"\) .*$|\1|' src/feature.h
  sed -i 's|^.*\(#define VIMRC_FILE.*"\) .*$|\1|' src/feature.h

  (cd src && autoconf)
  (cd .. && cp -r vim${_srcver} gvim${_srcver})
}


after_build() {
  cd ${srcdir}/vim${_srcver}

  rsync -lprvt $pkgdir/usr/share/man/ $pkgdir/usr/man/
  rm -r $pkgdir/usr/share/man

  cp -a runtime/vimrc_example.vim runtime/vimrc.new

  # Don't make backups in /var/spool/cron/*, which fixes "crontab -e":
  zcat $filedir/vim.vimrc.diff.gz | patch -p1 --verbose

  # Add patched vimrc to the package:
  cat runtime/vimrc.new > $pkgdir/usr/share/vim/vimrc

  # Fix manpage symlinks:
  if [ -d $pkgdir/usr/man ]; then
    ( cd $pkgdir/usr/man
      for manpagedir in $(find . -type d -name "man*") ; do
        ( cd $manpagedir
          for eachpage in $( find . -type l -maxdepth 1) ; do
            ln -s $( readlink $eachpage ).gz $eachpage.gz
            rm $eachpage
          done
          gzip -9 *.?
        )
      done
    )
  fi

  # Legacy binary links:
  for bin in ex rview rvim view eview evim ; do
    ( cd $pkgdir/usr/bin ; rm -rf $bin )
    ( cd $pkgdir/usr/bin ; ln -sf vim $bin )
  done

  install -Dm644 "${srcdir}"/vim${_srcver}/runtime/doc/uganda.txt \
          "${pkgdir}"/usr/share/licenses/${pkgname}/license.txt
}

gvim() {
  pkgname=gvim
  adddep="vim>=${pkgver}"
  shortdesc="GUI for Vim, an improved vi-style text editor"
  tags=('app-editors xapps')
  arch=('auto')
  conflicts="vim-gvim"
}

gvim_prep() {
  cd ${srcdir}/gvim${_srcver}
  ./configure $BASE_CONFIG -with-x=yes --enable-gui=gtk2
  make -j${numjobs}
  make VIMRCLOC=/etc DESTDIR=$pkgdir install

  rm "${pkgdir}"/usr/bin/{ex,view}

  # delete some manpages
  find "${pkgdir}"/usr/share/man -type d -name 'man1' 2>/dev/null | while read _mandir; do
    cd ${_mandir}
    rm -f {ex,view,evim,rview,rvim,vim,vimdiff,vimtutor,xxd}.1
  done

  # Remove files provided by vim package
  rm "$pkgdir"/usr/bin/{eview,evim,gvim,rview,rvim,vimdiff,vimtutor,xxd}
  mv "$pkgdir"/usr/bin/{vim,gvim}
  rm -r "${pkgdir}"/usr/share/vim

  # Fix symlinks
  ( cd "$pkgdir"/usr/bin/
    for bin in $( find . -type l -maxdepth 1) ; do
      rm $bin
      ln -s gvim $bin
    done
  )

  # freedesktop links
  install -Dm644 "${filedir}"/gvim.desktop "${pkgdir}"/usr/share/applications/gvim.desktop
  install -Dm644 runtime/vim48x48.png "${pkgdir}"/usr/share/pixmaps/gvim.png

  # license
  install -Dm644 "${srcdir}"/vim${_srcver}/runtime/doc/uganda.txt \
          "${pkgdir}"/usr/share/licenses/${pkgname}/license.txt
}