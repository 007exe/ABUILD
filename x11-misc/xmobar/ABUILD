pkgname=xmobar
pkgver=0.46
pkgbuild=1
arch=("auto")

shortdesc=("Minimalistic Text Based Status Bar.")

source=("https://codeberg.org/xmobar/xmobar/archive/${pkgver}.tar.gz")

tags=("apps x11-misc")

adddep=("haskell-aeson haskell-timezone-olson haskell-timezone-series
haskell-extensible-exceptions haskell-http-conduit haskell-http-types
libxft libxinerama libxrandr libxpm ghc-libs haskell-x11 pango alsa-lib
haskell-x11-xft haskell-utf8-string haskell-network-uri haskell-hinotify
haskell-dbus haskell-libmpd haskell-cereal haskell-netlink haskell-async
haskell-http-client-tls haskell-alsa-core haskell-alsa-mixer haskell-cairo
haskell-parsec-numbers haskell-regex-compat haskell-old-locale haskell-http
haskell-pango haskell-colour")

build_deps=("${adddep} ghc haskell-hspec haskell-temporary")

# NOTE: Удаляем исходники пакета после сборки
# FIXME: mkpkg не умеет сохранять скачанные файлы под новыми именами, что может приводить к
# ошибкам когда в кеше имеется архив с исходниками от другого пакета с тем же именем
before_build(){
  go_src_dir
  rm -f ${srcache}/${pkgver}.tar.gz
}

build() {
  go_src_dir
  burn_patches
  _flags=(with_xft with_inotify with_mpd with_alsa with_nl80211
          with_datezone with_mpris with_dbus with_xpm with_threaded
          with_rtsopts with_weather)

  runhaskell setup configure -O \
    --enable-shared \
    --enable-executable-dynamic \
    --disable-library-vanilla \
    --prefix=/usr \
    --dynlibdir=/usr/lib \
    --libsubdir=\$compiler/site-local/\$pkgid --ghc-option=-fllvm \
    --ghc-option=-optl-Wl\,-z\,relro\,-z\,now \
    --ghc-option='-pie' \
    --flags="${_flags[*]}" \
    --enable-tests
  runhaskell setup build
  runhaskell setup register --gen-script
  runhaskell setup unregister --gen-script
  sed -i -r -e "s|ghc-pkg.*update[^ ]* |&'--force' |" register.sh
  sed -i -r -e "s|ghc-pkg.*unregister[^ ]* |&'--force' |" unregister.sh

  install -Dm 744 register.sh   ${pkgdir}/usr/share/haskell/register/xmobar.sh
  install -Dm 744 unregister.sh ${pkgdir}/usr/share/haskell/unregister/xmobar.sh
  runhaskell setup copy --destdir=${pkgdir}
  install -Dm 644 license -t ${pkgdir}/usr/share/licenses/${pkgname}
}
