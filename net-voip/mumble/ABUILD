pkgname=mumble
pkglist=("murmur")
pkgver=1.4.287
pkgbuild=1
arch=("auto")

shortdesc=("An Open Source, low-latency, high quality voice chat software.")

source=("https://github.com/mumble-voip/mumble/releases/download/v${pkgver}/mumble-${pkgver}.tar.gz")

tags=("network net-voip")

build_deps=("avahi boost cmake poco protobuf python qt5-tools speech-dispatcher libcap
alsa-lib hicolor-icon-theme jack libpulse libsndfile libspeechd libx11 libxi grpc zeroc-ice
mesa opus qt5-svg speex xdg-utils")

adddep=("hicolor-icon-theme")

build() {
  go_src_dir
  burn_patches
  export PKG_CONFIG_PATH=/usr/lib/openssl-1.1/pkgconfig
  local _build_number="$(cut -d '.' -f 3 <<< "$pkgver")"
  cmake \
    -D CMAKE_INSTALL_PREFIX=/usr \
    -D CMAKE_BUILD_TYPE=None \
    -D BUILD_NUMBER="$_build_number" \
    -D warnings-as-errors=OFF \
    -W no-dev \
    -D bundled-opus=OFF \
    -D bundled-speex=OFF \
    -D update=OFF \
    -D server=OFF \
    -B build-client
  make VERBOSE=1 -C build-client
  make DESTDIR=${pkgdir} install -C build-client
  install -vDm 644 LICENSE -t ${pkgdir}/usr/share/licenses/${pkgname}
}

murmur() {
  pkgname=murmur
  shortdesc=("An Open Source, low-latency, high quality voice chat software (server).")
  config_files=("etc/murmur.ini")
}

murmur_prep() {
  go_src_dir
  export PKG_CONFIG_PATH=/usr/lib/openssl-1.1/pkgconfig
  local _build_number="$(cut -d '.' -f 3 <<< "$pkgver")"
  cmake \
    -D CMAKE_INSTALL_PREFIX=/usr
    -D CMAKE_BUILD_TYPE=None
    -D BUILD_NUMBER="$_build_number"
    -D warnings-as-errors=OFF
    -W no-dev
    -D grpc=ON \
    -D client=OFF \
    -B build-server
  make VERBOSE=1 -C build-server
  make DESTDIR=${pkgdir} install -C build-server
  mv -v ${pkgdir}/usr/bin/{mumble-server,murmurd}
  mv -v ${pkgdir}/usr/share/man/man1/{mumble-server,murmurd}.1
  mv -v ${pkgdir}/usr/share/man/man1/{mumble-server,murmur}-user-wrapper.1
  (
    cd ..
    install -vDm 640 scripts/murmur.ini -t ${pkgdir}/etc
    install -vDm 644 README.md -t ${pkgdir}/usr/share/doc/${pkgname}
    install -vDm 644 LICENSE -t ${pkgdir}/usr/share/licenses/${pkgname}
    install -vDm 644 src/murmur/{Murmur.ice,MurmurRPC.proto} -t ${pkgdir}/usr/share/${pkgname}
  )
  install -vDm 644 ${filedir}/murmur.dbus.conf ${pkgdir}/usr/share/dbus-1/system.d/murmur.conf
  install -vDm 644 ${filedir}/murmur.service -t ${pkgdir}/usr/lib/systemd/system/
  install -vDm 644 ${filedir}/murmur.sysusers ${pkgdir}/usr/lib/sysusers.d/${pkgname}.conf
  install -vDm 644 ${filedir}/murmur.tmpfiles ${pkgdir}/usr/lib/tmpfiles.d/${pkgname}.conf
}
