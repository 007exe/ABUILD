pkgname=dcron
pkgver=4.5
pkgbuild=4
arch=('auto')

shortdesc=("Dillon's Cron daemon")
longdesc=("The cron daemon runs in the background and executes tasks on behalf of users at the appropriate time. Many timed system tasks are started with cron, such as the nightly indexing with updatedb. dcron was written entirely from scratch by Matthew Dillon.")

tags=("base sys-process")

build_deps="glibc-solibs"

source=("http://www.jimpryor.net/linux/releases/dcron-${pkgver}.tar.gz")

build() {
	go_src_dir
	burn_patches

	CFLAGS+="$SLKCFLAGS" make -j${numjobs}
	strip --strip-unneeded crond crontab

	mkdir -p ${pkgdir}/usr/{bin,sbin}
	cat crond > ${pkgdir}/usr/sbin/crond
	cat crontab > ${pkgdir}/usr/bin/crontab
	zcat ${filedir}/run-parts.gz > ${pkgdir}/usr/bin/run-parts
	chmod 0755 ${pkgdir}/usr/sbin/crond
	chmod 4711 ${pkgdir}/usr/bin/crontab
	chmod 0755 ${pkgdir}/usr/bin/run-parts

	mkdir -p ${pkgdir}/usr/man/man{1,8}
	cat crontab.1 | gzip -9c > ${pkgdir}/usr/man/man1/crontab.1.gz
	cat crond.8 | gzip -9c > ${pkgdir}/usr/man/man8/crond.8.gz
	cat ${filedir}/run-parts.8.gz > ${pkgdir}/usr/man/man8/run-parts.8.gz

	# Create some other stuff we need
	mkdir -p ${pkgdir}/etc/cron.{hourly,daily,weekly,monthly}
	mkdir -p ${pkgdir}/var/spool/cron/crontabs
	mkdir -p ${pkgdir}/var/spool/cron/cronstamps
	chmod 0751 ${pkgdir}/var/spool/cron
	chmod 0750 ${pkgdir}/var/spool/cron/crontabs ${pkgdir}/var/spool/cron/cronstamps
	zcat ${filedir}/crontab.root.gz > ${pkgdir}/var/spool/cron/crontabs/root.new
	chmod 0600 ${pkgdir}/var/spool/cron/crontabs/root.new
	# dcron will whine about "unable to scan" this directory, so we'll create it
	mkdir -p ${pkgdir}/etc/cron.d

	mkdir -p ${pkgdir}/usr/doc/dcron-${pkgver}
	cp -a \
		CHANGELOG README \
		extra \
		${pkgdir}/usr/doc/dcron-${pkgver}
	chown -R root:root ${pkgdir}/usr/doc/dcron-${pkgver}/*

	# Adding OpenRC init scripts
	install -Dm755 ${filedir}/dcron.init ${pkgdir}/etc/init.d/cron
	install -Dm644 ${filedir}/dcron.confd ${pkgdir}/etc/conf.d/cron.new

	# Logrotate script
	install -Dm644 ${filedir}/dcron.logrotate ${pkgdir}/etc/logrotate.d/cron

}
