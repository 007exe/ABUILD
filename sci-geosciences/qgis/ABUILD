pkgname=qgis
pkgver=3.32.2
pkgbuild=1
arch=("auto")

shortdesc=("Geographic Information System (GIS) that supports vector, raster & database formats.")

source=("https://qgis.org/downloads/${pkgname}-${pkgver}.tar.bz2")

tags=("apps app-misc")

adddep=("ocl-icd proj geos gdal expat spatialindex qwt libzip sqlite protobuf zlib exiv2
postgresql-libs libspatialite zstd pdal qt5-base qt5-svg qt5-serialport qt5-location qt5-3d
qt5-declarative qt5-multimedia qscintilla-qt5 qtkeychain-qt5 qca-qt5 gsl python-pyqt5 hdf5
python-qscintilla-qt5 netcdf libxml2")

build_deps=("${adddep} cmake ninja opencl-clhpp fcgi qt5-tools sip pyqt-builder")

# NOTE: Это опциональные зависимости
removedep=("fcgi gpsbabel")

build() {
  go_src_dir
  burn_patches
  cmake -B build -G Ninja \
    -DCMAKE_INSTALL_PREFIX='/usr' \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DWITH_3D=TRUE \
    -DWITH_QUICK=TRUE \
    -DWITH_SERVER=TRUE \
    -DWITH_CUSTOM_WIDGETS=TRUE \
    -DBINDINGS_GLOBAL_INSTALL=TRUE \
    -DQGIS_MANUAL_SUBDIR=share/man \
    -DWITH_QTWEBKIT=FALSE \
    -DWITH_QWTPOLAR=TRUE \
    -DQWTPOLAR_LIBRARY=/usr/lib/libqwt.so \
    -DQWTPOLAR_INCLUDE_DIR=/usr/include/qwt \
    -DCMAKE_CXX_FLAGS="${CXXFLAGS} -DQWT_POLAR_VERSION=0x060200" \
    -DWITH_INTERNAL_QWTPOLAR=FALSE \
    -DWITH_PDAL=TRUE \
    -DHAS_KDE_QT5_PDF_TRANSFORM_FIX=TRUE \
    -DHAS_KDE_QT5_SMALL_CAPS_FIX=TRUE \
    -DHAS_KDE_QT5_FONT_STRETCH_FIX=TRUE
  cmake --build build
  DESTDIR=${pkgdir} cmake --install build
  install -Dm644 rpm/sources/qgis-mime.xml ${pkgdir}/usr/share/mime/packages/qgis.xml
}
