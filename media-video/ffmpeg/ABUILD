pkgname=ffmpeg
pkgver=6.0
pkgbuild=1
arch=("auto")

shortdesc=("Complete solution to record, convert and stream audio and video.")

source=("http://ffmpeg.org/releases/${pkgname}-${pkgver}.tar.xz")

tags=("libs media-video")

adddep=("alsa-lib aom bzip2 fontconfig fribidi gmp gnutls gsm jack lame libass libavc1394 libbluray
libbs2b dav1d libdrm freetype libglvnd libiec61883 libjxl libmodplug libopenmpt libpulse rav1e vmaf
librsvg libsoxr libssh libtheora libva libvdpau libvorbis libvpx libwebp libx11 x264 x265 libxcb xz
libxext libxml2 libxv xvidcore zimg ocl-icd onevpl opencore-amr openjpeg2 opus sdl2 speex srt zlib
libraw1394 v4l-utils  vulkan-icd-loader svt-av1 vidstab")

build_deps=("${adddep} amf-headers avisynthplus clang ffnvcodec-headers ladspa mesa nasm opencl-headers
vulkan-headers")

#provides=("libavcodec.so libavdevice.so libavfilter.so libavformat.so libavutil.so libpostproc.so libswresample.so libswscale.so")

# NOTE: Это опциональные зависимости
removedep=("avisynthplus intel-media-sdk onevpl-intel-gpu ladspa nvidia-utils")

build(){
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    --disable-doc \
    --disable-debug \
    --disable-static \
    --disable-stripping \
    --enable-libpulse \
    --enable-librsvg \
    --enable-libiec61883 \
    --enable-libxcb \
    --enable-libsrt \
    --enable-libjack \
    --enable-cuda-llvm \
    --enable-lto \
    --enable-fontconfig \
    --enable-gmp \
    --enable-gnutls \
    --enable-gpl \
    --enable-ladspa \
    --enable-libbluray \
    --enable-libdrm \
    --enable-libgsm \
    --enable-libfreetype \
    --enable-libfribidi \
    --enable-libmodplug \
    --enable-libmp3lame \
    --enable-libopencore_amrnb \
    --enable-libopencore_amrwb \
    --enable-libopenjpeg \
    --enable-libass \
    --enable-libspeex \
    --enable-libssh \
    --enable-libtheora \
    --enable-libopus \
    --enable-libvorbis \
    --enable-libwebp \
    --enable-libx264 \
    --enable-libx265 \
    --enable-libxml2 \
    --enable-shared \
    --enable-version3 \
    --enable-nvdec \
    --enable-nvenc \
    --enable-libxvid \
    --enable-libvpx \
    --enable-libv4l2 \
    --enable-libvidstab \
    --enable-libzimg \
    --enable-amf \
    --enable-libsvtav1 \
    --enable-libaom \
    --enable-libdav1d \
    --enable-librav1e \
    --enable-libvmaf \
    --enable-nonfree \
    --enable-avisynth \
    --enable-libvpl \
    --enable-libopenmpt
#   --enable-libjxl
#   --enable-libsoxr

  make -j${numjobs}
  make tools/qt-faststart -j${numjobs}
  make doc/ff{mpeg,play}.1
  make DESTDIR=${pkgdir} install install-man

  install -Dm 755 tools/qt-faststart ${pkgdir}/usr/bin/
}
