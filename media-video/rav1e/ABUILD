pkgname=rav1e
pkgver=0.4.1
pkgbuild=1
arch=('auto')

shortdesc=("An AV1 encoder focused on speed and safety")
longdesc=("rav1e is an AV1 video encoder. It is designed to eventually cover all use cases, though in its current form it is most suitable for cases where libaom (the reference encoder) is too slow.")

source=("https://github.com/xiph/rav1e/archive/refs/tags/v${pkgver}.tar.gz")

tags="libs media-libs"

build_deps="cargo-c git nasm rust gcc-libs glibc"

build() {
  go_src_dir
  burn_patches
  cargo fetch \
    --locked \
    --manifest-path ./Cargo.toml
  cargo build \
    --release \
    --frozen \
    --manifest-path ./Cargo.toml
  cargo cbuild \
    --release \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --pkgconfigdir=/usr/lib${LIBDIRSUFFIX}/pkgconfig \
    --frozen \
    --prefix=/usr \
    --manifest-path ./Cargo.toml
  cargo install \
    --frozen \
    --offline \
    --no-track \
    --path . \
    --root "${pkgdir}"/usr
  cargo cinstall \
    --release \
    --frozen \
    --prefix /usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --pkgconfigdir=/usr/lib${LIBDIRSUFFIX}/pkgconfig \
    --destdir "${pkgdir}"
  install -Dm 644 LICENSE PATENTS -t "${pkgdir}"/usr/share/licenses/rav1e/
}
