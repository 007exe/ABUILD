pkgname=modemmanager
pkgver=1.20.2
pkgbuild=1
arch=("auto")

shortdesc=("Mobile broadband modem management service.")
longdesc=("ModemManager provides a unified high level API for communicating with mobile broadband modems, regardless of the protocol used to communicate with the actual device.")

source=("https://gitlab.freedesktop.org/mobile-broadband/ModemManager/-/archive/${pkgver}/ModemManager-${pkgver}.tar.gz")

tags=("network net-misc")

build_deps=("gtk-doc gobject-introspection vala meson bash-completion libgudev polkit ppp libqmi libmbim mobile-broadband-provider-info")

adddep=("libgudev polkit ppp libqmi libmbim mobile-broadband-provider-info")

pkglist=("libmm-glib")

build() {
  go_src_dir
  burn_patches
  meson build \
    -D prefix=/usr \
    -D libdir=/usr/lib \
    -D dbus_policy_dir=/usr/share/dbus-1/system.d \
    -D dist_version="\"$pkgver\"" \
    -D gtk_doc=true \
    -D plugin_qcom_soc=disabled \
    -D polkit=permissive \
    -D vapi=true \
    -D systemdsystemunitdir=/tmp   \
    -D systemd_journal=false \
    -D systemd_suspend_resume=false
  meson compile -C build
  meson install -C build --destdir ${pkgdir}

# Удаляем бесполезные сервисы systemd
  rm -r ${pkgdir}/tmp
}

libmm-glib() {
  pkgname=libmm-glib
  shortdesc=("ModemManager library.")
  longdesc=("ModemManager provides a unified high level API for communicating with mobile broadband modems, regardless of the protocol used to communicate with the actual device.")
  adddep=("glib2")
}

libmm-glib_prep() {
  go_src_dir
  mkdir -p ${pkgdir}/usr/{include,lib,share/{gtk-doc/html,vala}}
  mv -fv ${p_pkgdir}/usr/include/ ${pkgdir}/usr
  mv -fv ${p_pkgdir}/usr/lib/girepository-1.0 ${pkgdir}/usr/lib
  mv -fv ${p_pkgdir}/usr/lib/libmm-glib.so* ${pkgdir}/usr/lib
  mv -fv ${p_pkgdir}/usr/lib/pkgconfig ${pkgdir}/usr/lib
  mv -fv ${p_pkgdir}/usr/share/gir-1.0 ${pkgdir}/usr/share
# FIXME: Есть проблемы со сборкой документации
#  mv -fv ${p_pkgdir}/usr/share/gtk-doc/html/libmm-glib ${pkgdir}/usr/share/gtk-doc/html
  mv -fv ${p_pkgdir}/usr/share/vala ${pkgdir}/usr/share
}
