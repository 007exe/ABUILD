pkgname=bullet
pkgver=3.25
pkgbuild=1
arch=('auto')

shortdesc=("A 3D Collision Detection and Rigid Body Dynamics Library for games and animation.")

source=("https://github.com/bulletphysics/bullet3/archive/refs/tags/${pkgver}.tar.gz")

tags=("sci-physics develop")

build_deps=("cmake doxygen graphviz mesa glu python python-numpy python-setuptools ninja")

build() {
  go_src_dir
  burn_patches
  sed -i '/SET_TARGET_PROPERTIES(pybullet PROPERTIES PREFIX/d' examples/pybullet/CMakeLists.txt
  export CXXFLAGS+=" -ffat-lto-objects"
  cmake -B build -G Ninja \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DBUILD_SHARED_LIBS=1 \
    -DINSTALL_LIBS=1 \
    -DINSTALL_EXTRA_LIBS=1 \
    -DBUILD_PYBULLET=ON \
    -DBUILD_PYBULLET_NUMPY=ON \
    -DBUILD_OPENGL3_DEMOS=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DBULLET2_MULTITHREADING=ON \
    -DCMAKE_SKIP_RPATH=YES
  ninja -C build
  python setup.py build
  doxygen
  DESTDIR=${pkgdir} ninja -C build install
}
