pkgname=snappy
pkgver=1.1.9
_gtest_ver=1.11.0
_benchmark_ver=1.6.0
pkgbuild=1
arch=("auto")

shortdesc=("A fast compressor/decompressor library")
longdesc=("Snappy is a compression/decompression library. It does not aim for maximum compression, or compatibility with any other compression library; instead, it aims for very high speeds and reasonable compression. For instance, compared to the fastest mode of zlib, Snappy is an order of magnitude faster for most inputs, but the resulting compressed files are anywhere from 20% to 100% bigger.")

tags=("libs app-arch")

source=("https://github.com/google/snappy/archive/$pkgver/$pkgname-$pkgver.tar.gz"
"https://github.com/google/googletest/archive/release-$_gtest_ver.tar.gz"
"https://github.com/google/benchmark/archive/v$_benchmark_ver/benchmark-$benchmark_ver.tar.gz")

build_deps="cmake clang gtest benchmark"

before_build(){
  cd $srcdir/snappy-$pkgver
  mv $srcdir/googletest-release-$_gtest_ver/* $srcdir/snappy-$pkgver/third_party/googletest/
  mv $srcdir/benchmark-$_benchmark_ver/* $srcdir/snappy-$pkgver/third_party/benchmark/
# create pkgconfig file
cat << EOF >snappy.pc.in
prefix=/usr
exec_prefix=/usr
libdir=/usr/lib${LIBDIRSUFFIX}
includedir=/usr/include

Name: snappy
Description: Fast compressor/decompressor library.
Version: $pkgver
Libs: -L/usr/lib${LIBDIRSUFFIX} -lsnappy
Cflags: -I/usr/include
EOF
  burn_patches
}

build() {
  cd $srcdir/snappy-$pkgver
# compile without assertions
  CXXFLAGS+=\ -DNDEBUG
# export CXX=clang++
  cmake \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR=/usr/lib${LIBDIRSUFFIX} \
    -DBUILD_SHARED_LIBS=yes \
    -DSNAPPY_USE_BUNDLED_GTEST=OFF \
    -DSNAPPY_USE_BUNDLED_BENCHMARK_LIB=OFF \
    .
  make -j${numjobs}
  make DESTDIR="$pkgdir" install
  install -m644 -D COPYING "$pkgdir/usr/share/licenses/snappy/LICENSE"
}
