pkgname=postgresql
pkglist=("postgresql-libs postgresql-docs")
pkgver=16.0
pkgbuild=1
arch=("auto")

shortdesc=("Sophisticated object-relational DBMS.")

tags=("server dev-db")

source=("https://ftp.postgresql.org/pub/source/v${pkgver}/postgresql-${pkgver}.tar.bz2")

dep_postgresql_libs=("krb5 openssl readline zlib openldap")
# --with-systemd systemd
adddep=("krb5 libxml2 readline openssl linux-pam icu openldap llvm-libs libxslt lz4 zstd")

build_deps=("${adddep} ${dep_postgresql_libs} python perl tcl llvm clang util-linux")

# NOTE: Это опциональные зависимости
removedep=("python perl tcl postgresql-old-upgrade logrotate")

config_files=("etc/logrotate.d/postgresql
etc/conf.d/postgresql")

build() {
  go_src_dir
  burn_patches
  CFLAGS+=" -ffat-lto-objects"
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    --mandir=/usr/share/man \
    --datadir=/usr/share/postgresql \
    --sysconfdir=/etc \
    --with-gssapi \
    --with-libxml \
    --with-openssl \
    --with-perl \
    --with-python \
    --with-tcl \
    --with-pam \
    --with-readline \
    --with-system-tzdata=/usr/share/zoneinfo \
    --with-uuid=e2fs \
    --with-icu \
    --with-ldap \
    --with-libxslt \
    --with-lz4 \
    --with-zstd \
    --enable-nls \
    --enable-thread-safety \
    --disable-rpath \
    --disable-static \
    --without-llvm
# FIXMI: Не собирается с LLVM --with-llvm

  make world -j${numjobs}
  make DESTDIR=${pkgdir} install
  make -C contrib DESTDIR=${pkgdir} install
  make -C doc/src/sgml DESTDIR=${pkgdir} install-man

  for dir in src/interfaces src/bin/pg_config src/bin/pg_dump src/bin/psql src/bin/scripts; do
    make -C ${dir} DESTDIR=${pkgdir} uninstall
  done
  for util in pg_config pg_dump pg_dumpall pg_restore psql \
      clusterdb createdb createuser dropdb dropuser pg_isready reindexdb vacuumdb; do
    rm ${pkgdir}/usr/share/man/man1/${util}.1
  done

  install -Dm 644 COPYRIGHT -t ${pkgdir}/usr/share/licenses/${pkgname}

  cd ${srcdir}
  install -Dm 755 ${filedir}/postgresql-check-db-dir -t ${pkgdir}/usr/bin
  install -Dm 644 ${filedir}/postgresql.pam ${pkgdir}/etc/pam.d/postgresql
  install -Dm 644 ${filedir}/postgresql.logrotate ${pkgdir}/etc/logrotate.d/postgresql

  install -Dm 644 ${filedir}/postgresql.service -t ${pkgdir}/usr/lib/systemd/system
  install -Dm 644 ${filedir}/postgresql.sysusers ${pkgdir}/usr/lib/sysusers.d/postgresql.conf
  install -Dm 644 ${filedir}/postgresql.tmpfiles ${pkgdir}/usr/lib/tmpfiles.d/postgresql.conf

# openrc
  install -Dm0755 ${filedir}/postgresql.init ${pkgdir}/etc/init.d/postgresql
  install -Dm0755 ${filedir}/postgresql.conf.d ${pkgdir}/etc/conf.d/postgresql

  rm -rf ${pkgdir}/usr/include/postgresql/internal
  rm -rf ${pkgdir}/usr/include/libpq
  find ${pkgdir}/usr/include -maxdepth 1 -type f -execdir rm {} +
  rmdir ${pkgdir}/usr/share/doc/postgresql/html
}

# postgresql-libs #######################################################

postgresql-libs() {
  pkgname=postgresql-libs
  shortdesc=("Libraries for use with PostgreSQL.")
  tags=("libs dev-db")
  adddep=("${dep_postgresql_libs} postgresql-libs>=${pkgver}")
}

postgresql-libs_prep() {
  cd ${srcdir}/postgresql-${pkgver}
  install -Dm 644 COPYRIGHT -t ${pkgdir}/usr/share/licenses/${pkgname}

  for dir in src/interfaces src/bin/pg_config src/bin/pg_dump src/bin/psql src/bin/scripts; do
    make -C ${dir} DESTDIR=${pkgdir} install
  done

  for util in pg_config pg_dump pg_dumpall pg_restore psql \
      clusterdb createdb createuser dropdb dropuser pg_isready reindexdb vacuumdb; do
    install -Dm 644 doc/src/sgml/man1/${util}.1 ${pkgdir}/usr/share/man/man1/${util}.1
  done

  cd src/include

  install -d ${pkgdir}/usr/include/{libpq,postgresql/internal/libpq}

  install -m 644 pg_config.h ${pkgdir}/usr/include
  install -m 644 pg_config_os.h ${pkgdir}/usr/include
  install -m 644 pg_config_ext.h ${pkgdir}/usr/include
  install -m 644 postgres_ext.h ${pkgdir}/usr/include
  install -m 644 libpq/libpq-fs.h ${pkgdir}/usr/include/libpq
  install -m 644 pg_config_manual.h ${pkgdir}/usr/include

  install -m 644 c.h ${pkgdir}/usr/include/postgresql/internal
  install -m 644 port.h ${pkgdir}/usr/include/postgresql/internal
  install -m 644 postgres_fe.h ${pkgdir}/usr/include/postgresql/internal
  install -m 644 libpq/pqcomm.h ${pkgdir}/usr/include/postgresql/internal/libpq

}

# postgresql-docs ###################################################################################################

postgresql-docs() {
  pkgname=postgresql-docs
  shortdesc=("HTML documentation for PostgreSQL.")
  arch=("noarch")
}

postgresql-docs_prep() {
  cd ${srcdir}/postgresql-${pkgver}

  install -Dm 644 COPYRIGHT -t ${pkgdir}/usr/share/licenses/${pkgname}

  make -C doc/src/sgml DESTDIR=${pkgdir} install-html
  chown -R root:root ${pkgdir}/usr/share/doc/postgresql/html

  rmdir ${pkgdir}/usr/share/man/man{1,3,7}
  rmdir ${pkgdir}/usr/share/man
}
