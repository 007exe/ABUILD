pkgname=openldap
pkgver=2.4.58
pkgbuild=1
arch=("auto")

shortdesc="LDAP servers and sample clients"
longdesc="OpenLDAP is an open source suite of LDAP (Lightweight Directory Access Protocol) applications and development tools.  The suite includes a stand-alone LDAP server (slapd) which is in the -servers package, libraries for implementing the LDAP protocol (in the lib packages), and utilities, tools, and sample clients (in the -clients package). The openldap binary package includes only configuration files used by the libraries."

tags=("network net-misc compat32")

source=("http://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-${pkgver}.tgz")
config_files="etc/openldap/ldap.conf
etc/conf.d/slapd
etc/openldap/slapd.ldif
etc/openldap/slapd.conf"

build_deps="groff libtool cyrus-sasl e2fsprogs util-linux-ng tcp_wrappers chrpath unixodbc"

before_build() {
  go_src_dir
  burn_patches
  sed -i 's|-m 644 $(LIBRARY)|-m 755 $(LIBRARY)|' libraries/{liblber,libldap,libldap_r}/Makefile.in
  sed -i 's|#define LDAPI_SOCK LDAP_RUNDIR LDAP_DIRSEP "run" LDAP_DIRSEP "ldapi"|#define LDAPI_SOCK LDAP_DIRSEP "run" LDAP_DIRSEP "openldap" LDAP_DIRSEP "ldapi"|' include/ldap_defaults.h
  sed -i 's|%LOCALSTATEDIR%/run|/run/openldap|' servers/slapd/slapd.{conf,ldif}
  sed -i 's|-$(MKDIR) $(DESTDIR)$(localstatedir)/run|-$(MKDIR) $(DESTDIR)/run/openldap|' servers/slapd/Makefile.in
}

build() {
  go_src_dir
  autoconf
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --sysconfdir=/etc \
    --localstatedir=/var/lib/openldap \
    --sbindir=/usr/bin \
    --enable-proctitle \
    --enable-cleartext \
    --enable-lmpasswd \
    --enable-perl \
    --enable-shell \
    --enable-ldap \
    --enable-slapd \
    --enable-dynacl \
    --enable-aci \
    --enable-rewrite \
    --enable-rlookups \
    --enable-slapi \
    --enable-wrappers \
    --enable-dynamic \
    --enable-syslog \
    --enable-ipv6 \
    --enable-local \
    --enable-crypt \
    --enable-spasswd \
    --enable-modules \
    --enable-backends \
    --enable-slapd \
    --disable-ndb \
    --disable-sql \
    --disable-static \
    --disable-debug \
    --enable-overlays=mod \
    --with-tls \
    --with-cyrus-sasl \
    --with-threads
  make -j${numjobs}
  make DESTDIR=${pkgdir} install
}
after_build() {
# get rid of duplicate default conf files
  rm "${pkgdir}"/etc/openldap/*.default
  cat << EOF >> ${pkgdir}/etc/openldap/ldap.conf

# In order to avoid problems with self-signed certificates using TLS:
# "TLS certificate verification: Error, self signed certificate"
# See also 'man ldap.conf' or http://www.openldap.org/doc/admin/tls.html
TLS_REQCERT allow

EOF

  install -Dm0755 ${filedir}/slapd-initd ${pkgdir}/etc/init.d/slapd
  install -Dm0644 ${filedir}/slapd-confd ${pkgdir}/etc/conf.d/slapd
}
