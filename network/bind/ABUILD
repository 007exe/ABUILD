pkgname=bind
pkgver=9.17.13
pkgbuild=1
arch=('auto')

url="https://www.isc.org/bind/"

shortdesc="A DNS (Domain Name System) server"
longdesc="BIND (Berkeley Internet Name Domain) is an implementation of the DNS (domain Name System) protocols. BIND includes a DNS server (named), which resolves host names to IP addresses, and a resolver library (routines for applications to use when interfacing with DNS).  A DNS server allows clients to name resources or objects and share the information with other network machines.  The named DNS server can be used on workstations as a caching name server, but is generally only needed on one machine for an entire network.  Note that the configuration files for making BIND act as a simple caching nameserver are included in the caching-nameserver package. "

tags=('net-dns network')
source=("http://ftp.isc.org/isc/bind9/${pkgver}/bind-${pkgver}.tar.xz");

build_deps="openssl glibc libuv libidn2 libnghttp2 python-pygments python-ply python-babel python-jinja"

adddeps="python-ply"

build() {
  go_src_dir
  burn_patches
  export CFLAGS
# support to chase DNSSEC signature chains
  CFLAGS+=' -DDIG_SIGCHASE'
# compile with gcc10, https://gcc.gnu.org/gcc-10/porting_to.html
  CFLAGS+=' -fcommon'

  ./configure \
    --prefix=/usr \
    --sbindir=/usr/bin \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --with-libtool \
    --enable-shared \
    --disable-static \
    --enable-threads \
    --with-libxml2 \
    --with-python=/usr/bin/python3 \
    --enable-fixed-rrset \
    --enable-full-report \
    --with-json-c \
    --with-libidn2 \
    --with-openssl
  make -j${numjobs}
  make DESTDIR=${pkgdir} install
}

after_build() {
  go_src_dir
  set -e
# We like symlinks.
  ( cd $pkgdir/usr/bin
       ln -sf named lwresd
  )

# Add /var/run/named directory:
  mkdir -p $pkgdir/var/run/named

# Fix library perms:
  chmod 755 $pkgdir/usr/lib${LIBDIRSUFFIX}/*

# Add sample config files for a simple caching nameserver:
  mkdir -p $pkgdir/var/named/caching-example
  cat $filedir/caching-example/named.conf > $pkgdir/etc/named.conf.new
  cat $filedir/caching-example/localhost.zone > $pkgdir/var/named/caching-example/localhost.zone
  cat $filedir/caching-example/named.local > $pkgdir/var/named/caching-example/named.local
  cat $filedir/caching-example/named.root > $pkgdir/var/named/caching-example/named.root
# This name is deprecated, but having it here doesn't hurt in case
# an old configuration file wants it:
  cat $filedir/caching-example/named.root > $pkgdir/var/named/caching-example/named.ca

# Add OpenRC scripts
  mkdir -p $pkgdir/etc/conf.d
  install -m644 $filedir/conf.d/named $pkgdir/etc/conf.d/named.new
  mkdir -p $pkgdir/etc/init.d
  install -m755 $filedir/init.d/named $pkgdir/etc/init.d/named
  set +e
}
