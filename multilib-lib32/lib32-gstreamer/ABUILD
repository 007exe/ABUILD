pkgname=lib32-gstreamer
pkglist=("lib32-gst-plugins-base-libs lib32-gst-plugins-base lib32-gst-plugins-good")
pkgver=1.20.4
strict_version=1
pkgbuild=1
arch=("auto")

shortdesc=("Multimedia graph framework (32-bit).")

source=("git:https://gitlab.freedesktop.org/gstreamer/gstreamer.git")

tags=("lib32 media-libs")

build_deps=("meson git wayland-protocols lib32-glib2 lib32-libunwind lib32-gtk3 lib32-libelf lib32-alsa-lib
lib32-cdparanoia lib32-libtheora lib32-libvisual lib32-libxv lib32-opus lib32-orc lib32-pango lib32-sdl2
lib32-aalib lib32-cairo lib32-flac lib32-gdk-pixbuf2 lib32-jack lib32-libavc1394 lib32-libcaca lib32-libdv
lib32-libgudev lib32-libiec61883 lib32-libpulse lib32-libraw1394 lib32-libshout lib32-libsoup3 lib32-libvpx
lib32-libxdamage lib32-mpg123 lib32-speex lib32-taglib lib32-twolame lib32-v4l-utils lib32-wavpack
lib32-libxml2 gstreamer lib32-libvorbis")

adddep=("lib32-libxml2 lib32-glib2 lib32-libunwind lib32-gtk3 lib32-libelf gstreamer")

_install() {
  local src dir
  for src in "${files[@]}"; do
    dir="$pkgdir/$(dirname "$src")"
    mkdir -p "$dir"
    mv -v "$src" "$dir"
  done
}

# NOTE: Переходим к коммиту
# FIXME: mkpkg не умеет самостоятельно переключаться по веткам и коммитам
before_build() {
  go_src_dir
  git checkout ${pkgver}
}

build() {
  go_src_dir
  burn_patches
# Фикс линковки с orc
  sed -i "s/get_option('orc')/false/" meson.build

# Отключаем тесты
  sed -i "/subdir('tests')/d" subprojects/{gst-editing-services,gstreamer-vaapi}/meson.build
  sed -i "/subdir('testsuite')/d" subprojects/gst-python/meson.build
  sed -i "/'gst\/rtspserver'/d" subprojects/gst-rtsp-server/tests/check/meson.build

# Исправляем неправельные префиксы
# https://github.com/mesonbuild/meson/issues/5482
  sed -i 's/-DPREFIX/-UPREFIX/' subprojects/gst-plugins-good/gst/deinterlace/meson.build

  meson build \
    -D prefix=/usr \
    -D libdir=/usr/lib32 \
    -D devtools=disabled \
    -D doc=disabled \
    -D examples=disabled \
    -D gpl=enabled \
    -D gst-examples=disabled \
    -D libnice=disabled \
    -D vaapi=enabled \
    -D gstreamer:dbghelp=disabled \
    -D gstreamer:gobject-cast-checks=disabled \
    -D gstreamer:package-name="AgiliaLinux gstreamer" \
    -D gstreamer:ptp-helper-permissions=capabilities \
    -D gst-plugins-base:gobject-cast-checks=disabled \
    -D gst-plugins-base:package-name="AgiliaLinux gst-plugins-base" \
    -D gst-plugins-base:tremor=disabled \
    -D gst-plugins-good:gobject-cast-checks=disabled \
    -D gst-plugins-good:package-name="AgiliaLinux gst-plugins-good" \
    -D gst-plugins-good:rpicamsrc=disabled \
    -D gst-plugins-bad:directfb=disabled \
    -D gst-plugins-bad:flite=disabled \
    -D gst-plugins-bad:gobject-cast-checks=disabled \
    -D gst-plugins-bad:gs=disabled \
    -D gst-plugins-bad:iqa=disabled \
    -D gst-plugins-bad:isac=disabled \
    -D gst-plugins-bad:magicleap=disabled \
    -D gst-plugins-bad:onnx=disabled \
    -D gst-plugins-bad:openh264=disabled \
    -D gst-plugins-bad:openni2=disabled \
    -D gst-plugins-bad:opensles=disabled \
    -D gst-plugins-bad:package-name="AgiliaLinux gst-plugins-bad" \
    -D gst-plugins-bad:tinyalsa=disabled \
    -D gst-plugins-bad:voaacenc=disabled \
    -D gst-plugins-bad:voamrwbenc=disabled \
    -D gst-plugins-bad:wasapi2=disabled \
    -D gst-plugins-bad:wasapi=disabled \
    -D gst-plugins-ugly:gobject-cast-checks=disabled \
    -D gst-plugins-ugly:package-name="Arch Linux gst-plugins-ugly" \
    -D gst-libav:package-name="AgiliaLinux gst-libav" \
    -D gst-rtsp-server:gobject-cast-checks=disabled \
    -D gst-rtsp-server:package-name="AgiliaLinux gst-rtsp-server" \
    -D gst-editing-services:validate=disabled
  meson compile -C build
  DESTDIR=${srcdir}/root meson install -C build

  rm -R ${srcdir}/root/usr/{share,include}

  for _i in ${srcdir}/root/usr/bin/*; do
    mv "${_i}" "${_i}-32"
  done

  cd ${srcdir}/root; local files=(
    usr/lib32/libgst{reamer,base,check,controller,net}-1.0.so*
    usr/lib32/pkgconfig/gstreamer{,-base,-check,-controller,-net}-1.0.pc

    usr/lib32/gstreamer-1.0/gst-ptp-helper
    usr/lib32/gstreamer-1.0/gst-{hotdoc-plugins,plugin}-scanner
    usr/lib32/gstreamer-1.0/gst-plugins-doc-cache-generator
    usr/lib32/gstreamer-1.0/libgstcoreelements.so
    usr/lib32/gstreamer-1.0/libgstcoretracers.so

    usr/bin/gst-{inspect,launch,stats,tester,typefind}-1.0-32
  ); _install
}

###############################################################################

lib32-gst-plugins-base-libs() {
  pkgname=lib32-gst-plugins-base-libs
  shortdesc=("Multimedia graph framework - base.")
  tags=("lib32 media-plugins")
  adddep=("lib32-gstreamer lib32-orc lib32-libxv")
}

lib32-gst-plugins-base_prep() {

  cd ${srcdir}/root; local files=(
    usr/lib32/libgst{allocators,app,audio,fft,gl,pbutils,riff,rtp,rtsp,sdp,tag,video}-1.0.so*
    usr/lib32/pkgconfig/gstreamer-{allocators,app,audio,fft,gl{,-egl,-prototypes,-wayland,-x11},pbutils,riff,rtp,rtsp,sdp,tag,video}-1.0.pc

    usr/lib32/pkgconfig/gstreamer-plugins-base-1.0.pc
    usr/lib32/gstreamer-1.0/include/gst/gl/gstglconfig.h
    usr/lib32/gstreamer-1.0/libgstadder.so
    usr/lib32/gstreamer-1.0/libgstapp.so
    usr/lib32/gstreamer-1.0/libgstaudioconvert.so
    usr/lib32/gstreamer-1.0/libgstaudiomixer.so
    usr/lib32/gstreamer-1.0/libgstaudiorate.so
    usr/lib32/gstreamer-1.0/libgstaudioresample.so
    usr/lib32/gstreamer-1.0/libgstaudiotestsrc.so
    usr/lib32/gstreamer-1.0/libgstcompositor.so
    usr/lib32/gstreamer-1.0/libgstencoding.so
    usr/lib32/gstreamer-1.0/libgstgio.so
    usr/lib32/gstreamer-1.0/libgstoverlaycomposition.so
    usr/lib32/gstreamer-1.0/libgstpbtypes.so
    usr/lib32/gstreamer-1.0/libgstplayback.so
    usr/lib32/gstreamer-1.0/libgstrawparse.so
    usr/lib32/gstreamer-1.0/libgstsubparse.so
    usr/lib32/gstreamer-1.0/libgsttcp.so
    usr/lib32/gstreamer-1.0/libgsttypefindfunctions.so
    usr/lib32/gstreamer-1.0/libgstvideoconvert.so
    usr/lib32/gstreamer-1.0/libgstvideorate.so
    usr/lib32/gstreamer-1.0/libgstvideoscale.so
    usr/lib32/gstreamer-1.0/libgstvideotestsrc.so
    usr/lib32/gstreamer-1.0/libgstvolume.so
    usr/lib32/gstreamer-1.0/libgstximagesink.so
    usr/lib32/gstreamer-1.0/libgstxvimagesink.so

    usr/bin/gst-{device-monitor,discoverer,play}-1.0-32
  ); _install
}

###############################################################################

lib32-gst-plugins-base() {
  pkgname=lib32-gst-plugins-base
  shortdesc=("Multimedia graph framework - base plugins")
  tags=("lib32 media-plugins")
  adddep=("lib32-gst-plugins-base-libs=${pkgver} lib32-alsa-lib lib32-cdparanoia lib32-libvisual lib32-libvorbis lib32-libtheora lib32-pango lib32-opus")
}

lib32-gst-plugins-base_prep() {

    cd ${srcdir}/root; local files=(
    usr/lib32/gstreamer-1.0/libgstalsa.so
    usr/lib32/gstreamer-1.0/libgstcdparanoia.so
    usr/lib32/gstreamer-1.0/libgstlibvisual.so
    usr/lib32/gstreamer-1.0/libgstogg.so
    usr/lib32/gstreamer-1.0/libgstopengl.so
    usr/lib32/gstreamer-1.0/libgstopus.so
    usr/lib32/gstreamer-1.0/libgstpango.so
    usr/lib32/gstreamer-1.0/libgsttheora.so
    usr/lib32/gstreamer-1.0/libgstvorbis.so
  ); _install
}

###############################################################################

lib32-gst-plugins-good() {
  pkgname=lib32-gst-plugins-good
  shortdesc=("Multimedia graph framework - good plugins.")
  tags=("lib32 media-plugins")
  adddep=("lib32-libpulse lib32-jack lib32-libsoup3 lib32-gst-plugins-base-libs lib32-wavpack
           lib32-aalib lib32-taglib lib32-libdv lib32-libshout lib32-libvpx lib32-gdk-pixbuf2
           lib32-libcaca lib32-libavc1394 lib32-libiec61883 lib32-libxdamage lib32-v4l-utils
           lib32-cairo lib32-libgudev lib32-speex lib32-flac lib32-libraw1394 lib32-mpg123
           lib32-twolame gst-plugins-good")
}

lib32-gst-plugins-good_prep() {

    cd root; local files=(
    usr/lib32/gstreamer-1.0/libgst1394.so
    usr/lib32/gstreamer-1.0/libgstaasink.so
    usr/lib32/gstreamer-1.0/libgstalaw.so
    usr/lib32/gstreamer-1.0/libgstalpha.so
    usr/lib32/gstreamer-1.0/libgstalphacolor.so
    usr/lib32/gstreamer-1.0/libgstapetag.so
    usr/lib32/gstreamer-1.0/libgstaudiofx.so
    usr/lib32/gstreamer-1.0/libgstaudioparsers.so
    usr/lib32/gstreamer-1.0/libgstauparse.so
    usr/lib32/gstreamer-1.0/libgstautodetect.so
    usr/lib32/gstreamer-1.0/libgstavi.so
    usr/lib32/gstreamer-1.0/libgstcacasink.so
    usr/lib32/gstreamer-1.0/libgstcairo.so
    usr/lib32/gstreamer-1.0/libgstcutter.so
    usr/lib32/gstreamer-1.0/libgstdebug.so
    usr/lib32/gstreamer-1.0/libgstdeinterlace.so
    usr/lib32/gstreamer-1.0/libgstdtmf.so
    usr/lib32/gstreamer-1.0/libgstdv.so
    usr/lib32/gstreamer-1.0/libgsteffectv.so
    usr/lib32/gstreamer-1.0/libgstequalizer.so
    usr/lib32/gstreamer-1.0/libgstflac.so
    usr/lib32/gstreamer-1.0/libgstflv.so
    usr/lib32/gstreamer-1.0/libgstflxdec.so
    usr/lib32/gstreamer-1.0/libgstgdkpixbuf.so
    usr/lib32/gstreamer-1.0/libgstgoom.so
    usr/lib32/gstreamer-1.0/libgstgoom2k1.so
    usr/lib32/gstreamer-1.0/libgsticydemux.so
    usr/lib32/gstreamer-1.0/libgstid3demux.so
    usr/lib32/gstreamer-1.0/libgstimagefreeze.so
    usr/lib32/gstreamer-1.0/libgstinterleave.so
    usr/lib32/gstreamer-1.0/libgstisomp4.so
    usr/lib32/gstreamer-1.0/libgstjack.so
    usr/lib32/gstreamer-1.0/libgstjpeg.so
    #usr/lib32/gstreamer-1.0/libgstlame.so
    usr/lib32/gstreamer-1.0/libgstlevel.so
    usr/lib32/gstreamer-1.0/libgstmatroska.so
    usr/lib32/gstreamer-1.0/libgstmonoscope.so
    usr/lib32/gstreamer-1.0/libgstmpg123.so
    usr/lib32/gstreamer-1.0/libgstmulaw.so
    usr/lib32/gstreamer-1.0/libgstmultifile.so
    usr/lib32/gstreamer-1.0/libgstmultipart.so
    usr/lib32/gstreamer-1.0/libgstnavigationtest.so
    usr/lib32/gstreamer-1.0/libgstoss4.so
    usr/lib32/gstreamer-1.0/libgstossaudio.so
    usr/lib32/gstreamer-1.0/libgstpng.so
    usr/lib32/gstreamer-1.0/libgstpulseaudio.so
    usr/lib32/gstreamer-1.0/libgstreplaygain.so
    usr/lib32/gstreamer-1.0/libgstrtp.so
    usr/lib32/gstreamer-1.0/libgstrtpmanager.so
    usr/lib32/gstreamer-1.0/libgstrtsp.so
    usr/lib32/gstreamer-1.0/libgstshapewipe.so
    usr/lib32/gstreamer-1.0/libgstshout2.so
    usr/lib32/gstreamer-1.0/libgstsmpte.so
    usr/lib32/gstreamer-1.0/libgstsoup.so
    usr/lib32/gstreamer-1.0/libgstspectrum.so
    usr/lib32/gstreamer-1.0/libgstspeex.so
    usr/lib32/gstreamer-1.0/libgsttaglib.so
    usr/lib32/gstreamer-1.0/libgsttwolame.so
    usr/lib32/gstreamer-1.0/libgstudp.so
    usr/lib32/gstreamer-1.0/libgstvideo4linux2.so
    usr/lib32/gstreamer-1.0/libgstvideobox.so
    usr/lib32/gstreamer-1.0/libgstvideocrop.so
    usr/lib32/gstreamer-1.0/libgstvideofilter.so
    usr/lib32/gstreamer-1.0/libgstvideomixer.so
    usr/lib32/gstreamer-1.0/libgstvpx.so
    usr/lib32/gstreamer-1.0/libgstwavenc.so
    usr/lib32/gstreamer-1.0/libgstwavpack.so
    usr/lib32/gstreamer-1.0/libgstwavparse.so
    usr/lib32/gstreamer-1.0/libgstximagesrc.so
    usr/lib32/gstreamer-1.0/libgsty4menc.so
  ); _install
}
