pkgname=npm
pkgver=8.19.2
pkgbuild=1
arch=("auto")

shortdesc=("A package manager for javascript.")

source=("https://github.com/npm/cli/archive/v${pkgver}.tar.gz")

tags=("develop dev-java")

adddep=("nodejs node-gyp nodejs-nopt semver")

build_deps=("${adddep} npm procps-ng python marked marked-man libxi")

build() {
  go_src_dir
  sed -i 's|node bin/npm-cli.js run resetdeps|true|' Makefile
  node . i --ignore-scripts --no-audit --no-fund
  NODE_PATH=/usr/lib/node_modules make
  node bin/npm-cli.js install -g -f --prefix=${pkgdir}/usr $(node bin/npm-cli.js pack | tail -1)
  chmod -R u=rwX,go=rX ${pkgdir}
  chown -R root:root ${pkgdir}
  _npmdir=${pkgdir}/usr/lib/node_modules/$pkgname
  rm -r ${_npmdir}/node_modules/{,.bin/}semver
  rm -r ${_npmdir}/node_modules/{,.bin/}node-gyp
  rm -r ${_npmdir}/node_modules/{,.bin/}nopt
  sed -i 's|../../node_modules/node-gyp/bin/node-gyp.js|../../../node-gyp/bin/node-gyp.js|' ${_npmdir}/bin/node-gyp-bin/node-gyp
  install -dm755 ${pkgdir}/usr/share/bash-completion/completions
  node bin/npm-cli.js completion > ${pkgdir}/usr/share/bash-completion/completions/npm

  mv ${pkgdir}/usr/lib/node_modules/npm/man ${pkgdir}/usr/share/

  install -Dm644 LICENSE -t ${pkgdir}/usr/share/licenses/${pkgname}/
}
