pkgname=cfitsio
pkgver=4.0.0
pkgbuild=1
arch=('auto')

shortdesc=("A library of C and Fortran subroutines for reading and writing data files in FITS (Flexible Image Transport System) data format")
longdesc=("CFITSIO is a library of C and Fortran subroutines for reading and writing data files in FITS (Flexible Image Transport System) data format.")

source=("https://heasarc.gsfc.nasa.gov/FTP/software/fitsio/c/cfitsio-$pkgver.tar.gz")

tags="dev-libs libs"

build_deps="curl gcc-fortran bzip2 zlib"

build() {
  go_src_dir
  burn_patches
# Fix LDFLAGS
  sed -e 's|LDFLAGS=.*|LDFLAGS="$LDFLAGS"|g' -i configure.in
# Fix setting rights during installation.
  sed -e 's|/bin/cp -a $$lib|/bin/cp $$lib|g' -i Makefile.in
  autoreconf -vi
  ./configure \
    --prefix=/usr \
    --enable-reentrant \
    --with-bzip2 \
    --enable-sse2 \
    --enable-ssse3 \
    --enable-hera \
    --libdir=/usr/lib${LIBDIRSUFFIX}
  make -j${numjobs} shared
  make -j${numjobs} utils

  LD_LIBRARY_PATH=. ./testprog > testprog.lis
  [[ -z $(diff testprog.lis testprog.out) ]] || return 1
  [[ -z $(cmp testprog.fit testprog.std) ]] || return 1

  make DESTDIR="$pkgdir" install

  install -D -m644 License.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE

# Fix conflicts with ccfits and smem
  rm "$pkgdir"/usr/bin/{cookbook,smem,testprog}
}
