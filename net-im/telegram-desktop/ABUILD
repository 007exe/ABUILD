pkgname=telegram-desktop
pkgver=4.11.3
pkgbuild=1
arch=("auto")

shortdesc=("Official Telegram Desktop client.")

source=("https://github.com/telegramdesktop/tdesktop/releases/download/v${pkgver}/tdesktop-${pkgver}-full.tar.gz"
"https://download.gnome.org/sources/glibmm/2.77/glibmm-2.77.0.tar.xz")

tags=("apps net-im")

adddep=("hunspell ffmpeg hicolor-icon-theme lz4 minizip openal ttf-opensans qt6-imageformats qt6-svg
qt6-wayland xxhash rnnoise pipewire libxtst libxrandr jemalloc abseil-cpp libdispatch openssl protobuf
glib2 libsigc++-3.0")

build_deps=("${adddep} cmake ninja python range-v3 microsoft-gsl meson extra-cmake-modules wayland-protocols
plasma-wayland-protocols libtg_owt gobject-introspection boost fmt mm-common perl-xml-parser tl-expected")

# NOTE: Это опциональные зависимости
removedep=("webkit2gtk xdg-desktop-portal")

build() {
  cd ${srcdir}

  CXXFLAGS+=' -ffat-lto-objects'
  meson setup -D maintainer-mode=true --default-library static --prefix ${srcdir}/glibmm glibmm-2.77.0 glibmm-build
  meson compile -C glibmm-build
  meson install -C glibmm-build

  export PKG_CONFIG_PATH=${srcdir}/glibmm/usr/local/lib/pkgconfig
  cmake -B build tdesktop-${pkgver}-full -G Ninja \
    -DCMAKE_VERBOSE_MAKEFILE=ON \
    -DCMAKE_INSTALL_PREFIX="/usr" \
    -DCMAKE_PREFIX_PATH=${srcdir}/glibmm \
    -DCMAKE_BUILD_TYPE=Release \
    -DTDESKTOP_API_ID=611335 \
    -DTDESKTOP_API_HASH=d524b414d21f4d37f08684c1df41ac9c
  cmake --build build
  DESTDIR=${pkgdir} cmake --install build
}
