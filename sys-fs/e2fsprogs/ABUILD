pkgname=e2fsprogs
pkgver=1.46.4
pkgbuild=2
arch=("auto")

shortdesc=("Utilities used for ext2/ext3/ext4 filesystems")
longdesc=("The e2fsprogs package contains a number of utilities for creating, checking, modifying and correcting any inconsistencies in ext2, ext3, and ext4 filesystems.  E2fsprogs contains e2fsck (used to repair filesystem inconsistencies after an unclean shutdown), mke2fs (used to initialize a partition to contain an empty ext2 filesystem), debugfs (used to examine the internal structure of a filesystem, to manually repair a corrupted filesystem or to create test cases for e2fsck), tune2fs (used to modify filesystem parameters), resize2fs to grow and shrink unmounted filesystems, and most of the other core ext2fs filesystem utilities.")

tags="base sys-fs"

source=("https://www.kernel.org/pub/linux/kernel/people/tytso/${pkgname}/v${pkgver}/${pkgname}-${pkgver}.tar.gz")

build_deps="util-linux-ng pkg-config"

config_files="etc/mke2fs.conf"

build() {
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --bindir=/usr/bin \
    --sbindir=/sbin \
    --libdir=/lib${LIBDIRSUFFIX} \
    --with-udev-rules-dir=/lib/udev/rules.d \
    --with-root-prefix="" \
    --enable-elf-shlibs \
    --disable-libblkid \
    --disable-libuuid \
    --disable-uuidd \
    --disable-fsck
  make -j${numjobs}
# regenerate locale files
  find po/ -name '*.gmo' -delete
  make -C po update-gmo
}


after_build() {
  go_src_dir
  make DESTDIR=${pkgdir} install install-libs || exit 1
  mkdir -p ${pkgdir}/usr/lib${LIBDIRSUFFIX}
  mv ${pkgdir}/lib${LIBDIRSUFFIX}/pkgconfig ${pkgdir}/lib${LIBDIRSUFFIX}/*.so ${pkgdir}/usr/lib${LIBDIRSUFFIX}
  ( cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
    for i in *.so ; do
        ln -sf /lib${LIBDIRSUFFIX}/$(readlink $i) $i ;
    done
  )

  ( cd ${pkgdir}/sbin
    rm -f mkfs.ext2 mkfs.ext3 mkfs.ext4 mkfs.ext4dev fsck.ext2 fsck.ext3 fsck.ext4dev e2label
    ln -sf mke2fs mkfs.ext2
    ln -sf mke2fs mkfs.ext3
    ln -sf mke2fs mkfs.ext4
    ln -sf mke2fs mkfs.ext4dev
    ln -sf tune2fs e2label
    cat << EOF > fsck.ext2
#!/bin/sh
exec /sbin/e2fsck -C 0 \$*
EOF

    chmod 0755 fsck.ext2
# Why won't symlinks work here?  --RW
# Because $0 will always be "fsck.ext2" in that case.  --PJV
    cp -a fsck.ext2 fsck.ext3
    cp -a fsck.ext2 fsck.ext4
    cp -a fsck.ext2 fsck.ext4dev
  )

  ( cd ${pkgdir}/usr/share/man/man8
    rm -f fsck.ext2.8 fsck.ext3.8 mkfs.ext2.8 mkfs.ext3.8 mkfs.ext4.8 mkfs.ext4dev.8
    ln -sf e2fsck.8 fsck.ext2.8
    ln -sf e2fsck.8 fsck.ext3.8
    ln -sf e2fsck.8 fsck.ext4.8
    ln -sf e2fsck.8 fsck.ext4dev.8
    ln -sf mke2fs.8 mkfs.ext2.8
    ln -sf mke2fs.8 mkfs.ext3.8
    ln -sf mke2fs.8 mkfs.ext4.8
    ln -sf mke2fs.8 mkfs.ext4dev.8
  )
}
