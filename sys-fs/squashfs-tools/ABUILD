pkgname=squashfs-tools
pkgver=4.6.1
pkgbuild=1
arch=("auto")

shortdesc=("Tools for squashfs, a highly compressed read-only filesystem for Linux.")

source=("https://github.com/plougher/squashfs-tools/archive/refs/tags/${pkgver}.tar.gz")

tags=("sys-fs console")

build_deps=("zlib lzo xz lz4")

# NOTE: Удаляем исходники пакета после сборки
# FIXME: mkpkg не умеет сохранять скачанные файлы под новыми именами, что может приводить к
# ошибкам когда в кеше имеется архив с исходниками от другого пакета с тем же именем
before_build(){
  go_src_dir
  rm -f ${srcache}/${pkgver}.tar.gz
}

build() {
  cd ${srcdir}
  local make_options=(
    GZIP_SUPPORT=1
    LZ4_SUPPORT=1
    LZMA_XZ_SUPPORT=1
    LZO_SUPPORT=1
    XATTR_SUPPORT=1
    XZ_SUPPORT=1
    ZSTD_SUPPORT=1
    -C $pkgname-$pkgver/$pkgname
  )
  make "${make_options[@]}"

  local make_install_options=(
    INSTALL_PREFIX="$pkgdir/usr"
    INSTALL_MANPAGES_DIR='$(INSTALL_PREFIX)/share/man/man1'
    install
    -C $pkgname-$pkgver/$pkgname
  )
  make "${make_install_options[@]}"
  install -vDm 644 ${pkgname}-${pkgver}/{ACTIONS-README,CHANGES,"README-$pkgver",USAGE*} -t ${pkgdir}/usr/share/doc/${pkgname}
}
