pkgname=fpc
pkgver=3.2.2
pkgbuild=2
arch=('auto')

shortdesc=("Free Pascal Compiler, Turbo Pascal 7.0 and Delphi compatible.")
longdesc=("The Free Pascal Compiler is a Turbo Pascal 7.0 and Delphi compatible 32bit Pascal Compiler. It comes with fully TP 7.0 compatible run-time library. Some extensions are added to the language, like function overloading. Shared libraries can be linked. Basic Delphi support is already implemented (classes, exceptions,ansistrings,RTTI). This package contains commandline compiler and utils. Provided units are the runtime library (RTL), free component library (FCL), gtk, ncurses, zlib, mysql, postgres, ibase bindings.")

source=("https://downloads.sourceforge.net/project/freepascal/Source/$pkgver/fpcbuild-$pkgver.tar.gz")

tags="develop dev-lang"

build_deps="fpc ncurses zlib expat binutils make"

config_files="etc/fpc.cfg"

pkglist="fpcsrc"

fpcsrc() {
  pkgname=fpc-src
  arch=('noarch')
  shortdesc=("Sources for the FreePascal compiler (required by the Lazarus IDE)")
  longdesc=("Sources for the FreePascal compiler (required by the Lazarus IDE)")
  custom_opts="skip_gendeps"
}

before_build(){
  go_src_dir
  burn_patches
# Может лучше применять make clean для очистки исходников вместо копирования
  cp -r fpcsrc ..
}

build() {
  go_src_dir
  pushd fpcsrc/compiler
  fpcmake -r -Tall
  popd
  make NOGDB=1

# Install FPC
  export HOME="$srcdir"

  make -j1 PREFIX="$pkgdir"/usr install NOGDB=1

  export PATH="$pkgdir"/usr/bin:$PATH

  mv ${pkgdir}/usr/lib ${pkgdir}/usr/lib${LIBDIRSUFFIX}

  ln -s /usr/lib${LIBDIRSUFFIX}/fpc/${pkgver}/ppcx64 ${pkgdir}/usr/bin/

  mkdir -p "$pkgdir"/etc
  "$pkgdir"/usr/lib${LIBDIRSUFFIX}/fpc/${pkgver}/samplecfg "$pkgdir"/usr/lib${LIBDIRSUFFIX}/fpc/${pkgver} "$pkgdir"/etc

# use -fPIC by default
  echo -e "#ifdef cpux86_64\n# for x86_64 use -fPIC by default\n-Cg\n#endif" >> "$pkgdir/etc/fpc.cfg"

  mv "$pkgdir"/usr/man "$pkgdir"/usr/share/

  find "$pkgdir"/etc/ -type f -exec sed -i "s|"$pkgdir"||g" {} \;

  install -Dm0644 fpcsrc/rtl/COPYING.FPC "$pkgdir"/usr/share/licenses/${pkgname}/COPYING.FPC
}

fpcsrc_prep() {
#  go_src_dir
#  cd fpcsrc
#  make clean
  cd ${srcdir}/fpcsrc
  mkdir -p "$pkgdir"/usr/lib${LIBDIRSUFFIX}/fpc/src
  cp -R . "$pkgdir"/usr/lib${LIBDIRSUFFIX}/fpc/src
}
