pkgname=tcl
pkgver=8.6.12
pkgbuild=1
arch=("auto")

shortdesc=("Tool Command Language, pronounced tickle")
longdesc=("Tcl is a simple scripting language designed to be embedded into other applications.  Tcl is designed to be used with Tk, a widget set, which is provided in the tk package. This package also includes tclsh, a simple example of a Tcl application.")

tags=("dev-lang tcl compat32")

source=("http://downloads.sourceforge.net/sourceforge/tcl/tcl${pkgver}-src.tar.gz")

build_deps="glibc zlib"

build() {
  go_src_dir
  cd unix
  rm -rf pkgs/sqlite3*

# Fix hardcoded lib location
  sed -i "/TCL_LIBRARY='\$(prefix)/ s/lib/lib$LIBDIRSUFFIX/" ./configure
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib$LIBDIRSUFFIX \
    --mandir=/usr/share/man \
    --enable-threads \
    --enable-64bit
  make -j${numjobs}
#  make test
  make INSTALL_ROOT="${pkgdir}" install install-private-headers

  ln -sf tclsh${pkgver%.*} "${pkgdir}/usr/bin/tclsh"
  ln -sf libtcl${pkgver%.*}.so "${pkgdir}/usr/lib$LIBDIRSUFFIX/libtcl.so"
  install -Dm644 ../license.terms "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  install -Dm644 tcl.m4 -t "$pkgdir"/usr/share/aclocal
  chmod 644 "$pkgdir/usr/lib$LIBDIRSUFFIX/libtclstub8.6.a"

# remove buildroot traces
  _tclver=8.6
  sed -e "s#${srcdir}/tcl${pkgver}/unix#/usr/lib#" \
      -e "s#${srcdir}/tcl${pkgver}#/usr/include#" \
      -e "s#'{/usr/lib} '#'/usr/lib$LIBDIRSUFFIX/tcl$_tclver'#" \
      -i "${pkgdir}/usr/lib$LIBDIRSUFFIX/tclConfig.sh"

tdbcver=tdbc1.1.3
  sed -e "s#${srcdir}/tcl${pkgver}/unix/pkgs/$tdbcver#/usr/lib$LIBDIRSUFFIX/$tdbcver#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$tdbcver/generic#/usr/include#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$tdbcver/library#/usr/lib$LIBDIRSUFFIX/tcl${pkgver%.*}#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$tdbcver#/usr/include#" \
      -i "${pkgdir}/usr/lib$LIBDIRSUFFIX/$tdbcver/tdbcConfig.sh"

  itclver=itcl4.2.2
  sed -e "s#${srcdir}/tcl${pkgver}/unix/pkgs/$itclver#/usr/lib$LIBDIRSUFFIX/$itclver#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$itclver/generic#/usr/include#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$itclver#/usr/include#" \
      -i "${pkgdir}/usr/lib$LIBDIRSUFFIX/$itclver/itclConfig.sh"
}
