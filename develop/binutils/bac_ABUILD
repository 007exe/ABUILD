# ABUILD generated by mkpkg_generator.sh

pkgname=binutils
pkgver=2.35
pkgbuild=1
arch=("auto")

shortdesc=("binutils (GNU binary development tools)")

build_deps="glibc-solibs zlib gcc bison"

tags=("develop sys-devel")
source=("http://ftp.gnu.org/gnu/binutils/binutils-${pkgver}.tar.bz2")

build() {
	go_src_dir
	burn_patches

  # Turn off development mode (-Werror, gas run-time checks, date in sonames)
  sed -i '/^development=/s/true/false/' bfd/development.sh

  # hack! - libiberty configure tests for header files using "$CPP $CPPFLAGS"
  sed -i "/ac_cpp=/s/\$CPPFLAGS/\$CPPFLAGS -O2/" libiberty/configure

	CFLAGS="$SLKCFLAGS $CFLAGS" \
		./configure \
		--prefix=/usr \
		--libdir=/usr/lib${LIBDIRSUFFIX} \
		--with-lib-path=/usr/lib${LIBDIRSUFFIX}:/usr/local/lib \
		--enable-lto \
		--enable-plugins \
		--enable-relro \
		--disable-gdb \
		--disable-werror \
		--with-pic \
		--with-system-zlib \
		--enable-deterministic-archives \
		--mandir=/usr/share/man \
		--infodir=/usr/info \
		--with-docdir=/usr/share/doc/binutils-${pkgver} \
		--enable-shared \
		--enable-threads \
		--enable-ld=default \
		--enable-gold \
		$( [ "$ARCH" = "x86_64" ] && echo --enable-64-bit-bfd ) \
		$( [ "$ARCH" = "x86_64" ] && echo --disable-multilib ) \
		--enable-targets=$ARCH-slackware-linux \
		$WERROR \
		--build=$ARCH-slackware-linux 

	make clean
	make -j${numjobs} || make
	make install DESTDIR=${pkgdir}

	  # Rebuild libiberty.a with -fPIC
	make -C libiberty clean
	make CFLAGS="$CFLAGS -fPIC" -C libiberty
	install -m644 libiberty/libiberty.a ${pkgdir}/usr/lib${LIBDIRSUFFIX}

	# Rebuild libbfd.a with -fPIC
	make -C bfd clean
	# hidden visability prevent 3rd party shared libraries exporting bfd non-stable API
	make CFLAGS="$CFLAGS -fPIC -fvisibility=hidden" -C bfd
	install -m644 bfd/libbfd.a ${pkgdir}/usr/lib${LIBDIRSUFFIX}

	# "make install" skips this, but binutils.spec doesn't.  Sneaky, huh?
	cp -a include/libiberty.h ${pkgdir}/usr/include/libiberty.h
	
	# Differentiate between BSD strings and GNU strings
	( cd ${pkgdir}/usr/bin ; mv strings strings-GNU )
	( cd ${pkgdir}/usr/share/man/man1 ; mv strings.1 strings-GNU.1 )
	
	# Move ldscripts to /usr/lib${LIBDIRSUFFIX}, and then put symlinks in place
	mv ${pkgdir}/usr/${ARCH}-slackware-linux/lib/ldscripts ${pkgdir}/usr/lib${LIBDIRSUFFIX}
	( cd ${pkgdir}/usr/${ARCH}-slackware-linux
		ln -s /usr/lib${LIBDIRSUFFIX}/ldscripts lib/ldscripts
		for FILE in ar as ld nm objcopy objdump ranlib strip ; do
			if [ -r "/usr/bin/$FILE" ]; then
				rm -f bin/$FILE
				ln -s /usr/bin/$FILE bin/$FILE
			fi
		done
	)
      
	# Remove some unneeded man pages
	rm -f ${pkgdir}/usr/man/share/man1/{dlltool,windres}.1
	mkdir -p ${pkgdir}/usr/share/doc/binutils-${pkgver}

	# Someone wants strings binary
	ln -s strings-GNU ${pkgdir}/usr/bin/strings
}
