pkgname=binutils
pkgver=2.37
pkgbuild=1
arch=("auto")

shortdesc="GNU Binary Utility Development Utilities"
longdesc="A set of programs to assemble and manipulate binary and object files"

build_deps="glibc zlib gcc bison"

tags="develop sys-devel"

source=("http://ftp.gnu.org/gnu/binutils/binutils-${pkgver}.tar.bz2")

build() {
  go_src_dir
  burn_patches

# Turn off development mode (-Werror, gas run-time checks, date in sonames)
  sed -i '/^development=/s/true/false/' bfd/development.sh

# hack! - libiberty configure tests for header files using "$CPP $CPPFLAGS"
  sed -i "/ac_cpp=/s/\$CPPFLAGS/\$CPPFLAGS -O2/" libiberty/configure

  CFLAGS="$SLKCFLAGS $CFLAGS" \
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --mandir=/usr/share/man \
    --infodir=/usr/share/info \
    --with-docdir=/usr/share/doc \
    --enable-shared \
    --enable-threads \
    --enable-ld=default \
    --enable-gold \
    --enable-64-bit-bfd \
    --enable-multilib \
    --enable-lto \
    --enable-plugins \
    --enable-relro \
    --enable-targets=x86_64-pep \
    --disable-gdb \
    --disable-werror \
    --enable-multilib \
    --with-system-zlib

  make configure-host
  make tooldir=/usr

  # unset LDFLAGS as testsuite makes assumptions about which ones are active
  # ignore failures in gold testsuite...
  make -k LDFLAGS="" check || true
}

after_build() {
  go_src_dir
  make DESTDIR=${pkgdir} install

# Remove unwanted files
  rm -f "$pkgdir"/usr/share/man/man1/{dlltool,nlmconv,windres,windmc}*
}
