# ABUILD generated by mkpkg_generator.sh

pkgname=perl
pkgver=5.32.0
_baseversion="${pkgver%.*}"
pkgbuild=3
arch=("auto")

shortdesc=("perl (Practical Extraction and Report Language)")
longdesc=("Larry Wall's 'Practical Extraction and Report Language'. Perl is a language optimized for scanning arbitrary text files, extracting information from those text files, and printing reports based on that information. It's also a good language for many system management tasks. The language is intended to be practical (easy to use, efficient, complete) rather than beautiful (tiny, elegant, minimal).")

tags=("dev-lang develop")

source=("http://www.cpan.org/src/5.0/perl-${pkgver}.tar.xz")

build_deps="gdbm db coreutils glibc-solibs"

build() {
  go_src_dir
  burn_patches

   if [ "${CARCH}" = "x86_64" ]; then
    # for x86_64
    arch_opts="-Dcccdlflags='-fPIC'"
   else
    # for i686
    arch_opts=""
   fi

  CFLAGS="${SLKCFLAGS}"
  ./Configure -des -Dusethreads -Duseshrplib -Doptimize="${CFLAGS}" \
                   -Dprefix=/usr -Dvendorprefix=/usr \
                   -Dprivlib=/usr/share/perl5/core_perl \
                   -Darchlib=/usr/lib${LIBDIRSUFFIX}/perl5/$_baseversion/core_perl \
                   -Dsitelib=/usr/share/perl5/site_perl \
                   -Dsitearch=/usr/lib${LIBDIRSUFFIX}/perl5/$_baseversion/site_perl \
                   -Dvendorlib=/usr/share/perl5/vendor_perl \
                   -Dvendorarch=/usr/lib${LIBDIRSUFFIX}/perl5/$_baseversion/vendor_perl \
                   -Dscriptdir=/usr/bin/core_perl \
                   -Dsitescript=/usr/bin/site_perl \
                   -Dvendorscript=/usr/bin/vendor_perl \
                   -Dinc_version_list=none \
                   -Dman1ext=1perl -Dman3ext=3perl ${arch_opts} \
                   -Dlddlflags="-shared ${LDFLAGS}" -Dldflags="${LDFLAGS}" \
                   -Dmyuname="agilialinux" \
                   -Dmyhostname="agilialinux" \
                   -Dpager="/usr/bin/less -isR"  \
                   -Dcf_time="`date -u --date="@${SOURCE_DATE_EPOCH:-$(date +%s)}"`"

  make -j${numjobs}
  make DESTDIR=$pkgdir install

  ### Perl Settings ###
  # Change man page extensions for site and vendor module builds.
  # Set no mail address since bug reports should go to the bug tracker
  # and not someone's email.
  sed -e '/^man1ext=/ s/1perl/1p/' -e '/^man3ext=/ s/3perl/3pm/' \
      -e "/^cf_email=/ s/'.*'/''/" \
      -e "/^perladmin=/ s/'.*'/''/" \
      -i "${pkgdir}/usr/lib${LIBDIRSUFFIX}/perl5/$_baseversion/core_perl/Config_heavy.pl"

  ### CPAN Settings ###
  # Set CPAN default config to use the site directories.
  sed -e '/(makepl_arg =>/   s/""/"INSTALLDIRS=site"/' \
      -e '/(mbuildpl_arg =>/ s/""/"installdirs=site"/' \
      -i "${pkgdir}/usr/share/perl5/core_perl/CPAN/FirstTime.pm"

  # Profile script to set paths to perl scripts.
  install -D -m755 "${filedir}/perlbin.sh" \
                   "${pkgdir}/etc/profile.d/perlbin.sh"
  # Profile script to set paths to perl scripts on csh. (FS#22441)
  install -D -m755 "${filedir}/perlbin.csh" \
                  "${pkgdir}/etc/profile.d/perlbin.csh"                  
  # Profile script to set paths to perl scripts on fish. (FS#51191)
  install -D -m 755 "${filedir}/perlbin.fish" \
                  "${pkgdir}/usr/share/fish/vendor_conf.d/perlbin.fish"

  sed -e "s|{LIBDIR}|"${LIBDIRSUFFIX}"|g" -i "${pkgdir}"/etc/profile.d/perlbin.sh \
      -i "${pkgdir}"/etc/profile.d/perlbin.csh

  ##(cd ${pkgdir}/usr/bin; mv perl${pkgver} perl)
  (cd ${pkgdir}/usr/bin/core_perl;  ln -sf c2ph pstruct; ln -sf s2p psed)
  #grep -Rl "${pkgdir}" ${pkgdir}/usr | \
  #     xargs sed -i "s^${pkgdir}^^g"

  # Remove all pod files *except* those under /usr/share/perl5/core_perl/pod/
  # (FS#16488)
  rm -f ${pkgdir}/usr/share/perl5/core_perl/*.pod
  for d in ${pkgdir}/usr/share/perl5/core_perl/*; do
      if [ -d ${d} -a $(basename $d) != "pod" ]; then
         find ${d} -name *.pod -delete
      fi
  done
  find ${pkgdir}/usr/lib${LIBDIRSUFFIX} -name *.pod -delete
  find ${pkgdir} -name .packlist -delete

  # Add the dirs so new installs will already have them in PATH once they
  # install their first perl programm
  install -d -m755 "$pkgdir/usr/bin/vendor_perl"
  install -d -m755 "$pkgdir/usr/bin/site_perl"

#  find "$pkgdir" -name perllocal.pod -delete
#  find "$pkgdir" -name .packlist -delete
#  find "$pkgdir" -name *.0 -delete
}

