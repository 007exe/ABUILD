pkgname=python-setuptools
pkgver=56.2.0
pkgbuild=1
arch=("auto")

shortdesc="Easily build and distribute Python packages."
longdesc="Download, build, install, upgrade, and uninstall Python packages -- easily! Homepage: http://pypi.python.org/pypi/setuptools"

tags=("dev-python develop")

source=("https://github.com/pypa/setuptools/archive/v${pkgver}.tar.gz")

# It's nonsense to build python-setuptools you need python-setuptools
build_deps="python python-appdirs python-packaging python-setuptools"

adddep="python-appdirs python-packaging"

 export SETUPTOOLS_INSTALL_WINDOWS_SPECIFIC_FILES=0

before_build(){
# https://github.com/pypa/setuptools/issues/2466
  sed -i '/ignore:lib2to3 package is deprecated:DeprecationWarning/a \    ignore:Creating a LegacyVersion has been deprecated and will be removed in the next major release:DeprecationWarning' \
      setuptools-$pkgver/pytest.ini

# Remove post-release tag since we are using stable tags
  sed -e '/tag_build = .post/d' \
      -e '/tag_date = 1/d' \
      -i setuptools-$pkgver/setup.cfg

# 'Clean' installation is expected to fail since we removed bundled packages
  sed -i '/^def test_clean_env_install/i @pytest.mark.xfail' setuptools-$pkgver/setuptools/tests/test_virtualenv.py

# Tests failed. Importing an unbundled new setuptools in a virtualenv does not work, but this won't
# affect normal virtualenv usage (which don't have to import the unbundled setuptools in *current*
# dir.
  sed -e '/^def test_pip_upgrade_from_source/i @pytest.mark.xfail' \
      -e '/^def test_test_command_install_requirements/i @pytest.mark.xfail' \
      -e '/^def test_no_missing_dependencies/i @pytest.mark.xfail' \
      -i setuptools-$pkgver/setuptools/tests/test_virtualenv.py

  cd "$srcdir"/setuptools-$pkgver
  sed -i -e "s|^#\!.*/usr/bin/env python|#!/usr/bin/env python3|" setuptools/command/easy_install.py
}

build() {
  go_src_dir
  python bootstrap.py
  python setup.py build
  python setup.py install --prefix=/usr --root="$pkgdir" --optimize=1 --skip-build
}
