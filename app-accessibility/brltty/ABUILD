pkgname=brltty
pkgver=6.5
pkgbuild=1
arch=("auto")

shortdesc=("Braille display driver for Linux/Unix.")
longdesc=("Daemon that provides access to the Linux/Unix console for a blind person.")

source=("https://brltty.app/archive/${pkgname}-${pkgver}.tar.bz2")

tags=("accessibility app-accessibility")

# java-environment strip-nondeterminism festival
build_deps=("alsa-lib at-spi2-atk at-spi2-core atk bluez-libs cython dbus
dracut espeak-ng expat gcc-libs glibc glib2 gpm icu liblouis libspeechd
libxaw ncurses ocaml-ctypes ocaml-findlib pcre2 polkit python-setuptools
speech-dispatcher")

build(){
  go_src_dir
  burn_patches
  ./autogen
  CFLAGS+=" -ffat-lto-objects"
  ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --mandir=/usr/share/man \
    --with-scripts-directory=/usr/lib/brltty \
    --with-tables-directory=/usr/share/brltty \
    --with-writable-directory=/run/brltty \
    --enable-gpm \
    --disable-stripping
  make -j1
#  find . -type f -iname "*.jar" -exec strip-nondeterminism {} \;
  make -j1 INSTALL_ROOT=${pkgdir} install
  make -j1 INSTALL_ROOT=${pkgdir} install-systemd
  make -j1 INSTALL_ROOT=${pkgdir} install-udev
  make -j1 INSTALL_ROOT=${pkgdir} install-dracut
  make -j1 INSTALL_ROOT=${pkgdir} install-polkit
  install -vDm 644 Documents/brltty.conf -t ${pkgdir}/etc/
  install -vdm 750 -o root -g 102 ${pkgdir}/usr/share/polkit-1/rules.d
  mkdir ${pkgdir}/etc/init.d
  mkdir ${pkgdir}/etc/conf.d
  install -Dm755 ${filedir}/brltty ${pkgdir}/etc/init.d/
  install -Dm644 ${filedir}/brltty.conf ${pkgdir}/etc/conf.d/brltty.conf
}
