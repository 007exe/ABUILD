pkgname=privoxy
pkgver=3.0.33
pkgbuild=1
arch=("auto")

shortdesc=("A web proxy with advanced filtering capabilities.")

source=("https://downloads.sourceforge.net/ijbswa/${pkgname}-${pkgver}-stable-src.tar.gz")

tags=("net-proxy network")

build_deps=("pcre zlib")

build(){
  go_src_dir
  burn_patches
  autoheader
  autoconf
  ./configure \
    --prefix=/usr \
    --sysconfdir=/etc/privoxy \
    --enable-compression
  make -j${numjobs}
  sed -i '
    s+^confdir \.+confdir /etc/privoxy+
    s+^logdir \.+logdir /var/log/privoxy+
    s+^#\?user-manual .*+user-manual /usr/share/doc/privoxy/user-manual/+' config

# SystemD
  install -Dm644 ${filedir}/privoxy.service ${pkgdir}/usr/lib/systemd/system/privoxy.service
  install -Dm644 ${filedir}/privoxy.sysusers ${pkgdir}/usr/lib/sysusers.d/privoxy.conf
  install -Dm644 ${filedir}/privoxy.logrotate.d ${pkgdir}/etc/logrotate.d/privoxy

  install -Dm755 {,${pkgdir}/usr/bin/}privoxy
  install -Dm644 {,${pkgdir}/usr/share/man/man8/}privoxy.8
  install -d -o42 -g42 ${pkgdir}/var/log/privoxy

  install -d ${pkgdir}/etc/privoxy/
  install -m644 config trust *.{action,filter} ${pkgdir}/etc/privoxy/ # -m0660 upstream
  find templates -type f -exec install -Dm644 '{}' ${pkgdir}/etc/privoxy/'{}' \;

  (d=${pkgdir}/usr/share/doc/privoxy
  cd doc/webserver
  install -Dm644 {privoxy-,"$d"/}index.html
  install -m644 p_doc.css ../../{AUTHORS,README,ChangeLog} "$d"/
  install -Dm644 {,"$d"/user-manual/}p_doc.css
  find user-manual developer-manual faq man-page \( -name '*.html' -o -name '*.jpg' \) -exec install -Dm644 '{}' "$d"/'{}' \;)

# OpenRC
  install -Dm755 ${filedir}/privoxy.initd ${pkgdir}/etc/init.d/privoxy || exit 1

  install -Dm0644 ${filedir}/privoxy.logrotate ${pkgdir}/etc/logrotate.d/privoxy.new || exit 1

  # config
#  if [ -f ${pkgdir}/etc/privoxy/config ]; then
#    mv -v ${pkgdir}/etc/privoxy/config ${pkgdir}/usr/doc/${pkgname}-${pkgver}/config.orig-${pkgver}
#  elif [ -f ${pkgdir}/etc/privoxy/config.new ]; then
#    mv -v ${pkgdir}/etc/privoxy/config.new ${pkgdir}/usr/doc/${pkgname}-${pkgver}/config.orig-${pkgver}
#  fi

  install -m 644 ${filedir}/config.tor ${pkgdir}/etc/privoxy/config.new || exit 1

  find ${pkgdir}/etc/privoxy -name '*.new' -prune -o -type f -exec mv {} {}.new \;

  if [ -f ${pkgdir}/var/log/privoxy/logfile ]; then
    mv -v ${pkgdir}/var/log/privoxy/logfile ${pkgdir}/var/log/privoxy/logfile.new
  fi

#  rmdir -v ${pkgdir}/var/run
}
