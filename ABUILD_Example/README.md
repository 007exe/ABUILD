
## Cценарий сборки пакетов

Процесс сборки пакета описывается с помощью файла, имеющего имя ABUILD который представляет из себя bash-скрипт в нём обьявлены остновные переменные и функции.

### Структура пакета

ABUILD для каждого пакета должен находиться в отдельной директории, рядом с ABUILD могут находится следующие каталоги и файлы files patches doinst.sh postremove.sh preremove.sh всё остальные 
файлы и каталоги будут игнорироваться.

<pre>
pkgname/
    ABUILD
    patches
    files
    doinst.sh
    preremove.sh
    postremove.sh
</pre>

В каталоге patches находятся патчи которые будут применены при вызове фунции burn_patches

В каталоге files находятся дополнительные файлы которые могут быть включены в пакет. Например cp \${filedir\}/filename \${pkgdir\}/../filename

### Пост установочные скрипты

Файлы doinst.sh, preremove.sh и postremove.sh должны находится рядом с ABUILD в процессе сборки оди будут добавленны в пакет.

Порядок выполнения скриптов: 

* После установки пакета выполняется doinst.sh 
* Во время обновления пакета preremove.sh => postremove.sh => doinst.sh 
* Во время удаления пакета preremove.sh => postremove.sh

### Хуки

В каталоге /etc/mpkg/hooks/ находятся системные посттранзакционные хуки.

Хуки являются bash скриптами вызываемые в алфавитном порядке после после всех транзакций (Установки, Удаления или Переустановки пакетов) в не зависимости от того какой пакет устанавливается или
удаляется, если необходимо выполнить хук установки определённого пакета то можно отследит какие файлы были распакованы отследив их можно в /var/mpkg/last_installed_files. 

NOTE: На мой взгляд система хуков mpkg нуждается в пересмотре и доработке.

### Синтаксис ABUILD

Как говорилось рание ABUILD представляет из себя ни что иное, как bash-скрипт. Однако чтобы mkpkg правильно его обработал, он должен соответствовать ряду правил:

* Должны быть определены обязательные переменные (такие как имя пакета, версия, и другие)
* Должно быть описание процесса его сборки определена обязательной функцией build(), описывающая процесс сборки

Традиционно, принято определять обязательные переменные в начале, а функции - в конце.

Основные переменные | Требование | Краткое описание.
:-------------------| :----------| :--------------------
pkgname             | Обязателен | Имя пакета.
pkgver              | Обязателен | Версия программы.
pkgbuild            | Обязателен | Версия пакета (не путать с версией программы).
arch                | Обязателен | Архитектура для которой собирается пакет noarch, auto, x86, x86_64
shortdesc           | Обязателен | Короткое описание пакета на Английском.
longdesc            | Опционелен | Полное описание пакета на Английском.
source              | Опционелен | Ссылки на исходники могут загружаться из нескольких источников с использованием разных протоколов для  http, ftp, https по умолчанию используется wget. При использовании системы контроля версии svn, git, hg, bzr соответствующий протокол должен быть указан через двоеточие git:https://github.com/. При этом к версии программы добавиться префикс _git с датой сборки пакета чтобы избежать этого следует включить опцию strict_version=1
tags                | Обязателен | Короткий и длинный тег. Список доступных тегов находится /usr/share/mpkg/mkpkg/taglist 
build_deps          | Обязателен | Список пакето необходимых для сборки.
provides            | Опционелен | Пакет предоставляет аналогичные функции указанного пакета.
conflicts           | Опционелен | Пакет конфликтует с указанным пакетом.
adddep              | Опционелен | Список пакето воторые будут добавлены как зависимости собираемого пакета. mkpkg автоматически определяет необходимые зависимости но вряде случаев необходимо добавить зависимости в ручную.
removedep           | Опционелен | Список пакетов которые будут удалены из списка зависимосте.
pkglist             | Опционелен | Список пакетов которые будут также собраны. Для их сборки используются дополнительные функции с префиксом _prep например gcc-lib_prep где gcc-lib одно из значений переменной.
gendeps_blacklist   | Опционелен | Список файлов для которых не будут генерироваться зависимости.
config_files        | Опционелен | Список файлов конфигурации перед упаковкой к нему добавится префикс nev, после установки префикс nev будит удалён если этот файл были внесены изменения то при обновлении mpkg предупредит об этом оставит исходный файл без изменений и сохранив новый с префиксом.

Основные функции в теле которых и происходит сборка программы и подготовка к упаковке

Функция             | Требование | Краткое описание.
:-------------------| :----------| :----------
before_build()      | Опционелен | Данная функция вызывается первой после расспаковки архива с исходниками, полезна для подготовки исходников к сборке.
build()             | Обязателен | Основная функция в которой происходит сборка пакета.
after_build()       | Опционелен | Данная функция выполняется последней после всех остальных обьявленных перед упаковкой.
multipkgname()      | Опционелен | Здесь multipkgname задаётся в переменной pkglist. В теле этой функции описываются основные переменные для мультипакета.
multipkgname_prep() | Опционелен | Здесь multipkgname задаётся в переменной pkglist. В теле этой функции происходит сборка дополнительного пакета.

Дополнительные переменные которые могут быть полезны при сборке пакета.

Дополниетельные переменные | Краткое описание.
:--------------------------| :--------------------
${srcache}                 | Каталог кеша исходников сюда загружаются архивы с исходным кодом.
${srcdir}                  | Рабочий каталог каталог в который расспаковывается архив с исходным кодом.
${p_pkgdir}                | Доступ к корневому пакету.
${filedir}                 | Каталог с дополнительными файлами files рассматривался выше.

Опции сборки паета.

Опции пакета     | Краткое описание.
:----------------| :--------------------
strict_version=1 | Используется совмесно с системой контроля версий. По умолчанию выключен, равен 0 (Выключено). Опция задаёт жёсткую версию из pkgver в противном случае при использовании системы контроля версии (git, sun...) к версии пакета будит добавлена префикс с датой сборки 1.5_git20220110.
custom_opts      | Опции skip_validate skip_gendeps no_postperm no_strip

Дополнительные внутренне функции системы сборки пакетов.

Дополниетельные функции | Краткое описание.
:-----------------------| :--------------------
go_src_dir              | Функция для перехода в ${srcdir}/Распаковынный архив исходников (первый каталог если их несколько).
burn_patches            | При вызове данной функции происходи применение патчей из каталога patches.

### Пример ABUILD:

Это простой пример сборки одиночного пакета

```bach
pkgname=alsa-lib
pkgver=1.2.5.1
pkgbuild=1
arch=("auto")

shortdesc=("Config files for Advanced Linux Sound Architecture (ALSA)")

tags=("libs media-libs")

source=("ftp://ftp.alsa-project.org/pub/lib/${pkgname}-${pkgver}.tar.bz2")

build_deps=("glibc")

build(){
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    --without-debug
  make -j${numjobs}
  make DESTDIR=${pkgdir} install
  make DESTDIR="$pkgdir" install -C doc
  install -vDm 644 {MEMORY-LEAK,TODO,NOTES,ChangeLog,doc/asoundrc.txt} -t "${pkgdir}/usr/share/doc/${pkgname}"
}
```
