pkgname=cups
pkgver=2.4.1
pkgbuild=1
arch=("auto")

shortdesc=("The CUPS Printing System - daemon package.")
longdesc=("The Common Unix Printing System (CUPS) is a print spooler and associated utilities. It is based on the Internet Printing Protocol and provides printing services to most PostScript and raster printers.")

source=("https://github.com/OpenPrinting/cups/releases/download/v${pkgver}/cups-${pkgver}-source.tar.gz")

tags=("base net-print")

build_deps=("gnutls libtiff libpng krb5 libusb acl linux-pam bc dbus hicolor-icon-theme gzip autoconf inetutils valgrind xdg-utils cups-filters")

adddep=("hicolor-icon-theme libcups>=${pkgver} cups-filters")

pkglist=("libcups")

config_files=("etc/cups/cupsd.conf
etc/cups/snmp.conf
etc/cups/cups-files.conf
etc/logrotate.d/cups
etc/pam.d/cups
etc/cups/printers.conf
etc/cups/classes.conf
etc/cups/subscriptions.conf")

build() {
  go_src_dir
  burn_patches

  aclocal -I config-scripts
  autoconf -I config-scripts

  export DSOFLAGS=${LDFLAGS}

 sed -i.orig -e 's#$exec_prefix/lib/cups#$libdir/cups#g' configure

  ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --sbindir=/usr/bin \
    --libdir=/usr/lib \
    --disable-systemd \
    --with-logdir=/var/log/cups \
    --with-docdir=/usr/share/cups/doc \
    --with-exe-file-perm=0755 \
    --with-cups-user=209 \
    --with-cups-group=209 \
    --with-max-log-size=0 \
    --enable-pam=yes \
    --enable-raw-printing \
    --enable-dbus=yes \
    --with-dbusdir=/usr/share/dbus-1 \
    --enable-relro \
    --enable-libpaper
  make -j${numjobs}
  make BUILDROOT=${pkgdir} install-data install-exec

  install -D -m644 ${filedir}/cups.logrotate ${pkgdir}/etc/logrotate.d/cups

# PAM
  install -D -m644 ${filedir}/cups.pam ${pkgdir}/etc/pam.d/cups

# OpenRC init
  install -D -m755 ${filedir}/cupsd.init ${pkgdir}/etc/init.d/cupsd

# файлы конфигурации которые заполняет демон cupsd
  touch ${pkgdir}/etc/cups/printers.conf
  touch ${pkgdir}/etc/cups/classes.conf
  touch ${pkgdir}/etc/cups/subscriptions.conf
  chgrp -R 209 ${pkgdir}/etc/cups

  sed -i 's|^Exec=htmlview http://localhost:631/|Exec=xdg-open http://localhost:631/|g' "${pkgdir}"/usr/share/applications/cups.desktop

# Сжимаем файлы драйвкров из Fedora
  find ${pkgdir}/usr/share/cups/model -name "*.ppd" | xargs gzip -n9f

# Удаляем man-страницу client.conf
  rm -f ${pkgdir}/usr/share/man/man5/client.conf.5

# Удаляем каталог из пакета он будит пересоздаваться при каждом старте
  rm -rf ${pkgdir}/run

# Коментируем удаленные фильтры, которые теперь являются частью cups-filters
  perl -p -i -e 's:^(.*\s+bannertops\s*)$:#\1:' ${pkgdir}/usr/share/cups/mime/mime.convs

# Коментируем ненужную запись PageLogFormat
  sed -i -e 's:PageLogFormat:#PageLogFormat:' ${pkgdir}/etc/cups/cupsd.conf*
}

libcups() {
  pkgname=libcups
  shortdesc=("The CUPS Printing System - client libraries and headers")
  longdesc=("The Common Unix Printing System (CUPS) is a print spooler and associated utilities. It is based on the Internet Printing Protocol and provides printing services to most PostScript and raster printers.")
  tags=("libs net-print")
  removedep=("cups-filters e2fsprogs")
}

libcups_prep() {
  go_src_dir
  make BUILDROOT=${pkgdir} install-headers install-libs

# Помещаем это в пакет libs, чтобы другое программы нашли эти библиотеки (файл pkg-config не включен)
  mkdir -p ${pkgdir}/usr/bin
  mv ${p_pkgdir}/usr/bin/cups-config ${pkgdir}/usr/bin/cups-config

  install -m644 -Dt ${pkgdir}/usr/share/licenses/${pkgname} {LICENSE,NOTICE}
}
