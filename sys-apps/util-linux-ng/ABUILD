pkgname=util-linux-ng
pkgver=2.37.2
pkgbuild=2
arch=("auto")

shortdesc=("Miscellaneous system utilities for Linux.")
longdesc=("The Util-linux package contains miscellaneous utility programs. Among them are utilities for handling file systems, consoles, partitions, and messages.")

tags=("base sys-apps")

source=("https://mirrors.edge.kernel.org/pub/linux/utils/util-linux/v2.37/util-linux-${pkgver}.tar.xz")

config_files=("etc/pam.d/chfn
etc/pam.d/chsh
etc/pam.d/login
etc/pam.d/runuser
etc/pam.d/runuser-l
etc/pam.d/su
etc/pam.d/su-l")

build_deps=("eudev linux-pam acl shadow coreutils asciidoctor")

adddep=("coreutils")

build() {
  go_src_dir
  ./configure \
  --prefix=/usr \
  --bindir=/usr/bin \
  --sbindir=/usr/bin \
  --libdir=/lib${LIBDIRSUFFIX} \
  --sysconfdir=/etc \
  --localstatedir=/var \
  --enable-fs-paths-default=/usr/bin:/usr/local/bin \
  --enable-usrdir-path \
  --enable-vipw \
  --enable-newgrp \
  --enable-chfn-chsh \
  --enable-write \
  --enable-mesg \
  --disable-raw \
  --disable-static \
  --disable-hardlink \
  --with-python=3

  make -j${numjobs}
  make DESTDIR=${pkgdir} install

  mv ${pkgdir}/usr/sbin/* ${pkgdir}/usr/bin
# setuid chfn and chsh
  chmod 4755 "$pkgdir"/usr/bin/{newgrp,ch{sh,fn}}

  cd ${pkgdir}/usr/bin
  ln -s hwclock clock
# NOTE: Обратная совместимость
  mkdir -p ${pkgdir}/usr/sbin
  mkdir -p ${pkgdir}/{bin,sbin}
  cp ${pkgdir}/usr/bin/{dmesg,findmnt,kill,login,lsblk,more,mount,mountpoint,readprofile,su,umount,wdctl} ${pkgdir}/bin
  cp ${pkgdir}/usr/bin/{agetty,blkdiscard,blkid,blkzone,blockdev,cfdisk,chcpu,clock,ctrlaltdel,fdisk,findfs,fsck,fsck.cramfs,fsck.minix,fsfreeze,fstrim,hwclock,losetup,mkfs,mkfs.bfs,mkfs.cramfs,mkfs.minix,mkswap,mount,nologin,pivot_root,runuser,sfdisk,sulogin,swaplabel,swapoff,swapon,switch_root,umount,wipefs,zramctl} ${pkgdir}/sbin
  cp ${pkgdir}/usr/bin/{addpart,delpart,ldattach,partx,readprofile,resizepart,rfkill,rtcwake,uuidd,vigr,vipw} ${pkgdir}/usr/sbin

# PAM-файлы для login-utils
  install -Dm0644 "${filedir}/pam.d/chfn" "${pkgdir}/etc/pam.d/chfn"
  install -m0644 "${filedir}/pam.d/chsh" "${pkgdir}/etc/pam.d/chsh"
  install -m0644 "${filedir}/pam.d/login" "${pkgdir}/etc/pam.d/login"
  install -m0644 "${filedir}/pam.d/runuser" "${pkgdir}/etc/pam.d/runuser"
  install -m0644 "${filedir}/pam.d/runuser-l" "${pkgdir}/etc/pam.d/runuser-l"
  install -m0644 "${filedir}/pam.d/su" "${pkgdir}/etc/pam.d/su"
  install -m0644 "${filedir}/pam.d/su-l" "${pkgdir}/etc/pam.d/su-l"

  install -Dm0644 "${filedir}/udev/60-rfkill.rules" "${pkgdir}/lib/udev/rules.d/60-rfkill.rules"
}
