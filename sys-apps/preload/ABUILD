pkgname=preload
pkgver=0.6.4
pkgbuild=1
arch=("auto")

shortdesc=("Makes applications run faster by prefetching binaries and shared objects.")

source=("http://downloads.sourceforge.net/sourceforge/preload/${pkgname}-${pkgver}.tar.gz")

tags=("utils sys-apps")

build_deps=("glib2 bash help2man")

adddep=("bash")

config_files=("etc/preload.conf")

build() {
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    --sysconfdir=/etc \
    --mandir=/usr/share/man \
    --sbindir=/usr/bin \
    --localstatedir=/var \
    --disable-static
  make -j${numjobs}
  make DESTDIR=${pkgdir} sysconfigdir=/etc/conf.d install

# NOTE: Скрипт openrc
  mkdir -p ${pkgdir}/etc/init.d
  install -m755 ${filedir}/preload.init ${pkgdir}/etc/init.d/preload

# NOTE: Скрипт systemd
  install -Dm644 ${filedir}/preload.service ${pkgdir}/usr/lib/systemd/system/preload.service

  rm -rf ${pkgdir}/etc/rc.d
  rm -rf ${pkgdir}/var/lib/preload/preload.state
  rm -rf ${pkgdir}/var/log/preload.log

  sed -r -i 's#^((map|exe)prefix =) (.+)$#\1 /opt;\3#' ${pkgdir}/etc/preload.conf
}
