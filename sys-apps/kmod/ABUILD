pkgname=kmod
pkgver=29
pkgbuild=1
arch=('auto')

shortdesc=("Linux kernel module management tools and library")
longdesc=("The Kmod package contains libraries and utilities for loading kernel modules")

source="https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-$pkgver.tar.xz"

tags="base sys-apps"

build_deps="pkg-config zlib zstd"

build() {
  go_src_dir
  burn_patches
  ./configure \
    --sysconfdir=/etc \
    --prefix=/usr \
    --bindir=/usr/bin \
    --with-rootlibdir=/usr/lib$LIBDIRSUFFIX \
    --libdir=/usr/lib$LIBDIRSUFFIX \
    --with-zlib \
    --with-xz \
    --with-zstd \
    --with-openssl
  make -j${numjobs}
  make DESTDIR=${pkgdir} install
}

after_build() {
  mkdir -p $pkgdir/sbin
  mkdir -p $pkgdir/{etc,lib$LIBDIRSUFFIX}/{depmod,modprobe}.d
  for tool in insmod rmmod depmod lsmod modinfo modprobe; do
    ln -s /usr/bin/kmod "$pkgdir/sbin/$tool"
  done

# install depmod.d file for search/ dir
  install -Dm644 $filedir/search.conf $pkgdir/lib$LIBDIRSUFFIX/depmod.d/search.conf

  if [ -d ${pkgdir}/lib${LIBDIRSUFFIX}/pkgconfig ] ; then
    mkdir -p ${pkgdir}/usr/lib${LIBDIRSUFFIX}
    mv -v ${pkgdir}/lib${LIBDIRSUFFIX}/pkgconfig ${pkgdir}/usr/lib${LIBDIRSUFFIX}/pkgconfig
  fi
}
