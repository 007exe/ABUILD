pkgname=dbus
pkgver=1.12.20
pkgbuild=1
arch=('auto')

shortdesc=("Freedesktop.org message bus system")
longdesc=("D-Bus is a message bus system, a simple way for applications to talk to one another. D-Bus supplies both a system daemon and a per-user-login-session daemon. Also, the message bus is built on top of a general one-to-one message passing framework, which can be used by any two applications to communicate directly.")

tags=('base sys-apps')

build_deps="libaudit libcap-ng expat libaudit xmlto docbook-xsl python yelp-tools doxygen elogind"

source=("http://dbus.freedesktop.org/releases/dbus/dbus-${pkgver}.tar.gz")

config_files="etc/dbus-1/system.conf
etc/dbus-1/session.conf"

build() {
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --enable-user-session \
    --enable-x11-autolaunch \
    --disable-doxygen-docs \
    --disable-xml-docs \
    --disable-static \
    --with-systemduserunitdir=no \
    --with-systemdsystemunitdir=no \
    --with-console-auth-dir=/run/console \
    --with-system-pid-file=/run/dbus/pid \
    --with-system-socket=/run/dbus/system_bus_socket \
    --with-init-scripts=openrc
  make -j${numjobs}
  make DESTDIR=${pkgdir} install

# Fix some directory ownership
  chown messagebus ${pkgdir}/var/lib/dbus

# Add OpenRC scripts
  install -Dm755 $filedir/dbus.init ${pkgdir}/etc/init.d/dbus

# Add socket dir. DBus cannot do it and keep silent about
  mkdir -p ${pkgdir}/run/dbus

  chown -v root:messagebus ${pkgdir}/usr/libexec/dbus-daemon-launch-helper
  chmod -v      4750       ${pkgdir}/usr/libexec/dbus-daemon-launch-helper

  cd ${pkgdir}/etc
  ln -sv /var/lib/dbus/machine-id
}
