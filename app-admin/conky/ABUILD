pkgname=conky
pkgver=1.17.0
pkgbuild=1
arch=("auto")

shortdesc=("Lightweight system monitor for X.")

source=("https://github.com/brndnmtthws/conky/archive/v${pkgver}.tar.gz")

tags=("app-admin utils")

# -D BUILD_NVIDIA=ON libxnvctrl
adddep=("glibc glib2 lua wireless_tools libxdamage libxinerama libxft imlib2 libxml2 libpulse ncurses curl")

# -D BUILD_DOCS=ON pandoc
build_deps=("${adddep} cmake docbook2x docbook-xsl man-db catch python-yaml python-jinja")

build(){
  go_src_dir
  burn_patches
# fix glibc 2.35
  rm -r tests/catch2
  ln -s /usr/include/catch2 tests
  cmake -B build -S . \
    -D CMAKE_BUILD_TYPE=Release \
    -D CMAKE_CXX_FLAGS="$CXXFLAGS -ffat-lto-objects" \
    -D MAINTAINER_MODE=OFF \
    -D BUILD_DOCS=OFF \
    -D BUILD_EXTRAS=ON \
    -D BUILD_WLAN=ON \
    -D BUILD_XDBE=ON \
    -D BUILD_XSHAPE=ON \
    -D BUILD_IMLIB2=ON \
    -D BUILD_CURL=ON \
    -D BUILD_RSS=ON \
    -D BUILD_NVIDIA=OFF \
    -D BUILD_PULSEAUDIO=ON \
    -D BUILD_JOURNAL=ON \
    -D CMAKE_INSTALL_PREFIX=/usr \
    -Wno-dev
  make -C build -j${numjobs}
  make -C build DESTDIR=${pkgdir} install
  install -Dm 644 COPYING -t ${pkgdir}/usr/share/licenses/${pkgname}
  install -Dm 644 build/extras/vim/syntax/conkyrc.vim -t ${pkgdir}/usr/share/vim/vimfiles/syntax
  install -Dm 644 extras/vim/ftdetect/conkyrc.vim -t ${pkgdir}/usr/share/vim/vimfiles/ftdetect
}

# NOTE: Удаляем исходники пакета после сборки
# FIXME: mkpkg не умеет сохранять скачанные файлы под новыми именами, что может приводить к
# ошибкам когда в кеше имеется архив с исходниками от другого пакета с тем же именем
after_build(){
  go_src_dir
  rm ${srcache}/v${pkgver}.tar.gz
}
