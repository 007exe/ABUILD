pkgname=boost
pkgver=1.76.0
_srcname=${pkgver//./_}
pkgbuild=1
arch=('auto')

shortdesc=("Portable C++ libraries")
longdesc=(Boost is a collection of free peer-reviewed portable C++ source libraries. The emphasis is on libraries which work well with the C++ Standard Library. This package contains only the shared libraries needed for running programs using Boost.)

tags="develop dev-libs"

source=("http://downloads.sourceforge.net/sourceforge/${pkgname}/${pkgname}_${_srcname}.tar.bz2")

build_deps="gcc python bzip2 zlib icu zstd"

build() {
  local JOBS="$(sed 's/.*\(-j *[0-9]\+\).*/\1/' <<<$MAKEFLAGS)"

  pushd boost_$_srcname/tools/build
  ./bootstrap.sh --cxxflags="$CXXFLAGS $LDFLAGS"
  ./b2 install --prefix="$srcdir"/fakeinstall
  ln -s b2 "$srcdir"/fakeinstall/bin/bjam
  popd

  cd boost_$_srcname

  ./bootstrap.sh --with-toolset=gcc --with-icu --with-python=python3

# support for OpenMPI
  echo "using mpi ;" >>project-config.jam

# boostbook is needed by quickbook
  install -dm755 "$srcdir"/fakeinstall/share/boostbook
  cp -a tools/boostbook/{xsl,dtd} "$srcdir"/fakeinstall/share/boostbook/

  ./b2 install \
  variant=release \
  debug-symbols=off \
  threading=multi \
  runtime-link=shared \
  link=shared,static \
  toolset=gcc \
  python=3.9 \
  cflags="$CPPFLAGS $CFLAGS -fPIC -O3" \
  cxxflags="$CPPFLAGS $CXXFLAGS -fPIC -O3" \
  --layout=system \
  --without-mpi \
  $JOBS \
  \
  --prefix="$srcdir"/fakeinstall

# boost
  install -dm755 "$pkgdir"/usr/lib$LIBDIRSUFFIX
  cp -a "$srcdir"/fakeinstall/lib/*.a "$pkgdir"/usr/lib$LIBDIRSUFFIX/
  cp -a "$srcdir"/fakeinstall/lib/cmake "$pkgdir"/usr/lib$LIBDIRSUFFIX/
  cp -a "$srcdir"/fakeinstall/{bin,include,share} "$pkgdir"/usr/

# boost-libs
  cp -a "$srcdir"/fakeinstall/lib/*.so* "$pkgdir"/usr/lib$LIBDIRSUFFIX/

# https://github.com/boostorg/mpi/issues/112
  install -d "$pkgdir"/usr/lib/python3.9/site-packages/boost
  touch "$pkgdir"/usr/lib/python3.9/site-packages/boost/__init__.py
  python -m compileall -o 0 -o 1 -o 2 "$pkgdir"/usr/lib/python3.9/site-packages/boost
  cp "$srcdir"/fakeinstall/lib/boost-python3.9/mpi.so \
    "$pkgdir"/usr/lib/python3.9/site-packages/boost/mpi.so

# https://github.com/boostorg/python/issues/203#issuecomment-391477685
  for _lib in python numpy; do
    ln -srL "$pkgdir"/usr/lib/libboost_${_lib}3{9,}.so
  done

  install -Dm644 -t "$pkgdir/usr/share/licenses/$pkgname" $_srcname/LICENSE_1_0.txt
}
