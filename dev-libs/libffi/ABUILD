pkgname=libffi
pkgver=3.4.2
pkgbuild=1
arch=("auto")

shortdesc=("A Portable Foreign Function Interface Library")
longdesc=("The libffi library provides a portable, high level programming interface to various calling conventions. This allows a programmer to call any function specified by a call interface description at run time.")

tags=("dev-libs libs")

source=("https://github.com/libffi/libffi/releases/download/v${pkgver}/libffi-${pkgver}.tar.gz"
"https://github.com/libffi/libffi/releases/download/v3.3/libffi-3.3.tar.gz")

build_deps="make gcc glibc binutils coreutils sed grep"

# TODO: remove this block once the libffi 3.4 rebuilds are bootstrapped
# glib2 gobject-introspection gtk3 guile2 llvm-libs p11-kit python python-gobject wayland xorg-server

before_build(){
  cd ${srcdir}/libffi-3.3
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --disable-static \
    --enable-pax_emutramp
  make -j${numjobs}
  make DESTDIR=${srcdir}/TEMPs install
}

build() {
  cd ${srcdir}/libffi-${pkgver}
  autoreconf -fiv
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --disable-static \
    --enable-pax_emutramp \
    --disable-multi-os-directory \
    --disable-exec-static-tramp # remove --disable-exec-static-tramp once ghc and gobject-introspection work fine with it enabled (https://github.com/libffi/libffi/pull/647)
  make -j${numjobs}
  make DESTDIR=${pkgdir} install
  install -Dm 644 LICENSE -t ${pkgdir}/usr/share/licenses/$pkgname
  install -Dm 644 README.md -t ${pkgdir}/usr/share/doc/$pkgname
}

# TODO: remove this block once the libffi 3.4 rebuilds are bootstrapped
# glib2 gobject-introspection gtk3 guile2 llvm-libs p11-kit python python-gobject wayland xorg-server
after_build(){
  install -Dt ${pkgdir}/usr/lib${LIBDIRSUFFIX} ${srcdir}/TEMPs/usr/lib${LIBDIRSUFFIX}/libffi.so.7
}
