pkgname=openssl-1.1
pkgver=1.1.1t
pkgbuild=1
arch=("auto")

shortdesc=("The Open Source toolkit for Secure Sockets Layer and Transport Layer Security.")

source=("http://www.openssl.org/source/openssl-${pkgver}.tar.gz")

tags=("dev-libs libs")

build_deps=("perl")

build() {
  go_src_dir
  burn_patches
  ./Configure \
    --prefix=/usr \
    --openssldir=/etc/ssl \
    --libdir=lib/openssl-1.1 \
    shared no-ssl3-method enable-ec_nistp_64_gcc_128 linux-x86_64 "-Wa,--noexecstack ${CPPFLAGS} ${CFLAGS} ${LDFLAGS}"
  make depend
  make -j${numjobs}
  make DESTDIR=${pkgdir} install_sw

# Перемещаем конфликтующие файлы
  install -m755 -d ${pkgdir}/usr/include/openssl-1.1
  mv ${pkgdir}/usr/include/openssl ${pkgdir}/usr/include/openssl-1.1/
  mv ${pkgdir}/usr/lib/openssl-1.1/libcrypto.so.1.1 ${pkgdir}/usr/lib/
  mv ${pkgdir}/usr/lib/openssl-1.1/libssl.so.1.1 ${pkgdir}/usr/lib/
  ln -sf ../libssl.so.1.1 ${pkgdir}/usr/lib/openssl-1.1/libssl.so
  ln -sf ../libcrypto.so.1.1 ${pkgdir}/usr/lib/openssl-1.1/libcrypto.so
  mv ${pkgdir}/usr/bin/openssl ${pkgdir}/usr/bin/openssl-1.1

  sed -e 's|/include$|/include/openssl-1.1|' -i ${pkgdir}/usr/lib/openssl-1.1/pkgconfig/*.pc

  rm -rf ${pkgdir}/{etc,usr/bin/c_rehash}

  install -D -m644 LICENSE ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE
}
