pkgname=apcupsd
pkgver=3.14.14
pkgbuild=1
arch=("auto")

shortdesc=("Power mangement and controlling most of APC's UPS models.")
longdesc=("APC UPS daemon with integrated tcp/ip remote shutdown.")

source=("https://downloads.sourceforge.net/apcupsd/${pkgname}-${pkgver}.tar.gz")

tags=("sys-power utils")

build_deps=("gcc-libs libusb-compat gd")

config_files=("etc/apcupsd/apcupsd.conf
etc/apcupsd/hosts.conf
etc/apcupsd/multimon.conf
etc/apcupsd/apcupsd.css
etc/apcupsd/changeme
etc/apcupsd/commfailure
etc/apcupsd/commok
etc/apcupsd/offbattery
etc/apcupsd/onbattery
etc/apcupsd/apccontrol")

build() {
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --sbindir=/usr/bin \
    --enable-cgi \
    --enable-usb \
    --enable-net \
    --with-upstype=usb \
    --with-upscable=usb \
    --with-serial-dev=/dev/usb/hid/hiddev[0-9] \
    --disable-gapcmon \
    --enable-modbus-usb \
    --sysconfdir=/etc/apcupsd \
    --with-pwrfail-dir=/etc/apcupsd \
    --with-lock-dir=/run/apcupsd \
    --with-pid-dir=/run/apcupsd \
    --with-log-dir=/var/log \
    --with-nis-port=3551 \
    --enable-net \
    --enable-pcnet
  make -j${numjobs}
  make DESTDIR=${pkgdir} install

  sed -i 's#^LOCKFILE .*$#LOCKFILE /run/apcupsd#' ${pkgdir}/etc/apcupsd/apcupsd.conf

  install -Dm644 ${filedir}/apcupsd-tmpfiles.conf ${pkgdir}/usr/lib/tmpfiles.d/apcupsd.conf

  chmod 755 ${pkgdir}/usr/bin/*
  mv ${pkgdir}/usr/bin/smtp{,-$pkgname}

  install -dm755 ${pkgdir}/usr/lib/${pkgname}/cgi-bin
  mv ${pkgdir}/etc/apcupsd/*.cgi ${pkgdir}/usr/lib/${pkgname}/cgi-bin
  rm -rf ${pkgdir}/usr/share/hal

  install -Dm755 ${filedir}/apcupsd ${pkgdir}/etc/init.d/apcupsd
  install -Dm755 ${filedir}/apcupsd.powerfail ${pkgdir}/etc/init.d/apcupsd.powerfail
  install -Dm644 ${filedir}/apcupsd.conf ${pkgdir}/etc/apcupsd
  install -Dm644 ${filedir}/apcupsd-udev.rules \
	  ${pkgdir}/etc/udev/rules.d/60-${pkgname}.rules
  rm -rf ${pkgdir}/etc/rc.d ${pkgdir}/usr/share/hal
}
