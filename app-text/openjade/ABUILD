# ABUILD generated by mkpkg_generator.sh

pkgname=openjade
pkgver=1.3.3_pre1
pkgbuild=3
arch=("auto")

shortdesc=("James Clark's implementation of DSSSL engine")

tags=("app-text develop")

source=("http://sourceforge.net/projects/openjade/files/openjade/1.3.3/openjade-${pkgver/_/-}.tar.gz")

build_deps="perl opensp glibc-solibs gcc-libs gcc-g++"

adddep="sgml-common"

build() {
	go_src_dir
	burn_patches
	# Apply patches:
	sed -i "s/iostream.h/iostream/g" style/MultiLineInlineNote.cxx

	# Install the old Perl 4 'getopts' function.  This has been deprecated in Perl 5.16
	# and since it seems that OpenJade isn't being actively released by upstream, we'll
	# work around by supplying it to OpenJade directly.  It's only a build-time fix anyway
	# so it's ok to have a dirty work-around:
	xz -dc ${filedir}/openjade-1.3-getopts.pl.xz > getopts.pl

	# Configure without optimisation.
	# OpenSP & OpenJade are sensitive to optimisations and can result
	# in segfaults with anything other than O2 - particularly on the ARM
	# platform.
	export CFLAGS=""
	export CXXFLAGS=""
	./configure \
		--prefix=/usr \
		--libdir=/usr/lib${LIBDIRSUFFIX} \
		--enable-splibdir=/usr/lib${LIBDIRSUFFIX} \
		--disable-static \
		--mandir=/usr/man \
		--infodir=/usr/info \
		--disable-static \
		--enable-http \
		--enable-default-catalog=/etc/sgml/catalog \
		--enable-default-search-path=/usr/share/sgml \
		--datadir=/usr/share/sgml/openjade-${pkgver}

	# Build (setting the perl library to be the PWD so it finds the old 'getopts.pl'):
	make PERL5LIB=$(pwd) -j${numjobs}

	# Install:
	mkdir -p ${pkgdir}/etc/sgml
	make install DESTDIR=${pkgdir}
	make install-man DESTDIR=${pkgdir}
	( cd ${pkgdir}/usr/bin && ln -vfs openjade jade )
	( cd ${pkgdir}/usr/man/man1 && ln -vfs openjade.1 jade.1 )
	ln -vsf libogrove.so ${pkgdir}/usr/lib${LIBDIRSUFFIX}/libgrove.so
	ln -vsf libospgrove.so ${pkgdir}/usr/lib${LIBDIRSUFFIX}/libspgrove.so
	ln -vsf libostyle.so ${pkgdir}/usr/lib${LIBDIRSUFFIX}/libstyle.so
	install -vpm644 dsssl/catalog ${pkgdir}/usr/share/sgml/openjade-${pkgver}
	install -vpm644 dsssl/*.{dtd,dsl,sgm} ${pkgdir}/usr/share/sgml/openjade-${pkgver}

}

