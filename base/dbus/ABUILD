pkgname=dbus
pkgver=1.12.20
pkgbuild=2
arch=('auto')

shortdesc="D-Bus message bus"
longdesc="D-Bus is a system for sending messages between applications. It is used both for the systemwide message bus service, and as a per-user-login-session messaging facility."

tags=('base sys-apps')

build_deps="make gcc expat coreutils kernel-headers grep binutils sed python"

source=("http://dbus.freedesktop.org/releases/dbus/dbus-${pkgver}.tar.gz")

config_files="etc/dbus-1/system.conf
etc/dbus-1/session.conf"

build() {
  go_src_dir
  burn_patches
  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib${LIBDIRSUFFIX} \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --enable-shared=yes \
    --enable-static=no \
    --with-system-pid-file=/var/run/dbus/dbus.pid \
    --with-system-socket=/var/run/dbus/system_bus_socket \
    --with-console-auth-dir=/var/run/console \
    --with-init-scripts=openrc
  make -j${numjobs}
  make DESTDIR=${pkgdir} install
}

after_build() {
  go_src_dir

  # Fix some directory ownership
  chown messagebus ${pkgdir}/var/lib/dbus

  # Add OpenRC scripts
  mkdir -p ${pkgdir}/etc/init.d
  install -m755 $filedir/dbus.init ${pkgdir}/etc/init.d/dbus

  # Add socket dir. DBus cannot do it and keep silent about
  mkdir -p ${pkgdir}/var/run/dbus
}
