pkgname=util-linux-ng
pkgver=2.37.2
pkgbuild=1
arch=("auto")

shortdesc=("A collection of basic system utilities")
longdesc=("The util-linux package contains a large variety of low-level system utilities that are necessary for a Linux system to function. Among others, Util-linux-ng contains the fdisk configuration tool and the login program.")

tags=('base sys-apps')

source=("https://mirrors.edge.kernel.org/pub/linux/utils/util-linux/v2.37/util-linux-${pkgver}.tar.xz")
conflicts="eject"

config_files="etc/pam.d/chfn
etc/pam.d/chsh
etc/pam.d/login
etc/pam.d/runuser
etc/pam.d/runuser-l
etc/pam.d/su
etc/pam.d/su-l"

build_deps="eudev linux-pam acl shadow coreutils asciidoctor"

build() {
  go_src_dir
  ./configure \
  --prefix=/usr \
  --bindir=/bin \
  --sbindir=/sbin \
  --libdir=/lib${LIBDIRSUFFIX} \
  --sysconfdir=/etc \
  --localstatedir=/var \
  --enable-fs-paths-default=/usr/bin:/usr/local/bin \
  --enable-usrdir-path \
  --enable-vipw \
  --enable-newgrp \
  --enable-chfn-chsh \
  --enable-write \
  --enable-mesg \
  --disable-raw \
  --disable-static \
  --disable-hardlink \
  --with-python=3

  make -j${numjobs}
  make DESTDIR=${pkgdir} install
}

after_build() {
  # Moving things around that have been in the same place
  # for 15 years is, IMHO, not a wise idea AT ALL.
  # If this had to be moved, some place out of /usr might
  # have shown a grain of insight...
  if [ -r ${pkgdir}/sbin/fdformat ]; then
    mkdir -p ${pkgdir}/bin
    mv ${pkgdir}/sbin/fdformat ${pkgdir}/bin/fdformat
    # Now since stuff will start looking in this new place,
    # we have no choice but to link these:
    ( cd ${pkgdir}/sbin
      ln -sf ../bin/fdformat .
    )
  fi

  # setuid chfn and chsh
  chmod 4755 "$pkgdir"/usr/bin/{newgrp,ch{sh,fn}}

  # Now let's add some important symlinks :)
  ( cd ${pkgdir}/sbin
    ln -s ../bin/mount .
    ln -s ../bin/umount .
    ln -s hwclock clock
    cd ${pkgdir}/bin
    ln -s ../sbin/readprofile .
    ln -s ../sbin/tunelp .
    ln -s ../sbin/raw .
    cd ${pkgdir}/usr/share/man/man8
    ln -s hwclock.8 clock.8
  )

  # install PAM files for login-utils
  install -Dm0644 "${filedir}/pam.d/chfn" "${pkgdir}/etc/pam.d/chfn"
  install -m0644 "${filedir}/pam.d/chsh" "${pkgdir}/etc/pam.d/chsh"
  install -m0644 "${filedir}/pam.d/login" "${pkgdir}/etc/pam.d/login"
  install -m0644 "${filedir}/pam.d/runuser" "${pkgdir}/etc/pam.d/runuser"
  install -m0644 "${filedir}/pam.d/runuser-l" "${pkgdir}/etc/pam.d/runuser-l"
  install -m0644 "${filedir}/pam.d/su" "${pkgdir}/etc/pam.d/su"
  install -m0644 "${filedir}/pam.d/su-l" "${pkgdir}/etc/pam.d/su-l"

  install -Dm0644 "${filedir}/udev/60-rfkill.rules" "${pkgdir}/lib/udev/rules.d/60-rfkill.rules"
}
