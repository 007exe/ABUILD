# ABUILD generated by mkpkg_generator.sh

pkgname=kbd
pkgver=2.3.0
pkgbuild=1
arch=("auto")

shortdesc=("kbd (keyboard maps and console fonts)")
longdesc=("Load and save keyboard mappings. Needed if you are not using the US keyboard map. This package also contains utilities to change your console fonts - if you install it you'll get a menu later on that lets you select from many different fonts. If you like one, you can make it your default font. A new default font can be chosen at any time by typing 'setconsolefont'.")

tags=("base sys-apps")
build_deps="glibc"

source=("https://git.kernel.org/pub/scm/linux/kernel/git/legion/kbd.git/snapshot/kbd-${pkgver}.tar.gz")

before_build() {
	go_src_dir
  # rename keymap files with the same names
  # this is needed because when only name of keymap is specified
  # loadkeys loads the first keymap it can find, which is bad (see FS#13837)
  # this should be removed when upstream adopts the change
  mv data/keymaps/i386/qwertz/cz{,-qwertz}.map
  mv data/keymaps/i386/olpc/es{,-olpc}.map
  mv data/keymaps/i386/olpc/pt{,-olpc}.map
  mv data/keymaps/i386/fgGIod/trf{,-fgGIod}.map
  mv data/keymaps/i386/colemak/{en-latin9,colemak}.map
  patch -Np1 -i ${filedir}/fix-euro2.patch
  autoreconf -if
}

build() {
	go_src_dir
	burn_patches

	./configure --prefix=/usr \
		--datadir=/usr/share/kbd \
		--libdir=/usr/lib$LIBDIRSUFFIX \
		--mandir=/usr/share/man \
		--docdir=/usr/share/doc/$pkgname-$pkgver \
		--datadir=/usr/share/kbd --enable-nls


	make -j${numjobs}
	make KEYCODES_PROGS=yes RESIZECONS_PROGS=yes

	# Install into package:
	make install DESTDIR=${pkgdir}
}

after_build() {
	go_src_dir
	make KEYCODES_PROGS=yes RESIZECONS_PROGS=yes DESTDIR="${pkgdir}" install

	install -Dm644 ${filedir}/vlock.pam "${pkgdir}"/etc/pam.d/vlock
}
