# ABUILD generated by mkpkg_generator.sh

pkgname=shadow
pkgver=4.8.1
pkgbuild=1
arch=("auto")

shortdesc=("Password and account management tool suite with support for shadow files and PAM")
longdesc=("This set of login related programs utilizes an alternate, non-readable file to contain the actual encrypted passwords. This is presumed to increase system security by increasing the difficulty with which system crackers obtain encrypted passwords. It was written by Julianne Frances Haugh and the Linux port is maintained by Tomasz Kloczko. This package provides 'login', which is needed to log into the system.")

tags=("base sys-auth")

build_deps="make gcc binutils grep sed coreutils linux-pam acl libaudit automake autoconf gettext"

source=("https://github.com/shadow-maint/shadow/releases/download/${pkgver}/shadow-${pkgver}.tar.xz")

config_files="etc/pam.d/chage
etc/pam.d/passwd
etc/pam.d/shadow
etc/pam.d/useradd
etc/pam.d/usermod
etc/pam.d/userdel
etc/pam.d/chpasswd
etc/pam.d/newusers
etc/pam.d/groupadd
etc/pam.d/groupdel
etc/pam.d/groupmod
etc/pam.d/chgpasswd
etc/pam.d/groupmems
etc/default/useradd"

build() {
  go_src_dir
  burn_patches

  autoreconf -fsiv
  ./configure --prefix=/usr \
              --bindir=/usr/bin \
              --sbindir=/usr/bin \
              --libdir=/lib${LIBDIRSUFFIX} \
              --docdir=/usr/share/doc/${pkgname}-${pkgver} \
              --mandir=/usr/share/man \
              --sysconfdir=/etc \
              --disable-shared \
              --disable-account-tools-setuid \
	      --enable-static \
              --with-libpam \
              --without-selinux \
              --without-tcb \
              --with-audit \
              --with-group-name-max-length=32

  make
  make install DESTDIR=${pkgdir}


# Remove utilities provided by util-linux
rm \
"$pkgdir"/usr/bin/{login,su,sg,nologin} \

  # remove the existing files in util-linux-ng
  for file in chfn chsh newgrp; do
      rm -v "${pkgdir}/usr/bin/"${file}
      find "${pkgdir}/usr/share/man" -name "$file.1" -exec rm -v {} \;
  done

  for file in vigr vipw; do
      rm -v "${pkgdir}/usr/sbin/"${file}
      find "${pkgdir}/usr/share/man" -name "$file.8" -exec rm -v {} \;
  done


  # Our custom adduser script - http://people.salixos.org/djemos/shadow/adduser
  install -D -m755 ${filedir}/adduser ${pkgdir}/usr/sbin/
  install -D -m644 ${filedir}/adduser_ru.mo ${pkgdir}/usr/share/locale/ru/LC_MESSAGES/adduser.mo
  install -D -m644 ${filedir}/adduser_uk.mo ${pkgdir}/usr/share/locale/uk/LC_MESSAGES/adduser.mo

  # PAM config - custom
  rm "$pkgdir/etc/pam.d"/*

  # Add pam.d configs
  for i in ${filedir}/pam.d/* ; do
      install -D -m0644 ${i} ${pkgdir}/etc/pam.d/`basename ${i}`
  done

  # Other stuff
  # useradd defaults
  install -Dm644 "${filedir}/useradd.defaults" "${pkgdir}/etc/default/useradd"

  # cron job
  install -Dm744 "${filedir}/shadow.cron.daily" "${pkgdir}/etc/cron.daily/shadow"

  # login.defs
  install -Dm644 "${filedir}/login.defs" "${pkgdir}/etc/login.defs"

  # Remove static libs, since they are internal-only
  rm -f ${pkgdir}/{,usr}/lib${LIBDIRSUFFIX}/lib{misc,shadow}.{a,la}

 # ...and their many man pages
  find "$pkgdir"/usr/share/man \
      '(' -name 'chsh.1'    -o \
          -name 'chfn.1'    -o \
          -name 'su.1'      -o \
          -name 'logoutd.8' -o \
          -name 'login.1'   -o \
          -name 'nologin.8' -o \
          -name 'vipw.8'    -o \
          -name 'vigr.8'    -o \
          -name 'newgrp.1' ')' \
      -delete
  rmdir \
      "$pkgdir"/usr/share/man/{fi,id,zh_TW}/man1 \
      "$pkgdir"/usr/share/man/{fi,ko/man8}

}
