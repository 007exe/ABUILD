# ABUILD generated by mkpkg_generator.sh

pkgname=e2fsprogs
pkgver=1.45.6
pkgbuild=1
arch=("auto")

shortdesc=('e2fsprogs (ext2/3/4 filesystems utilities)')
longdesc=('Utilities needed to create and maintain ext2/3/4filesystems. These utilities were written by Remy Card (the developer and maintainer of the ext2 fs) and Theodore Tso.')

tags="base sys-fs"

source=("https://www.kernel.org/pub/linux/kernel/people/tytso/${pkgname}/v${pkgver}/${pkgname}-${pkgver}.tar.gz")

BUILD_SYSTEM='autotools'
BUILD_KEYS="--prefix= \
--libdir=/lib${LIBDIRSUFFIX} \
--bindir=/usr/bin \
--includedir=/usr/include \
--datadir=/usr/share \
--mandir=/usr/share/man \
--infodir=/usr/info \
--docdir=/usr/share/doc/e2fsprogs-${pkgver} \
--enable-elf-shlibs \
--disable-fsck \
--disable-libblkid \
--disable-libuuid \
--disable-uuidd"

INSTALL_KEYS="DESTDIR=$pkgdir"

build_deps="bc util-linux-ng pkg-config"

after_build() {
	go_src_dir
	make install-libs DESTDIR=${pkgdir} || exit 1
	mkdir -p ${pkgdir}/usr/lib${LIBDIRSUFFIX}
	mv ${pkgdir}/lib${LIBDIRSUFFIX}/pkgconfig ${pkgdir}/lib${LIBDIRSUFFIX}/*.so \
		${pkgdir}/usr/lib${LIBDIRSUFFIX}
	( cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
		for i in *.so ; do 
			ln -sf /lib${LIBDIRSUFFIX}/$(readlink $i) $i ; 
		done
	)
	
	( cd ${pkgdir}/sbin
		rm -f mkfs.ext2 mkfs.ext3 mkfs.ext4 mkfs.ext4dev \
		      fsck.ext2 fsck.ext3 fsck.ext4dev e2label
		ln -sf mke2fs mkfs.ext2
		ln -sf mke2fs mkfs.ext3
		ln -sf mke2fs mkfs.ext4
		ln -sf mke2fs mkfs.ext4dev
		ln -sf tune2fs e2label
		cat << EOF > fsck.ext2
#!/bin/sh
exec /sbin/e2fsck -C 0 \$*
EOF

		chmod 0755 fsck.ext2
		# Why won't symlinks work here?  --RW
		# Because $0 will always be "fsck.ext2" in that case.  --PJV
		cp -a fsck.ext2 fsck.ext3
		cp -a fsck.ext2 fsck.ext4
		cp -a fsck.ext2 fsck.ext4dev
	)

	( cd ${pkgdir}/usr/man/man8
		rm -f fsck.ext2.8 fsck.ext3.8 mkfs.ext2.8 mkfs.ext3.8 \
			mkfs.ext4.8 mkfs.ext4dev.8
		ln -sf e2fsck.8 fsck.ext2.8
		ln -sf e2fsck.8 fsck.ext3.8
		ln -sf e2fsck.8 fsck.ext4.8
		ln -sf e2fsck.8 fsck.ext4dev.8
		ln -sf mke2fs.8 mkfs.ext2.8
		ln -sf mke2fs.8 mkfs.ext3.8
		ln -sf mke2fs.8 mkfs.ext4.8
		ln -sf mke2fs.8 mkfs.ext4dev.8
	)
}

