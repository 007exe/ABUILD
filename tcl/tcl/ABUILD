# ABUILD generated by mkpkg_generator.sh

pkgname=tcl
pkgver=8.6.10
pkgbuild=1
arch=("auto")

shortdesc=("tcl (Tool Command Language)")
longdesc=("Tcl, developed by Dr. John Ousterhout, is a simple to use text-based script language with many built-in features which make it especially nice for writing interactive scripts.")
tags=("dev-lang tcl compat32")
source=("http://downloads.sourceforge.net/sourceforge/tcl/tcl${pkgver}-src.tar.gz")
build_deps="glibc-solibs"


before_build() {
  go_src_dir
  # we build the tcl sqlite interface in sqlite-tcl package
  rm -rf pkgs/sqlite3*
}


build() {
  go_src_dir
  cd unix

  BIT=""
  if [ "$ARCH" == "x86_64" ]; then
    BIT="--enable-64bit"
  fi

  # Fix hardcoded lib location
  sed -i "/TCL_LIBRARY='\$(prefix)/ s/lib/lib$LIBDIRSUFFIX/" ./configure

  ./configure --prefix=/usr --mandir=/usr/share/man --libdir=/usr/lib$LIBDIRSUFFIX --enable-threads $BIT
  make -j${numjobs}
  make test
}


after_build() {
  go_src_dir
  cd unix

  make INSTALL_ROOT="${pkgdir}" install install-private-headers

  ln -sf tclsh${pkgver%.*} "${pkgdir}/usr/bin/tclsh"
  ln -sf libtcl${pkgver%.*}.so "${pkgdir}/usr/lib$LIBDIRSUFFIX/libtcl.so"
  install -Dm644 ../license.terms "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  install -Dm644 tcl.m4 -t "$pkgdir"/usr/share/aclocal

 # remove buildroot traces
  sed -e "s#${srcdir}/tcl${pkgver}/unix#/usr/lib$LIBDIRSUFFIX#" \
      -e "s#${srcdir}/tcl${pkgver}#/usr/include#" \
      -i "${pkgdir}/usr/lib$LIBDIRSUFFIX/tclConfig.sh"

tdbcver=tdbc1.1.1
  sed -e "s#${srcdir}/tcl${pkgver}/unix/pkgs/$tdbcver#/usr/lib$LIBDIRSUFFIX/$tdbcver#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$tdbcver/generic#/usr/include#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$tdbcver/library#/usr/lib$LIBDIRSUFFIX/tcl${pkgver%.*}#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$tdbcver#/usr/include#" \
      -i "${pkgdir}/usr/lib$LIBDIRSUFFIX/$tdbcver/tdbcConfig.sh"

  itclver=itcl4.2.0
  sed -e "s#${srcdir}/tcl${pkgver}/unix/pkgs/$itclver#/usr/lib$LIBDIRSUFFIX/$itclver#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$itclver/generic#/usr/include#" \
      -e "s#${srcdir}/tcl${pkgver}/pkgs/$itclver#/usr/include#" \
      -i "${pkgdir}/usr/lib$LIBDIRSUFFIX/$itclver/itclConfig.sh"
}
