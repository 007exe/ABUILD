# ABUILD generated by mkpkg_generator.sh

pkgname=exim
pkgver=4.77
pkgbuild=1
arch=("auto")

shortdesc=("Mail Transer Agent")
longdesc=("")

tags=("server mail-mta")

source=("http://mirror.switch.ch/ftp/mirror/exim/exim/exim4/exim-$pkgver.tar.bz2")

conflicts="sendmail"

config_files="etc/mail/aliases
etc/mail/exim.conf
etc/logrotate.d/exim
etc/conf.d/exim"

build() {
	go_src_dir
	burn_patches
	set -e
	cp ${filedir}/exim.Makefile Local/Makefile
	make # Note: paralllel make does not work.

	install -Dm644 ${filedir}/exim.logrotate ${pkgdir}/etc/logrotate.d/exim
	install -Dm644 ${filedir}/exim.conf.d ${pkgdir}/etc/conf.d/exim
	install -Dm644 doc/exim.8 ${pkgdir}/usr/man/man8/exim.8
	install -Dm755 ${filedir}/exim.init.d ${pkgdir}/etc/init.d/exim
	mkdir -p ${pkgdir}/var/spool/exim/db ${pkgdir}/etc/mail \
		${pkgdir}/var/log/exim ${pkgdir}/usr/{lib${LIBDIRSUFFIX},sbin}
	chmod 770 ${pkgdir}/var/spool/exim ${pkgdir}/var/spool/exim/db ${pkgdir}/var/log/exim
	( cd build-Linux-*
		for i in exicyclog exim_checkaccess exim_dumpdb exim_lock exim_tidydb exipick exiqsumm exigrep exim_dbmbuild exim exim_fixdb eximstats exinext exiqgrep exiwhat ; do
			install -m 0755 "$i" "$pkgdir/usr/sbin"
		done
	)

	( cd "src"
		sed -e "s|/etc/aliases|/etc/mail/aliases|g" \
			-e "s|SYSTEM_ALIASES_FILE|/etc/mail/aliases|g" configure.default \
			>"$pkgdir/etc/mail/exim.conf"
	)

	cp "$filedir/aliases" "$pkgdir/etc/mail"
	( cd "$pkgdir/usr/sbin"
		for i in mailq rmail rsmtp runq sendmail; do
			ln -s exim "$i"
		done
		# fhs compliancy
		ln -s ../sbin/exim ../lib${LIBDIRSUFFIX}/sendmail
	)

	set +e
}
